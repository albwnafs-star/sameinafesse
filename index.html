<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³ - Ø¹Ø§Ù„Ù… ØªØ¹Ù„ÙŠÙ…ÙŠ ØªÙØ§Ø¹Ù„ÙŠ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <script>
    window.MathJax = {
      loader: {load: ['[tex]/mhchem']},
      tex: {packages: {'[+]': ['mhchem']}}
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
      50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); }
    }
    
    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    .pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .slide-in {
      animation: slide-in 0.5s ease-out;
    }
    
    .island-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .island-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .skill-button {
      transition: all 0.3s ease;
    }
    
    .skill-button:hover:not(:disabled) {
      transform: scale(1.05);
    }
    
    .star-icon {
      filter: drop-shadow(0 0 3px rgba(251, 191, 36, 0.8));
    }
    
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      animation: slide-in 0.3s ease-out;
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsible-content.open {
      max-height: 2000px;
    }
    
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
      flex-direction: column;
      gap: 16px;
    }
    
    #questionDisplay {
      border: 2px dashed #3498db;
      padding: 15px;
      border-radius: 10px;
      background: #fafafa;
      min-height: 80px;
      font-size: 18px;
      font-family: 'Tajawal', sans-serif;
      text-align: right;
      direction: rtl;
      color: #333;
      unicode-bidi: isolate; /* Ø¹Ø²Ù„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ */
    }
    
    /* Ø¹ÙƒØ³ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¬Ø°Ø± Ø§Ù„ØªØ±Ø¨ÙŠØ¹ÙŠ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
    mjx-sqrt {
      transform: scaleX(-1);
    }
    mjx-sqrt mjx-box {
      transform: scaleX(-1);
    }
    
    .video-wrapper {
        max-width: 800px;
        margin: 20px auto;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .video-container {
        position: relative;
        padding-bottom: 56.25%; /* Ù†Ø³Ø¨Ø© 16:9 */
        height: 0;
        background: #000;
    }

    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }

    .playlist-info {
        padding: 15px 20px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        text-align: center;
    }

    .playlist-info p {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
    }

    .playlist-link {
        display: inline-block;
        background: #ff0000;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 14px;
        transition: background 0.3s;
    }

    .playlist-link:hover {
        background: #cc0000;
        text-decoration: none;
    }

    .error {
        color: #dc3545;
        text-align: center;
        padding: 20px;
        background: #f8d7da;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
    }
    
    .castle-item {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .video-preview {
      position: relative;
      cursor: pointer;
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 16/9;
    }
    .video-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .play-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.6);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      transition: background 0.3s;
    }
    .video-preview:hover .play-overlay {
      background: rgba(255,0,0,0.8);
    }
    #video-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #player-modal {
      width: 90%;
      max-width: 900px;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      .toast {
        width: 90% !important;
        font-size: 14px !important;
        padding: 12px !important;
      }
      
      #questionDisplay {
        font-size: 18px !important;
        padding: 10px !important;
        overflow-x: auto;
      }

      .video-wrapper, #player-modal {
        width: 100% !important;
        border-radius: 0 !important;
      }
    }
  </style>
</head>
<body class="h-full w-full overflow-auto">
  <div id="app" class="h-full w-full"></div>
  <div id="toast-container"></div>
  <div id="global-loader" class="loader-overlay">
    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    <div class="text-white font-bold text-xl">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ÙÙŠ -->
  <div id="certificate-hidden" style="position: fixed; left: -9999px; top: 0; width: 800px; height: 600px; background: #fff; padding: 40px; text-align: center; border: 10px solid #3b82f6; direction: rtl; font-family: 'Cairo', sans-serif; z-index: -1;">
    <div style="border: 2px solid #e2e8f0; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(to bottom right, #ffffff, #f0f9ff);">
      <h1 style="font-size: 48px; color: #1e293b; margin-bottom: 20px; font-weight: 800;">Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</h1>
      <p style="font-size: 24px; color: #64748b; margin-bottom: 10px;">ØªØ´Ù‡Ø¯ Ù…Ù†ØµØ© Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³ Ø¨Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©</p>
      <h2 id="cert-student-name" style="font-size: 40px; color: #3b82f6; margin-bottom: 20px; font-weight: bold;"></h2>
      <p style="font-size: 24px; color: #64748b; margin-bottom: 10px;">Ù‚Ø¯ Ø£ØªÙ… Ø¨Ù†Ø¬Ø§Ø­</p>
      <h3 id="cert-level-name" style="font-size: 32px; color: #1e293b; margin-bottom: 30px;"></h3>
      <div style="display: flex; gap: 60px; margin-bottom: 40px;">
        <div style="text-align: center;">
          <div style="font-size: 18px; color: #64748b;">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
          <div id="cert-percentage" style="font-size: 32px; color: #10b981; font-weight: bold;"></div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; color: #64748b;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
          <div id="cert-correct" style="font-size: 32px; color: #3b82f6; font-weight: bold;"></div>
        </div>
      </div>
      <p style="font-size: 20px; color: #94a3b8;">Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ù…Ø²ÙŠØ¯Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙÙˆÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­ ğŸŒŸ</p>
      <div style="margin-top: 40px; font-size: 16px; color: #cbd5e1;" id="cert-date"></div>
    </div>
  </div>
  
  <div id="reading-modal"
    style="display:none;"
    class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">

    <div class="bg-slate-900 text-white rounded-2xl p-6 max-w-3xl w-full mx-4 relative border-2 border-blue-500 shadow-2xl">
      
      <button onclick="closeReadingModal()"
        class="absolute top-4 left-4 text-xl font-bold hover:text-red-400 transition-colors">
        âœ–
      </button>

      <h2 id="modal-reading-title" class="text-2xl font-bold mb-4 text-center text-blue-400"></h2>
      <div id="modal-reading-text" class="leading-loose text-lg max-h-[60vh] overflow-y-auto p-2"></div>

    </div>
  </div>
  
  <div id="video-modal">
    <div class="w-full max-w-4xl flex justify-end mb-4 px-4">
      <button onclick="closeVideoModal()" class="text-white text-3xl font-bold hover:text-red-500 transition-colors">âœ•</button>
    </div>
    <div id="player-modal"></div>
  </div>

  <div id="image-zoom-modal" style="display:none;" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[10001] cursor-zoom-out" onclick="closeImageZoom()">
    <img id="zoomed-image" src="" class="max-w-[95%] max-h-[95%] object-contain rounded-lg shadow-2xl transition-transform duration-300">
    <button onclick="closeImageZoom()" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-300 z-[10002]">&times;</button>
  </div>

  <audio id="warning-sound" preload="auto">
    <source src="data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
  </audio>
  <audio id="correct-sound" preload="auto">
    <source src="data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
  </audio>
  <audio id="wrong-sound" preload="auto">
    <source src="data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
  </audio>
  <audio id="click-sound" preload="auto">
    <source src="data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg">
  </audio>

  <script>
    window.onerror = function(msg, url, line, col, error) {
       if (msg.includes('ResizeObserver')) return;
       console.error("Global Error:", msg, "Line:", line, error);
    };

    const defaultConfig = {
      background_color: "#1e293b",
      card_surface_color: "#334155",
      text_color: "#f8fafc",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#8b5cf6",
      font_family: "Cairo",
      font_size: 16,
      game_title: "Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³",
      game_subtitle: "Ø§Ø³ØªÙƒØ´Ù Ø¹Ø§Ù„Ù… Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø«ÙŠØ±",
      guide_name: "Ù†ÙˆØ±",
      welcome_message: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø³ØªÙƒØ´Ù Ù†Ø§ÙØ³!"
    };

    function processYouTubeUrl(url) {
        const result = {
            videoId: null,
            playlistId: null,
            isPlaylist: false,
            embedUrl: null,
            thumbnail: null
        };
        
        if (!url) return result;

        try {
            const urlObj = new URL(url);
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ videoId
            result.videoId = urlObj.searchParams.get('v');
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ playlistId Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
            result.playlistId = urlObj.searchParams.get('list');
            result.isPlaylist = !!result.playlistId;
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· embed
            if (result.videoId) {
                result.embedUrl = `https://www.youtube.com/embed/${result.videoId}`;
                result.thumbnail = `https://img.youtube.com/vi/${result.videoId}/maxresdefault.jpg`;
                
                if (result.playlistId) {
                    result.embedUrl += `?list=${result.playlistId}`;
                }
            } else if (url.includes('youtu.be/')) {
                const shortId = url.split('youtu.be/')[1]?.split('?')[0];
                if (shortId && shortId.length === 11) {
                    result.videoId = shortId;
                    result.embedUrl = `https://www.youtube.com/embed/${shortId}`;
                    result.thumbnail = `https://img.youtube.com/vi/${shortId}/maxresdefault.jpg`;
                }
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·:', error);
        }
        
        return result;
    }

    function checkYouTubeEmbeddable(videoId, timeout = 3000) {
      return new Promise((resolve) => {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=0`;

        let settled = false;

        const timer = setTimeout(() => {
          if (!settled) {
            settled = true;
            resolve(false); // Ù„Ù… ÙŠØ³ØªØ¬Ø¨ â†’ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¶Ù…ÙŠÙ†
            iframe.remove();
          }
        }, timeout);

        iframe.onload = () => {
          if (!settled) {
            settled = true;
            clearTimeout(timer);
            resolve(true); // Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¶Ù…ÙŠÙ†
            iframe.remove();
          }
        };

        iframe.onerror = () => {
          if (!settled) {
            settled = true;
            clearTimeout(timer);
            resolve(false);
            iframe.remove();
          }
        };

        document.body.appendChild(iframe);
      });
    }

    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      // Fallback for insecure contexts
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    let currentUser = null;
    let currentScreen = 'login';
    let allData = [];
    let users = [];
    let questions = [];
    let teacherCodes = [];
    let readingTexts = [];
    let learningCastles = [];
    let editingQuestionId = null;
    let editingCastleId = null;
    let questionTimer = null;
    let timeLeft = 45;
    let currentQuestionIndex = 0;
    let studentProgressKey = null;
    let isMuted = false;
    let gameState = {
      selectedGrade: '',
      selectedSemester: '',
      currentIsland: 'semester1',
      unlockedCities: ['math'],
      currentIsland: 'semester3',
      unlockedCities: ['math_test', 'science_test', 'arabic_test'],
      completedSkills: [],
      currentQuestionIndex: 0,
      currentQuestions: [],
      correctAnswers: 0,
      selectedAnswer: null,
      currentCastle: '',
      currentUnit: '',
      selectedCity: '',
      selectedStudentId: '',
      challengeData: null, // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
      pendingQuestionsPromise: null // Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    };

    const islands = {
      semester1: {
        name: 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„',
        theme: 'ğŸ‚ Ø®Ø±ÙŠÙ Ø§Ù„Ù…Ø¹Ø±ÙØ©',
        color: '#f59e0b',
        cities: []
      },
      semester2: {
        name: 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ',
        theme: 'ğŸŒ¸ Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹',
        color: '#10b981',
        cities: []
      },
      semester3: {
        name: 'Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³',
        theme: 'ğŸš€ ØªØ­Ø¯ÙŠ Ù†Ø§ÙØ³',
        color: '#8b5cf6',
        cities: [
          { id: 'math_test', name: 'Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', emoji: 'ğŸ§®', locked: false },
          { id: 'science_test', name: 'Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…', emoji: 'ğŸ”¬', locked: false },
          { id: 'arabic_test', name: 'Ù…Ø¯ÙŠÙ†Ø© Ù„ØºØªÙŠ', emoji: 'ğŸ“š', locked: false }
        ]
      }
    };

    // Loader Functions
    function showLoader(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
      const loader = document.getElementById('global-loader');
      if (loader) {
        loader.querySelector('.text-white').textContent = message;
        loader.style.display = 'flex';
      }
    }

    function hideLoader() {
      const loader = document.getElementById('global-loader');
      if (loader) loader.style.display = 'none';
    }

    // Ù†Ø¸Ø§Ù… ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ
    class LocalStorageSDK {
      constructor() {
        this.storageKey = 'knowledgeJourneyData';
        this.init();
      }
      
      init() {
        const saved = localStorage.getItem(this.storageKey);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            users = data.users || [];
            questions = data.questions || [];
            teacherCodes = (data.teacherCodes || []).filter(c => c.code_id); // ØªØµÙÙŠØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©
            readingTexts = data.readingTexts || [];
            learningCastles = data.learningCastles || [];
            allData = [...users, ...questions, ...teacherCodes, ...readingTexts, ...learningCastles];
          } catch (e) {
            console.log('Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©');
          }
        }
        return Promise.resolve({ isOk: true });
      }
      
      create(item) {
        item.__backendId = generateUUID();
        item.created_at = new Date().toISOString();
        
        if (item.user_id) {
          users.push(item);
        } else if (item.question_id) {
          questions.push(item);
        } else if (item.code_id) {
          teacherCodes.push(item);
        } else if (item.reading_id) {
          readingTexts.push(item);
        } else if ('learning_outcome' in item) {
          learningCastles.push(item);
        }
        
        this.saveToStorage();
        return Promise.resolve({ isOk: true });
      }
      
      update(updatedItem) {
        let array;
        if (updatedItem.user_id) array = users;
        else if (updatedItem.question_id) array = questions;
        else if (updatedItem.code_id) array = teacherCodes;
        else if (updatedItem.reading_id) array = readingTexts;
        else if ('learning_outcome' in updatedItem) array = learningCastles;
        
        if (array) {
          const index = array.findIndex(item => item.__backendId === updatedItem.__backendId);
          if (index !== -1) {
            array[index] = { ...array[index], ...updatedItem };
            this.saveToStorage();
            return Promise.resolve({ isOk: true });
          }
        }
        return Promise.resolve({ isOk: false });
      }
      
      delete(itemToDelete) {
        let array;
        if (itemToDelete.user_id) array = users;
        else if (itemToDelete.question_id) array = questions;
        else if (itemToDelete.code_id) array = teacherCodes;
        else if (itemToDelete.reading_id) array = readingTexts;
        else if ('learning_outcome' in itemToDelete) array = learningCastles;
        
        if (array) {
          const index = array.findIndex(item => item.__backendId === itemToDelete.__backendId);
          if (index !== -1) {
            array.splice(index, 1);
            this.saveToStorage();
            return Promise.resolve({ isOk: true });
          }
        }
        return Promise.resolve({ isOk: false });
      }
      
      saveToStorage() {
        const data = {
          users,
          questions,
          teacherCodes,
          readingTexts,
          learningCastles
        };
        localStorage.setItem(this.storageKey, JSON.stringify(data));
        allData = [...users, ...questions, ...teacherCodes, ...readingTexts, ...learningCastles];
      }
    }

    // Supabase Integration
    class SupabaseSDK {
      constructor() {
        this.supabaseUrl = 'https://bxpwkdfyeppwwsirfjqj.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4cHdrZGZ5ZXBwd3dzaXJmanFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDIyNTcsImV4cCI6MjA4MjQxODI1N30.KKLSihpKlZov-FnpuTkoSbckZchhjjSIiOQcFfN-qE8';
        this.isBackingUp = false;
        if (window.supabase) {
          this.client = window.supabase.createClient(this.supabaseUrl, this.supabaseKey, {
            auth: {
              autoRefreshToken: false,
              persistSession: false
            },
            global: {
              fetch: (url, options) => {
                return fetch(url, {
                  ...options,
                  signal: AbortSignal.timeout(20000) // 20 Ø«Ø§Ù†ÙŠØ©
                });
              }
            }
          });
        } else {
          console.error('Supabase library not loaded. Check internet connection.');
          this.client = null;
        }
      }
      
      // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª (Pagination)
      async fetchAll(table, queryModifier) {
        let allData = [];
        let from = 0;
        const limit = 1000; // Ø¬Ù„Ø¨ 1000 Ø¹Ù†ØµØ± ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
        let more = true;

        while (more) {
          let query = this.client.from(table).select('*').range(from, from + limit - 1);
          if (queryModifier) query = queryModifier(query);
          
          const { data, error } = await query;
          if (error) throw error;
          
          allData = allData.concat(data);
          if (data.length < limit) more = false;
          from += limit;
        }
        return { data: allData };
      }

      async syncData(silent = false) {
        try {
          if (!this.client) {
            throw new Error('Supabase client not initialized');
          }
          if (!silent) showLoader('Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
          // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Supabase
          const { data: usersData, error: usersError } = await this.client.from('users').select('*');
          if (usersError) console.error('Users Sync Error:', usersError);
          
          // ØªØ­Ø³ÙŠÙ†: Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
          // ÙˆÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const qModifier = (query) => {
             if (currentUser && currentUser.user_type === 'student' && currentUser.grade) {
                 return query.eq('grade', currentUser.grade);
             }
             return query;
          };
          const { data: questionsData, error: questionsError } = await this.fetchAll('questions', qModifier).catch(e => ({ error: e }));
          if (questionsError) console.error('Questions Sync Error:', questionsError);

          const { data: codesData, error: codesError } = await this.client.from('teacher_codes').select('*');
          if (codesError) console.error('Codes Sync Error:', codesError); 

          const { data: readingData, error: readingError } = await this.client.from('reading_texts').select('*');
          if (readingError) console.error('Reading Sync Error:', readingError);

          const { data: castlesData, error: castlesError } = await this.client.from('learning_castles').select('*').order('order_index');
          if (castlesError) console.error('Castles Sync Error:', castlesError);

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª
          if (usersData) {
            // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ __backendId Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            users = usersData.map(u => ({...u, __backendId: u.__backendId || u.id || u.user_id}));
          }

          if (questionsData) {
            questions = questionsData.map(q => ({...q, __backendId: q.__backendId || q.id || q.question_id}));
          }

          if (codesData) {
            teacherCodes = codesData.map(c => ({...c, __backendId: c.__backendId || c.id || c.code_id}));
          }

          if (readingData) {
            readingTexts = readingData.map(r => ({...r, __backendId: r.__backendId || r.id || r.reading_id}));
          }

          if (castlesData) {
            learningCastles = castlesData.map(c => ({...c, __backendId: c.__backendId || c.id}));
          }

          // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
          if (window.dataSdk) {
            window.dataSdk.saveToStorage();
          }

          // showToast('ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase', 'success');
          renderCurrentScreen();
          return { isOk: true };
        } catch (error) {
          if (error.name === 'AbortError' || (error.cause && error.cause.name === 'AbortError')) {
             console.warn('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ â€“ ØªØ¬Ø§Ù‡Ù„Ù‡');
             return { isOk: false, error: 'Timeout' };
          }
          console.error('Supabase Sync Error:', error);
          if (error.message && error.message.includes('Failed to fetch')) {
             showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.', 'warning');
          } else if (error.code === '42501' || error.message?.includes('row-level security')) {
             showToast('ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† (RLS) ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª ÙÙŠ Supabase.', 'error');
          }
          return { isOk: false, error };
        } finally {
          if (!silent) hideLoader();
        }
      }
      
      async backupData() {
        if (this.isBackingUp) return { isOk: false, error: 'Backup in progress' };
        this.isBackingUp = true;

        try {
          if (!this.client) return { isOk: false, error: 'No client' };

          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
          const { data: { session } } = await this.client.auth.getSession();
          if (!session) {
            return { isOk: false, error: 'User not logged in' };
          }
          
          const currentUserId = session.user.id;

          /* =========================
             USERS (Ø¨Ø¯ÙˆÙ† password)
          ========================== */
          const cleanUsers = users
            .filter(u => u.username && u.user_id === currentUserId) // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            .map(u => ({
              user_id: u.user_id, // UUID ÙÙ‚Ø·
              username: u.username,
              full_name: u.full_name,
              user_type: u.user_type,
              is_approved: u.is_approved ?? true,
              grade: u.grade ?? null,
              semester: u.semester ?? null,
              total_points: u.total_points ?? 0,
              stars_collected: u.stars_collected ?? 0,
              skills_mastered: typeof u.skills_mastered === 'number' ? u.skills_mastered : 0,
              current_level: u.current_level ?? 1,
              last_login: u.last_login ?? null,
              progress_data: u.progress_data ?? {},
              created_at: u.created_at ?? new Date().toISOString()
            }));
      
      
          /* =========================
             QUESTIONS (Ù…ÙÙ†Ø¸Ù‘ÙÙØ©)
          ========================== */
          const cleanQuestions = questions
            .filter(q => q.question_id && q.user_id === currentUserId) // ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ÙÙ‚Ø· Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            .map(({ __backendId, ...q }) => ({
              question_id: q.question_id,
              user_id: q.user_id || null,
              question_text: q.question_text?.trim() || (q.question_type === 'reading' ? q.reading_title : null),
              answer_a: q.answer_a?.trim() || null,
              answer_b: q.answer_b?.trim() || null,
              answer_c: q.answer_c?.trim() || null,
              answer_d: q.answer_d?.trim() || null,
              correct_answer: q.correct_answer ? String(q.correct_answer).toUpperCase().trim() : null,
              question_type: q.question_type || 'multiple_choice',
              skill_id: q.skill_id || null,
              city_id: q.city_id || null,
              points_value: parseInt(q.points_value) || 0, // Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ©
              explanation: q.explanation || null,
              created_by: q.created_by || null,
              difficulty_level: q.difficulty_level ? String(q.difficulty_level).toLowerCase().trim() : null,
              reading_text: q.reading_text || null,
              reading_title: q.reading_title || null,
              reading_parent_id: q.reading_parent_id || null,
              subject: q.subject ?? null,
              grade: q.grade ?? null,
              semester: q.semester ?? null,
              created_at: q.created_at ?? new Date().toISOString()
            }))
            .filter(q =>
              (q.question_type === 'reading' && q.reading_title && q.reading_text) ||
              (
                q.question_text &&
                q.answer_a &&
                q.answer_b &&
                q.answer_c &&
                q.answer_d &&
                ['A', 'B', 'C', 'D'].includes(q.correct_answer)
              )
            );
      
      
          /* =========================
             TEACHER CODES
          ========================== */
          const cleanCodes = teacherCodes
            .filter(c => c.code_id && c.user_id === currentUserId) // ØªØµÙÙŠØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: ÙÙ‚Ø· Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            .map(c => {
            const codeObj = {
              code_id: c.code_id,
              code: c.code,
              is_used: Boolean(c.is_used), // Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© boolean
              created_at: c.created_at
            };
            if (c.created_for) codeObj.created_for = c.created_for;
            return codeObj;
          });

          /* =========================
             LEARNING CASTLES
          ========================== */
          const cleanCastles = learningCastles
            .filter(c => c.created_by === currentUserId) // ØªØµÙÙŠØ© Ø§Ù„Ù‚Ù„Ø§Ø¹: ÙÙ‚Ø· Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            .map(({ __backendId, ...c }) => c);

      
      
          /* =========================
             READING TEXTS
          ========================== */
          // ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¯Ù…Ø¬Ù‡ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
          // const cleanReading = readingTexts.map(({ __backendId, user_id, ...r }) => r);
      
      
          /* =========================
             UPSERT TO SUPABASE
          ========================== */
          if (cleanUsers.length) {
            const { error } = await this.client
              .from('users')
              .upsert(cleanUsers, { onConflict: 'user_id' });
            if (error) console.error('Users Sync Error:', error);
          }
      
          if (cleanQuestions.length) {
            const { error } = await this.client
              .from('questions')
              .upsert(cleanQuestions, { onConflict: 'question_id' });
            if (error) {
              console.error('Questions Sync Error:', error);
              console.log('Failed Questions Payload:', cleanQuestions);
            }
          }
      
          if (cleanCodes.length) {
            const { error } = await this.client
              .from('teacher_codes')
              .upsert(cleanCodes, { onConflict: 'code_id' });
            if (error) console.error('Codes Sync Error:', error);
          }
      
          if (cleanCastles.length) {
            const { error } = await this.client
              .from('learning_castles')
              .upsert(cleanCastles, { onConflict: 'id' });
            if (error) console.error('Castles Sync Error:', error);
          }

          // if (cleanReading.length) {
          //   const { error } = await this.client
          //     .from('reading_texts')
          //     .upsert(cleanReading, { onConflict: 'reading_id' });
          //   if (error) console.error('Reading Texts Sync Error:', error);
          // }
      
          return { isOk: true };
      
        } catch (error) {
          console.error('Supabase Backup Error:', error);
          
          if (error.message && error.message.includes('Failed to fetch')) {
            showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
            return { isOk: false, error };
          }
          
          showToast(
            'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'),
            'error'
          );
          return { isOk: false, error };
        } finally {
          this.isBackingUp = false;
        }
      }

      // Challenge Methods
      async createChallenge(challengeData) {
        try {
          const { data, error } = await this.client.from('challenges').insert(challengeData).select();
          if (error) throw error;
          return { isOk: true, data: data[0] };
        } catch (error) {
          console.log('Create Challenge Error:', error);
          return { isOk: false, error };
        }
      }

      async joinChallenge(challengeId, guestUsername) {
        try {
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØ­Ø¯ÙŠ
          const { data: challenge, error: fetchError } = await this.client.from('challenges').select('*').eq('id', challengeId).single();
          if (fetchError || !challenge) throw new Error('Ø§Ù„ØªØ­Ø¯ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          if (challenge.status !== 'waiting') throw new Error('Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰');

          const { data, error } = await this.client.from('challenges')
            .update({ guest_username: guestUsername, status: 'active' })
            .eq('id', challengeId)
            .select();
            
          if (error) throw error;
          return { isOk: true, data: data[0] };
        } catch (error) {
          return { isOk: false, error: error.message };
        }
      }

      async getChallenge(challengeId) {
        const { data, error } = await this.client.from('challenges').select('*').eq('id', challengeId).single();
        return { isOk: !error, data };
      }

      async updateChallengeScore(challengeId, role, score) {
        const updateData = role === 'host' ? { host_score: score } : { guest_score: score };
        await this.client.from('challenges').update(updateData).eq('id', challengeId);
      }

      // Smart Questions Logic
      async loadLevelQuestions(skillId, grade, cityId) {
        if (!this.client || !currentUser) return { isOk: false };
        const userId = currentUser.user_id;
        
        try {
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… RPC (Ø§Ù„Ø£Ø³Ø±Ø¹ ÙˆØ§Ù„Ø£ÙØ¶Ù„)
          const { data: rpcQuestions, error: rpcError } = await this.client.rpc('get_random_questions', {
            p_skill_id: skillId,
            p_user_id: userId,
            p_limit: 10,
            p_grade: grade,
            p_city_id: cityId
          });

          if (!rpcError) {
            let finalQuestions = rpcQuestions || [];

            // Ø¥Ø°Ø§ Ù†ÙØ¯Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø£Ù‚Ù„ Ù…Ù† 10)ØŒ Ù†Ø¹ÙŠØ¯ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø³Ø¬Ù„
            if (finalQuestions.length < 10) {
               // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
               await this.client
                .from('student_questions_history')
                .delete()
                .eq('user_id', userId)
                .eq('skill_id', skillId);
                
               // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ø¢Ù† Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±ØºØŒ ÙØ³ØªØ¹ÙˆØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
               const { data: moreQuestions } = await this.client.rpc('get_random_questions', {
                  p_skill_id: skillId,
                  p_user_id: userId,
                  p_limit: 10 - finalQuestions.length,
                  p_grade: grade,
                  p_city_id: cityId
               });
               
               if (moreQuestions) {
                 finalQuestions = [...finalQuestions, ...moreQuestions];
               }
            }
            return { isOk: true, data: finalQuestions };
          }

          console.warn('RPC failed, falling back to legacy fetch:', rpcError.message);

          // --- Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© SQL) ---
          const { data: history } = await this.client
            .from('student_questions_history')
            .select('question_id')
            .eq('user_id', userId)
            .eq('skill_id', skillId);
            
          const seenIds = history?.map(h => h.question_id) || [];
          
          // 2. Ø¬Ù„Ø¨ Ø£Ø³Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ÙƒØ±Ø±Ø©
          let query = this.client
            .from('questions')
            .select('*')
            .eq('skill_id', skillId);
            
          if (grade) query = query.eq('grade', grade);
          if (cityId) query = query.eq('city_id', cityId);
            
          // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ„ ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
          const { data: allQuestions, error } = await query.limit(1000);
          
          if (error) throw error;
          
          // ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ø±Ø¢Ù‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹
          let finalQuestions = (allQuestions || []).filter(q => !seenIds.includes(q.question_id));

          // 3. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚Ù‘Ù Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© (Ø£Ù‚Ù„ Ù…Ù† 10) ÙˆÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚
          if (finalQuestions.length < 10 && seenIds.length > 0) {
            // Ù†Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ù„Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
            await this.client
              .from('student_questions_history')
              .delete()
              .eq('user_id', userId)
              .eq('skill_id', skillId);

            // Ù†ÙƒÙ…Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª "Ù…Ø´Ø§Ù‡Ø¯Ø©" Ø³Ø§Ø¨Ù‚Ø§Ù‹ (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ allQuestions)
            const needed = 10 - finalQuestions.length;
            const recycledQuestions = (allQuestions || [])
                .filter(q => seenIds.includes(q.question_id))
                .sort(() => Math.random() - 0.5)
                .slice(0, needed);
            
            finalQuestions = [...finalQuestions, ...recycledQuestions];
          }

          // Ù†Ø£Ø®Ø° 10 Ø£Ø³Ø¦Ù„Ø© ÙÙ‚Ø· ÙˆÙ†Ø®Ù„Ø·Ù‡Ù…
          return { isOk: true, data: finalQuestions.sort(() => Math.random() - 0.5).slice(0, 10) };
        } catch (error) {
          console.log('Load level questions failed', error);
          return { isOk: false };
        }
      }

      async recordHistory(questionId, isCorrect, skillId) {
        if (!this.client || !currentUser) return;
        await this.client.from('student_questions_history').insert({
          user_id: currentUser.user_id,
          question_id: questionId,
          is_correct: isCorrect,
          skill_id: skillId,
          answered_at: new Date().toISOString()
        }).select();
      }

      async saveQuestionsToHistory(questions, skillId) {
        if (!this.client || !currentUser) return;

        // ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªÙ…Ù„Ùƒ UUID ØµØ§Ù„Ø­ (Ù…Ø«Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© "test1")
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

        const rows = questions
          .filter(q => q.question_id && uuidRegex.test(q.question_id))
          .map(q => ({
            user_id: currentUser.user_id,
            question_id: q.question_id,
            skill_id: skillId
          }));

        if (rows.length === 0) return;

        const { error } = await this.client
          .from('student_questions_history')
          .insert(rows);
          
        if (error) console.error('Error saving questions history:', error);
      }

      async getCastles(selectedGrade, selectedSubject) {
        const { data: castles, error } = await this.client
          .from("learning_castles")
          .select("*")
          .eq("grade", selectedGrade)
          .eq("subject", selectedSubject)
          .eq("is_active", true)
          .order("order_index");
        return { data: castles, error };
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© SDKs
    const supabaseSdk = new SupabaseSDK();
    
    async function init() {
      window.dataSdk = new LocalStorageSDK();
      await window.dataSdk.init();
      try {
        window.dataSdk = new LocalStorageSDK();
        await window.dataSdk.init();
      } catch (e) {
        console.error("Init Error:", e);
      }
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
      isMuted = localStorage.getItem('rhlat_isMuted') === 'true';
      
      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±
      const savedFont = localStorage.getItem('rhlat_font_family');
      const savedSize = localStorage.getItem('rhlat_font_size');
      const savedBg = localStorage.getItem('rhlat_background_color');
      const savedCard = localStorage.getItem('rhlat_card_surface_color');
      const savedText = localStorage.getItem('rhlat_text_color');

      window.elementSdk = {
        init: () => Promise.resolve({}),
        setConfig: () => {},
        config: { 
          ...defaultConfig, 
          font_family: savedFont || defaultConfig.font_family, 
          font_size: savedSize ? parseInt(savedSize) : defaultConfig.font_size,
          background_color: savedBg || defaultConfig.background_color,
          card_surface_color: savedCard || defaultConfig.card_surface_color,
          text_color: savedText || defaultConfig.text_color
        },
        onConfigChange: () => {}
      };
      
      renderCurrentScreen();
      
      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (ØµØ§Ù…ØªØ©) Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¨Ø¯Ø¡
      supabaseSdk.backupData().then(() => supabaseSdk.syncData(true));
      
      // Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
      setInterval(() => {
        supabaseSdk.backupData();
      }, 5 * 60 * 1000);
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const bgColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
      const textColor = window.elementSdk?.config?.text_color || defaultConfig.text_color;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.backgroundColor = bgColor;
      toast.style.color = textColor;
      toast.style.fontSize = `${baseFontSize}px`;
      toast.style.padding = '16px 24px';
      toast.style.borderRadius = '12px';
      toast.style.boxShadow = '0 10px 40px rgba(0,0,0,0.3)';
      toast.style.fontWeight = 'bold';
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function applyStyles() {
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const cardColor = window.elementSdk?.config?.card_surface_color || defaultConfig.card_surface_color;
      const textColor = window.elementSdk?.config?.text_color || defaultConfig.text_color;
      const primaryColor = window.elementSdk?.config?.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = window.elementSdk?.config?.secondary_action_color || defaultConfig.secondary_action_color;
      
      document.body.style.backgroundColor = bgColor;
      document.body.style.color = textColor;
      document.body.style.fontFamily = `${customFont}, Segoe UI, Roboto, sans-serif`;
      document.body.style.fontSize = `${baseFontSize}px`;
    }

    function renderCurrentScreen() {
      applyStyles();
      const app = document.getElementById('app');
      
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const cardColor = window.elementSdk?.config?.card_surface_color || defaultConfig.card_surface_color;
      const textColor = window.elementSdk?.config?.text_color || defaultConfig.text_color;
      const primaryColor = window.elementSdk?.config?.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = window.elementSdk?.config?.secondary_action_color || defaultConfig.secondary_action_color;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const gameTitle = window.elementSdk?.config?.game_title || defaultConfig.game_title;
      const gameSubtitle = window.elementSdk?.config?.game_subtitle || defaultConfig.game_subtitle;
      const guideName = window.elementSdk?.config?.guide_name || defaultConfig.guide_name;
      const welcomeMessage = window.elementSdk?.config?.welcome_message || defaultConfig.welcome_message;
      
      let content = '';
      
      // 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      if (currentScreen === 'login') {
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-md">
              <div class="text-center mb-8 float-animation">
                <div style="font-size: ${baseFontSize * 4}px;" class="mb-4">ğŸï¸</div>
                <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">${gameTitle}</h1>
                <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="opacity-80">${gameSubtitle}</p>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl">
                <h2 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-6 text-center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                
                <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="login_email" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent focus:border-opacity-50 outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                  </div>
                  
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="login_password" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent focus:border-opacity-50 outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                  </div>
                  
                  <button type="submit"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-lg font-bold mt-6 hover:opacity-90 transition-all pulse-glow">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”
                  </button>
                </form>
                
                <div class="mt-6 flex items-center justify-between">
                  <button onclick="goToRegister()"
                    style="color: ${primaryColor}; font-size: ${baseFontSize * 0.875}px;"
                    class="font-semibold hover:opacity-80 transition-all">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ âœ¨
                  </button>
                  <button onclick="goToForgotPassword()"
                    style="color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                    class="opacity-70 hover:opacity-100 transition-all">
                    Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 1.5 Ø´Ø§Ø´Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      else if (currentScreen === 'forgot_password') {
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-md">
              <div class="text-center mb-8 float-animation">
                <div style="font-size: ${baseFontSize * 4}px;" class="mb-4">ğŸ”</div>
                <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h1>
                <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="opacity-80">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl">
                <form id="resetPasswordForm" onsubmit="handleForgotPassword(event)" class="space-y-4">
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="forgot_email" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                  </div>
                  
                  <button type="submit"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-lg font-bold mt-6 hover:opacity-90 transition-all pulse-glow">
                    Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ğŸ“©
                  </button>
                </form>
                
                <div class="mt-6 text-center">
                  <button onclick="goToLogin()"
                    style="color: ${primaryColor}; font-size: ${baseFontSize}px;"
                    class="font-semibold hover:opacity-80 transition-all">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â¬…ï¸
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 2. Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      else if (currentScreen === 'register') {
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-md">
              <div class="text-center mb-8 float-animation">
                <div style="font-size: ${baseFontSize * 4}px;" class="mb-4">ğŸ“</div>
                <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
                <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="opacity-80">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©</p>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl">
                <form id="registerForm" onsubmit="handleRegister(event)" class="space-y-4">
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="register_email" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                  </div>
                  
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="register_fullname" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                  </div>
                  
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="register_username" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent outline-none"
                      placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…">
                  </div>
                  
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="register_password" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
                  </div>
                  
                  <button type="submit"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-lg font-bold mt-6 hover:opacity-90 transition-all pulse-glow">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ¨
                  </button>
                </form>
                
                <div class="mt-6 text-center">
                  <button onclick="goToLogin()"
                    style="color: ${primaryColor}; font-size: ${baseFontSize}px;"
                    class="font-semibold hover:opacity-80 transition-all">
                    Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ğŸ”
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 3. Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ
      else if (currentScreen === 'setup') {
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-2xl">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold">${gameTitle}</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser?.full_name || currentUser?.username}</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="promptUpgrade()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-4 py-3 rounded-lg font-semibold hover:opacity-80 transition-all"
                    title="ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨">
                    ğŸ”‘
                  </button>
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl slide-in">
                <div class="text-center mb-6">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-4">ğŸ“š</div>
                  <h2 style="font-size: ${baseFontSize * 1.75}px; color: ${textColor};" class="font-bold mb-2">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h2>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">ÙÙŠ Ø£ÙŠ ØµÙ Ø£Ù†ØªØŸ</p>
                </div>
                
                <div class="space-y-4 mb-6">
                  <button type="button" onclick="selectGradeAndContinue('grade3')"
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-xl font-bold hover:opacity-80 transition-all border-4 border-transparent hover:border-opacity-50">
                    ğŸ“– Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
                  </button>
                  <button type="button" onclick="selectGradeAndContinue('grade6')"
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-xl font-bold hover:opacity-80 transition-all border-4 border-transparent hover:border-opacity-50">
                    ğŸ“— Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
                  </button>
                  <button type="button" onclick="selectGradeAndContinue('grade9')"
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-xl font-bold hover:opacity-80 transition-all border-4 border-transparent hover:border-opacity-50">
                    ğŸ“˜ Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·
                  </button>
                </div>

                <button onclick="backToSemester()"
                  style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="w-full py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // 4. Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
      else if (currentScreen === 'semester') {
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-2xl">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold">${gameTitle}</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser?.full_name || currentUser?.username}</p>
                </div>
                <button onclick="logout()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                </button>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl slide-in">
                <div class="text-center mb-6">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-4">ğŸŒ</div>
                  <h2 style="font-size: ${baseFontSize * 1.75}px; color: ${textColor};" class="font-bold mb-2">Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³</h2>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¨ÙˆØ§Ø¨ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„ØªÙ…ÙŠØ²</p>
                </div>
                
                <div class="grid grid-cols-1 gap-4 mb-6">
                  <button onclick="selectSemesterAndContinue('semester3')"
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize * 1.25}px;"
                    class="py-6 rounded-xl font-bold hover:opacity-80 transition-all border-4 border-transparent hover:border-opacity-50">
                    <div style="font-size: ${baseFontSize * 3}px;" class="mb-2">ğŸš€</div>
                    <div>Ø¹Ø§Ù„Ù… Ù†Ø§ÙØ³</div>
                    <div style="font-size: ${baseFontSize * 0.875}px;" class="opacity-70 mt-1">ØªØ­Ø¯ÙŠ Ù†Ø§ÙØ³</div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 5. Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ù„Ù…Ø¯Ù†)
      else if (currentScreen === 'subjects') {
        const currentIslandData = islands[gameState.currentIsland];
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-4xl">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold">${gameTitle}</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">${currentUser?.full_name || currentUser?.username} - Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
                </div>
                <button onclick="logout()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                </button>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl slide-in">
                <div class="text-center mb-8">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-4 float-animation">
                    ${currentIslandData.theme.split(' ')[0]}
                  </div>
                  <h2 style="font-size: ${baseFontSize * 1.75}px; color: ${textColor};" class="font-bold mb-2">${currentIslandData.name}</h2>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  ${currentIslandData.cities.map(city => {
                    const cityQuestionsCount = questions.filter(q => q.city_id === city.id && q.grade === (gameState.selectedGrade || 'grade3')).length;
                    return `
                      <button onclick="${city.locked ? '' : `selectSubject('${city.id}')`}"
                        ${city.locked ? 'disabled' : ''}
                        style="background-color: ${city.locked ? bgColor : primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                        class="skill-button p-6 rounded-xl font-semibold transition-all ${city.locked ? 'opacity-40 cursor-not-allowed' : 'hover:opacity-90'}">
                        <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">${city.emoji}</div>
                        <div style="font-size: ${baseFontSize * 1.125}px;" class="mb-2">${city.name}</div>
                        ${city.locked ? `
                          <div style="font-size: ${baseFontSize * 1.5}px;" class="mt-2">ğŸ”’</div>
                        ` : `
                          <div style="font-size: ${baseFontSize * 0.75}px;" class="opacity-70">${cityQuestionsCount} Ø³Ø¤Ø§Ù„ Ù…ØªØ§Ø­</div>
                        `}
                      </button>
                    `;
                  }).join('')}
                </div>
                
                <button onclick="backToGrade()"
                  style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="w-full py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙÙˆÙ
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      // 5.5 Ø´Ø§Ø´Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
      else if (currentScreen === 'leaderboard') {
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
        const topStudents = users
          .filter(u => u.user_type === 'student')
          .sort((a, b) => (b.total_points || 0) - (a.total_points || 0))
          .slice(0, 10);
          
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-2xl">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ©</p>
                </div>
                <button onclick="backToGrade()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  Ø¹ÙˆØ¯Ø© â¬…ï¸
                </button>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 shadow-2xl slide-in">
                ${topStudents.length === 0 ? `
                  <div class="text-center py-8">
                    <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯</p>
                  </div>
                ` : `
                  <div class="space-y-3">
                    ${topStudents.map((student, index) => {
                      let rankEmoji = 'ğŸ‘';
                      let rankColor = bgColor;
                      if (index === 0) { rankEmoji = 'ğŸ¥‡'; rankColor = '#fbbf2420'; }
                      else if (index === 1) { rankEmoji = 'ğŸ¥ˆ'; rankColor = '#94a3b820'; }
                      else if (index === 2) { rankEmoji = 'ğŸ¥‰'; rankColor = '#b4530920'; }
                      
                      return `
                        <div style="background-color: ${rankColor}; border: 1px solid ${index < 3 ? primaryColor : 'transparent'};" 
                             class="rounded-xl p-4 flex items-center gap-4 transition-all hover:scale-[1.01]">
                          <div style="font-size: ${baseFontSize * 1.5}px; width: 40px; text-align: center;">${rankEmoji}</div>
                          <div class="flex-1">
                            <div style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold">
                              ${student.full_name || student.username}
                              ${currentUser && currentUser.username === student.username ? ' (Ø£Ù†Øª)' : ''}
                            </div>
                            <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">
                              ${student.grade === 'grade3' ? 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«' : student.grade === 'grade6' ? 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³' : student.grade === 'grade9' ? 'Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </div>
                          </div>
                          <div class="text-center">
                            <div style="font-size: ${baseFontSize * 1.25}px; color: ${primaryColor};" class="font-bold">${Math.floor(student.total_points || 0)}</div>
                            <div style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-70">Ù†Ù‚Ø·Ø©</div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }

      // 5.6 Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ø¯ÙŠ
      else if (currentScreen === 'challenge_menu') {
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-md">
              <div class="text-center mb-8">
                <div style="font-size: ${baseFontSize * 4}px;" class="mb-4">âš”ï¸</div>
                <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h1>
                <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">ØªÙ†Ø§ÙØ³ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ!</p>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl slide-in">
                <button onclick="createNewChallenge()"
                  style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                  class="w-full py-4 rounded-xl font-bold mb-4 hover:opacity-90 transition-all">
                  Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯ ğŸ†•
                </button>
                
                <div class="relative flex py-2 items-center">
                  <div class="flex-grow border-t border-gray-500"></div>
                  <span class="flex-shrink-0 mx-4 text-gray-400">Ø£Ùˆ</span>
                  <div class="flex-grow border-t border-gray-500"></div>
                </div>
                
                <div class="mt-4">
                  <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ø¯ÙŠ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</label>
                  <div class="flex gap-2">
                    <input type="text" id="joinCodeInput" maxlength="4"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize * 1.25}px; letter-spacing: 4px; text-align: center;"
                      class="w-full px-4 py-3 rounded-lg border-2 border-transparent outline-none"
                      placeholder="0000">
                    <button onclick="joinExistingChallenge()"
                      style="background-color: ${secondaryColor}; color: ${textColor};"
                      class="px-6 rounded-lg font-bold hover:opacity-90 transition-all">
                      Ø§Ù†Ø¶Ù…
                    </button>
                  </div>
                </div>
                
                <button onclick="backToSubjects()"
                  style="color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="w-full py-3 mt-6 rounded-lg font-semibold hover:opacity-80 transition-all opacity-70">
                  Ø¥Ù„ØºØ§Ø¡ ÙˆØ¹ÙˆØ¯Ø©
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // 5.7 Ø´Ø§Ø´Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠ (Lobby)
      else if (currentScreen === 'challenge_lobby') {
        const isHost = gameState.challengeData.host_username === currentUser.username;
        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-md text-center">
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 shadow-2xl slide-in">
                <div class="mb-6">
                  <div class="animate-spin inline-block w-12 h-12 border-4 border-t-transparent border-blue-500 rounded-full mb-4"></div>
                  <h2 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold">
                    ${isHost ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³...' : 'Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...'}
                  </h2>
                </div>
                
                <div style="background-color: ${bgColor};" class="rounded-xl p-6 mb-6">
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-70 mb-2">ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ø¯ÙŠ</p>
                  <div style="font-size: ${baseFontSize * 3}px; color: ${primaryColor}; letter-spacing: 8px;" class="font-bold font-mono">
                    ${gameState.challengeData.id}
                  </div>
                </div>
                
                <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80 mb-6">
                  ${isHost ? 'Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ ØµØ¯ÙŠÙ‚Ùƒ Ù„ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ' : 'Ø§Ø³ØªØ¹Ø¯! Ø³ØªØ¨Ø¯Ø£ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹'}
                </p>
                
                <button onclick="cancelChallenge()"
                  style="background-color: #ef4444; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition-all">
                  Ø¥Ù„ØºØ§Ø¡
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // 5.8 Ø´Ø§Ø´Ø© Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠ (Multiplayer Game)
      else if (currentScreen === 'multiplayer_game') {
        const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
        const isHost = gameState.challengeData.host_username === currentUser.username;
        const myScore = isHost ? gameState.challengeData.host_score : gameState.challengeData.guest_score;
        const opponentScore = isHost ? gameState.challengeData.guest_score : gameState.challengeData.host_score;
        const opponentName = isHost ? gameState.challengeData.guest_username : gameState.challengeData.host_username;

        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-4xl mx-auto">
              <!-- Scoreboard -->
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div style="background-color: ${primaryColor};" class="rounded-xl p-4 text-center transform scale-105 shadow-lg border-2 border-white">
                  <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="font-bold mb-1">Ø£Ù†Øª</div>
                  <div style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold">${myScore || 0}</div>
                </div>
                <div style="background-color: ${cardColor};" class="rounded-xl p-4 text-center opacity-90">
                  <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="font-bold mb-1">${opponentName}</div>
                  <div style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold">${opponentScore || 0}</div>
                </div>
              </div>

              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 mb-6 slide-in">
                <div class="text-center mb-8">
                  <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-70 mb-2 block">Ø§Ù„Ø³Ø¤Ø§Ù„ ${gameState.currentQuestionIndex + 1} Ù…Ù† ${gameState.currentQuestions.length}</span>
                  <div id="questionDisplay" class="font-bold"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  ${[
                    {key: 'A', text: currentQ.answer_a},
                    {key: 'B', text: currentQ.answer_b},
                    {key: 'C', text: currentQ.answer_c},
                    {key: 'D', text: currentQ.answer_d}
                  ].map((answer) => `
                    <button onclick="selectMultiplayerAnswer('${answer.key}')" id="mpAnswerBtn${answer.key}"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px; font-family: 'Tajawal', sans-serif;"
                      class="py-4 px-4 rounded-xl font-bold hover:opacity-80 transition-all border-4 border-transparent flex items-center gap-4">
                      <span style="background-color: ${primaryColor}; color: ${textColor};" class="w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg flex-shrink-0">${answer.key}</span>
                      <div id="answerText${answer.key}" class="flex-1 text-right">${answer.text}</div>
                    </button>
                  `).join('')}
                </div>
              </div>
              <div class="text-center text-sm opacity-50 text-white">
                ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©...
              </div>
            </div>
          </div>
        `;
      }

      // 6. Ø´Ø§Ø´Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª (Ø§Ù„Ù‚Ù„Ø§Ø¹)
      else if (currentScreen === 'castle') {
        const castleId = gameState.currentCastle;
        const gradeKey = gameState.selectedGrade || 'grade3';
        const subjectName = castleId.replace('_test', '');
        
        const castleUnits = learningCastles
          .filter(c => c.subject === subjectName && c.grade === gradeKey)
          .sort((a, b) => (a.order_index || 0) - (b.order_index || 0))
          .map((c, i) => ({
            id: c.id || c.__backendId,
            name: c.title,
            level: i + 1,
            points: 100,
            lessons: c.learning_outcome ? [c.learning_outcome] : [],
            video_url: c.video_url
          }));

        const castleQuestionsCount = questions.filter(q => q.city_id === castleId && q.grade === gradeKey).length;
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-4xl mx-auto">
              <div class="flex items-center justify-between mb-6">
                <button onclick="backToSubjects()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
                </button>
                <button onclick="logout()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                </button>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 mb-8 text-center">
                <div style="font-size: ${baseFontSize * 4}px;" class="mb-4 float-animation">
                  ${Object.values(islands).flatMap(i => i.cities).find(c => c.id === castleId)?.emoji || 'ğŸ›ï¸'}
                </div>
                <h2 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-4">
                  ${Object.values(islands).flatMap(i => i.cities).find(c => c.id === castleId)?.name || 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'}
                </h2>
                
                <div style="background-color: ${bgColor};" class="rounded-xl p-4 inline-block mb-4">
                  <div class="flex items-center gap-3">
                    <div style="font-size: ${baseFontSize * 2}px;">ğŸ§™â€â™‚ï¸</div>
                    <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">
                      ${guideName}: ${castleQuestionsCount > 0 ? 'Ø§Ø®ØªØ± Ù‚Ù„Ø¹Ø© Ù„ØªØ¨Ø¯Ø£ Ø§Ù„ØªØ¹Ù„Ù…!' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹'}
                    </p>
                  </div>
                </div>
                
                ${castleQuestionsCount > 0 ? `
                  <div style="background-color: ${primaryColor}20;" class="rounded-lg p-3 inline-block">
                    <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};">ğŸ“ ${castleQuestionsCount} Ø³Ø¤Ø§Ù„ Ù…ØªØ§Ø­</span>
                  </div>
                ` : `
                  <div style="background-color: #ef444420;" class="rounded-lg p-3 inline-block">
                    <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};">âš ï¸ Ø§Ø·Ù„Ø¨ Ù…Ù† Ù…Ø¹Ù„Ù…Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                  </div>
                `}
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${castleUnits.map((unit, index) => {
                  const unitQuestionsCount = questions.filter(q => q.skill_id === unit.id && q.city_id === castleId && q.grade === gradeKey).length;
                  // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…ÙØªÙˆØ­ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¥Ø°Ø§ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
                  const isUnlocked = index === 0 || gameState.completedSkills.includes(castleUnits[index - 1].id);
                  
                  return `
                    <div style="background-color: ${cardColor}; opacity: ${isUnlocked ? 1 : 0.6};" class="rounded-xl p-6 transition-all ${isUnlocked ? 'hover:opacity-90 cursor-pointer' : 'cursor-not-allowed'}"
                      onclick="${isUnlocked ? `startUnit('${unit.id}')` : ''}">
                      <div class="flex items-center justify-between mb-4">
                        <h3 style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold">${unit.name} ${!isUnlocked ? 'ğŸ”’' : ''}</h3>
                        <div style="background-color: ${primaryColor};" class="px-3 py-1 rounded-full">
                          <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="font-semibold">Ù…Ø³ØªÙˆÙ‰ ${unit.level}</span>
                        </div>
                      </div>
                      
                      ${unit.lessons ? `
                        <div style="background-color: ${bgColor};" class="rounded-lg p-3 mb-4 text-right">
                          <div style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-70 mb-2 font-semibold">Ø§Ù„Ø¯Ø±ÙˆØ³:</div>
                          ${unit.lessons.slice(0, 3).map(lesson => `
                            <div style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-60 mb-1">â€¢ ${lesson}</div>
                          `).join('')}
                          ${unit.lessons.length > 3 ? `<div style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-50 mt-1">Ùˆ${unit.lessons.length - 3} Ø¯Ø±ÙˆØ³ Ø£Ø®Ø±Ù‰...</div>` : ''}
                        </div>
                      ` : ''}
                      
                      <div class="flex items-center gap-4 mb-4">
                        <div class="flex-1" style="background-color: ${bgColor}; height: 8px; border-radius: 999px;">
                          <div style="background-color: ${secondaryColor}; width: ${(gameState.completedSkills.includes(unit.id) ? 100 : 0)}%; height: 100%; border-radius: 999px;"></div>
                        </div>
                        <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};">${gameState.completedSkills.includes(unit.id) ? 'âœ“' : '0%'}</span>
                      </div>
                      
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                          <span style="font-size: ${baseFontSize * 1.125}px;">ğŸ†</span>
                          <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="font-semibold">${unit.points} Ù†Ù‚Ø·Ø©</span>
                        </div>
                        ${isUnlocked ? `
                          <button
                            style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                            class="px-4 py-2 rounded-lg font-semibold hover:opacity-90">
                            ${gameState.completedSkills.includes(unit.id) ? 'Ø¥Ø¹Ø§Ø¯Ø©' : 'Ø§Ø¨Ø¯Ø£'} ğŸ¯ (${unitQuestionsCount > 0 ? unitQuestionsCount : 'ØªØ¬Ø±ÙŠØ¨ÙŠ'})
                          </button>
                        ` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      }
      
      // 7. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø³
      else if (currentScreen === 'lesson') {
        const unitQuestions = questions.filter(q => q.skill_id === gameState.currentUnit && q.city_id === gameState.currentCastle && q.grade === gameState.selectedGrade);
        
        // Ø¨Ø¯Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
        if (gameState.currentUnit) {
             gameState.pendingQuestionsPromise = supabaseSdk.loadLevelQuestions(gameState.currentUnit, gameState.selectedGrade, gameState.currentCastle);
        }

        const currentCastleData = learningCastles.find(c => (c.id === gameState.currentUnit || c.__backendId === gameState.currentUnit));
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
        const videoInfo = processYouTubeUrl(currentCastleData?.video_url || '');
        let videoHtml = '';
        
        if (videoInfo.videoId) {
            let embedUrl = `https://www.youtube.com/embed/${videoInfo.videoId}`;
            const params = new URLSearchParams({
                'rel': 0,
                'modestbranding': 1,
                'controls': 1,
                'showinfo': 0,
                'enablejsapi': 1
            });
            
            if (videoInfo.playlistId) {
                params.append('list', videoInfo.playlistId);
            }
            
            embedUrl += '?' + params.toString();
            
            videoHtml = `
              <div class="mb-6 rounded-xl overflow-hidden shadow-lg border-2 border-gray-600 relative" style="padding-top: 56.25%;">
                <iframe
                  id="lessonVideo"
                  src="${embedUrl}"
                  style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
                </iframe>
              </div>
              ${videoInfo.playlistId ? `
                <div style="background-color: ${bgColor}; padding: 12px; border-radius: 12px; margin-bottom: 24px; text-align: center; border: 1px solid ${cardColor};">
                    <p style="color: ${textColor}; margin-bottom: 8px; font-size: ${baseFontSize * 0.875}px;">ğŸ”— Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø²Ø¡ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„</p>
                    <a href="https://www.youtube.com/playlist?list=${videoInfo.playlistId}" 
                       target="_blank" style="color: ${primaryColor}; text-decoration: underline; font-weight: bold; font-size: ${baseFontSize}px;">
                        ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                    </a>
                </div>
              ` : ''}
            `;
        } else {
             videoHtml = `
                  <div class="p-8 mb-6 bg-gray-800 rounded-xl">
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù…ØªØ§Ø­ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù„Ø¹Ø©</p>
                  </div>
             `;
        }
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-3xl mx-auto">
              <div class="flex items-center justify-between mb-6">
                <button onclick="backToCastle()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ù„Ø§Ø¹
                </button>
                <button onclick="logout()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                </button>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 text-center slide-in">
                <h2 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-4">ğŸ° ${currentCastleData?.title || 'Ø§Ù„Ù‚Ù„Ø¹Ø©'}</h2>
                <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="mb-6 opacity-80">ğŸ¯ ${currentCastleData?.learning_outcome || 'ØªØ¹Ù„Ù… ÙˆØ§Ø³ØªÙ…ØªØ¹!'}</p>
                
                ${videoHtml}
                
                <div style="background-color: ${primaryColor}20; border: 2px solid ${primaryColor};" class="rounded-xl p-4 mb-6">
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">
                    ğŸ“ ${unitQuestions.length > 10 ? 10 : unitQuestions.length} Ø³Ø¤Ø§Ù„ ÙŠÙ†ØªØ¸Ø±Ùƒ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠ
                  </p>
                </div>
                
                <button id="startBtn" onclick="startChallenge()" disabled
                  style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                  class="w-full py-4 rounded-lg font-bold transition-all opacity-50 cursor-not-allowed">
                  â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ (ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©)
                </button>
              </div>
            </div>
          </div>
        `;
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… YouTube API
        setTimeout(() => {
            if (!videoInfo.videoId) {
                 const btn = document.getElementById('startBtn');
                 if(btn) {
                     btn.disabled = false;
                     btn.classList.remove('opacity-50', 'cursor-not-allowed');
                     btn.textContent = 'â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ';
                 }
                 return;
            }

            const initYT = () => {
                try {
                    new YT.Player('lessonVideo', {
                        events: {
                            'onStateChange': window.onPlayerStateChange,
                            'onError': window.onPlayerError
                        }
                    });
                } catch(e) { console.error("YT init error", e); }
            };

            if (window.YT && window.YT.Player) {
                initYT();
            } else {
                if (!document.getElementById('yt-api-script')) {
                    const tag = document.createElement('script');
                    tag.id = 'yt-api-script';
                    tag.src = "https://www.youtube.com/iframe_api";
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                    window.onYouTubeIframeAPIReady = initYT;
                }
            }
        }, 500);
      }
      
      // 8. Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„ØªØ­Ø¯ÙŠ)
      else if (currentScreen === 'challenge') {
        const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
        const progress = ((gameState.currentQuestionIndex + 1) / gameState.currentQuestions.length * 100).toFixed(0);
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-3xl mx-auto">
              <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <div style="background-color: ${cardColor};" class="px-6 py-3 rounded-lg">
                  <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">
                    Ø§Ù„Ø³Ø¤Ø§Ù„ ${gameState.currentQuestionIndex + 1} Ù…Ù† ${gameState.currentQuestions.length}
                  </span>
                </div>
                <div class="flex items-center gap-2 flex-wrap justify-center">
                  <div style="background-color: ${cardColor};" class="px-6 py-3 rounded-lg">
                    <div class="flex items-center gap-2">
                      <span style="font-size: ${baseFontSize}px;">â±ï¸</span>
                      <span id="timerDisplay" style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">45</span>
                    </div>
                  </div>
                  <div style="background-color: ${cardColor};" class="px-6 py-3 rounded-lg">
                    <div class="flex items-center gap-2">
                      <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">Ø§Ù„ØªÙ‚Ø¯Ù…:</span>
                      <span style="font-size: ${baseFontSize}px; color: ${primaryColor};" class="font-bold">${progress}%</span>
                    </div>
                  </div>
                  <button onclick="refreshChallengeState()" 
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all"
                    title="ØªØ­Ø¯ÙŠØ«">
                    ğŸ”„
                  </button>
                  <button onclick="toggleMute()" id="muteBtn"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ${isMuted ? 'ğŸ”‡' : 'ğŸ”Š'}
                  </button>
                  <button onclick="finishQuizEarly()"
                    style="background-color: #ef4444; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    Ø¥Ù†Ù‡Ø§Ø¡ â¹ï¸
                  </button>
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>
              
              <div style="background-color: ${cardColor}; height: 8px; border-radius: 999px;" class="mb-6">
                <div style="background-color: ${primaryColor}; width: ${progress}%; height: 100%; border-radius: 999px; transition: width 0.3s ease;"></div>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 mb-6 slide-in">
                <div id="question-timer" class="mb-3 font-bold text-yellow-400 text-lg text-center"></div>
                <div class="flex items-center gap-3 mb-6">
                  ${currentQ.reading_text ? `
                    <div style="background-color: ${primaryColor};" class="px-3 py-1 rounded-full">
                      <span style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="font-bold">ğŸ“– Ù†Øµ Ù…Ù‚Ø±ÙˆØ¡</span>
                    </div>
                  ` : ''}
                  <div style="background-color: ${currentQ.difficulty_level === 'easy' ? '#10b981' : currentQ.difficulty_level === 'medium' ? '#f59e0b' : '#ef4444'};" 
                    class="w-3 h-3 rounded-full"></div>
                  <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">
                    ${currentQ.difficulty_level === 'easy' ? 'Ø³Ù‡Ù„' : currentQ.difficulty_level === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'ØµØ¹Ø¨'}
                  </span>
                  <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">â€¢ ${currentQ.points_value} Ù†Ù‚Ø·Ø©</span>
                </div>
                
                ${currentQ.reading_text ? `
                  <button
                    onclick="openReadingModal(gameState.currentQuestions[gameState.currentQuestionIndex])"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="mb-4 px-4 py-2 rounded-xl font-bold hover:opacity-90 transition-all w-full flex justify-center items-center gap-2">
                    <span>ğŸ“–</span>
                    <span>Ø¥Ø¹Ø§Ø¯Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ</span>
                  </button>
                  <div style="background-color: ${bgColor};" class="rounded-xl p-6 mb-6 max-h-60 overflow-y-auto border-2 border-dashed border-gray-600">
                    <h4 style="font-size: ${baseFontSize * 1.125}px; color: ${primaryColor};" class="font-bold mb-2 text-center">${currentQ.reading_title || 'Ø§Ù‚Ø±Ø£ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ'}</h4>
                    <p style="font-size: ${baseFontSize}px; color: ${textColor}; line-height: 1.8;" class="whitespace-pre-wrap text-justify">${currentQ.reading_text}</p>
                  </div>
                ` : ''}

                <div class="text-center mb-8">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-4">ğŸ¤”</div>
                  ${currentQ.question_text.startsWith('data:image') ?
                    `<img src="${currentQ.question_text}" onclick="openImageZoom(this.src)" class="max-w-full h-auto rounded-lg mx-auto border-2 border-gray-600 cursor-zoom-in hover:opacity-90 transition-opacity" style="max-height: 300px;" alt="Ø³Ø¤Ø§Ù„">` :
                    `<div id="questionDisplay" class="font-bold"></div>`
                  }
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  ${[
                    {key: 'A', text: currentQ.answer_a},
                    {key: 'B', text: currentQ.answer_b},
                    {key: 'C', text: currentQ.answer_c},
                    {key: 'D', text: currentQ.answer_d}
                  ].map((answer, idx) => `
                    <button onclick="selectAnswer('${answer.key}')" id="answerBtn${answer.key}"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px; font-family: 'Tajawal', sans-serif;"
                      class="py-4 px-4 rounded-xl font-bold hover:opacity-80 transition-all border-4 border-transparent flex items-center gap-4">
                      <span style="background-color: ${primaryColor}; color: ${textColor};" class="w-10 h-10 flex items-center justify-center rounded-full font-bold text-lg flex-shrink-0">${answer.key}</span>
                      <div id="answerText${answer.key}" class="flex-1 text-right">${answer.text}</div>
                    </button>
                  `).join('')}
                </div>
              </div>
              
              ${currentQ.explanation ? `
                <div style="background-color: ${cardColor};" class="rounded-xl p-4 mb-6" id="hintBox">
                  <div class="flex items-start gap-3">
                    <div style="font-size: ${baseFontSize * 1.5}px;">ğŸ’¡</div>
                    <div>
                      <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold mb-1">ØªÙ„Ù…ÙŠØ­ Ù…Ù† ${guideName}:</div>
                      <p style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-80">${currentQ.explanation}</p>
                    </div>
                  </div>
                </div>
              ` : ''}
              
              <button onclick="submitAnswer()" id="submitAnswerBtn"
                style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                class="w-full py-4 rounded-lg font-bold opacity-50 cursor-not-allowed transition-all"
                disabled>
                ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© âœ“
              </button>
            </div>
          </div>
        `;
      }
      
      // 9. Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      else if (currentScreen === 'results') {
        const percentage = (gameState.correctAnswers / gameState.currentQuestions.length * 100).toFixed(0);
        const stars = percentage >= 90 ? 3 : percentage >= 70 ? 2 : percentage >= 50 ? 1 : 0;
        const totalPoints = gameState.currentQuestions.reduce((sum, q) => sum + (q.points_value || 0), 0);
        const earnedPoints = Math.round(totalPoints * (percentage / 100));
        const isPassed = percentage >= 50;
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆÙ†ÙÙŠØªÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¬ÙŠØ¯Ø©
        if (isPassed) {
          setTimeout(() => { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }, 300);
        }

        content = `
          <div class="flex items-center justify-center min-h-full p-4" style="background-color: ${bgColor};">
            <div class="w-full max-w-2xl">
              <div style="background-color: ${cardColor};" class="rounded-2xl p-8 text-center slide-in">
                <div style="font-size: ${baseFontSize * 5}px;" class="mb-6 float-animation">
                  ${percentage >= 70 ? 'ğŸ‰' : percentage >= 50 ? 'ğŸ‘' : 'ğŸ’ª'}
                </div>
                <h2 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-4">
                  ${percentage >= 70 ? 'Ø£Ø­Ø³Ù†Øª!' : percentage >= 50 ? 'Ø¬ÙŠØ¯!' : 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'}
                </h2>
                <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="mb-8 opacity-80">
                  ${percentage >= 70 ? 'Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ù†Ø¬Ø§Ø­!' : percentage >= 50 ? 'Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³ÙŠÙ†!' : 'Ù„Ø§ ØªØ³ØªØ³Ù„Ù…! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'}
                </p>
                
                <div class="grid grid-cols-3 gap-4 mb-8">
                  <div style="background-color: ${bgColor};" class="rounded-xl p-4">
                    <div style="font-size: ${baseFontSize * 2}px;" class="mb-2">â­</div>
                    <div style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-1">${stars}</div>
                    <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-80">Ù†Ø¬ÙˆÙ…</div>
                  </div>
                  <div style="background-color: ${bgColor};" class="rounded-xl p-4">
                    <div style="font-size: ${baseFontSize * 2}px;" class="mb-2">ğŸ†</div>
                    <div style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-1">+${earnedPoints}</div>
                    <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-80">Ù†Ù‚Ø·Ø©</div>
                  </div>
                  <div style="background-color: ${bgColor};" class="rounded-xl p-4">
                    <div style="font-size: ${baseFontSize * 2}px;" class="mb-2">âœ“</div>
                    <div style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-1">${gameState.correctAnswers}/${gameState.currentQuestions.length}</div>
                    <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-80">ØµØ­ÙŠØ­Ø©</div>
                  </div>
                </div>
                
                <div style="background-color: ${bgColor};" class="rounded-xl p-6 mb-8 inline-block">
                  <div style="font-size: ${baseFontSize * 3}px; color: ${primaryColor};" class="font-bold">${percentage}%</div>
                  <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                </div>
                
                ${percentage >= 70 ? `
                  <div style="background-color: ${primaryColor}20; border: 2px solid ${primaryColor};" class="rounded-xl p-6 mb-8">
                    <div style="font-size: ${baseFontSize * 2.5}px;" class="mb-3">âœ…</div>
                    <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold">ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!</p>
                  </div>
                ` : ''}
                
                <div class="flex gap-4 flex-wrap">
                  <button onclick="backToCastle()"
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="flex-1 py-4 rounded-lg font-bold hover:opacity-80 transition-all">
                    Ø§Ù„Ù‚Ù„Ø§Ø¹
                  </button>
                  <button id="share_report_btn"
                    style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                    ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                  </button>
                  <button onclick="shareToWhatsApp()"
                    style="background-color: #25D366; color: white; font-size: ${baseFontSize}px;"
                    class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                    Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬
                  </button>
                  ${percentage >= 70 ? `
                    <button id="certificate_btn"
                      style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                      ğŸ† ØªØ­Ù…ÙŠÙ„ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                    </button>
                  ` : ''}
                  ${percentage < 70 ? `
                    <button onclick="retryUnit()"
                      style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                      Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ”„
                    </button>
                  ` : ''}
                  <button onclick="backToSubjects()"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                    Ø§Ù„Ù…ÙˆØ§Ø¯ ğŸ›ï¸
                  </button>
                </div>
                
                <pre id="level_report" style="font-size: ${baseFontSize * 0.875}px; color: ${textColor}; white-space: pre-wrap; text-align: right; margin-top: 1rem;"></pre>
                
                <div class="mt-6">
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="w-full py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 10. Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…
      else if (currentScreen === 'admin') {
        const currentGrade = currentUser?.grade || 'grade3';
        const castleQuestions = questions
          .filter(q => q.city_id === gameState.selectedCity && q.grade === currentGrade)
          .reverse(); // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        
        const subjectName = gameState.selectedCity ? gameState.selectedCity.replace('_test', '') : '';
        const castleUnits = gameState.selectedCity ? learningCastles
          .filter(c => c.subject === subjectName && c.grade === currentGrade)
          .sort((a, b) => (a.order_index || 0) - (b.order_index || 0))
          .map(c => ({ id: c.id || c.__backendId, name: c.title })) : [];

        const arabicReadingTexts = readingTexts.filter(r => r.subject === 'arabic');
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-6xl mx-auto">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… ğŸ‘¨â€ğŸ«</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</p>
                </div>
                <div class="flex flex-wrap gap-3 w-full md:w-auto">
                  <button onclick="goToLearningOutcomes()"
                    style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-4 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… ğŸ¯
                  </button>
                  <button onclick="promptUpgrade()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-4 py-3 rounded-lg font-semibold hover:opacity-80 transition-all"
                    title="ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨">
                    ğŸ”‘
                  </button>
                  <select id="adminGradeSelect" onchange="changeAdminGrade(this.value)"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-4 py-3 rounded-lg outline-none">
                    <option value="grade3" ${currentUser?.grade === 'grade3' ? 'selected' : ''}>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    <option value="grade6" ${currentUser?.grade === 'grade6' ? 'selected' : ''}>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                    <option value="grade9" ${currentUser?.grade === 'grade9' ? 'selected' : ''}>Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</option>
                  </select>
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.25}px; color: ${textColor};" class="font-bold mb-4">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  ${Object.values(islands).flatMap(island => island.cities).map(city => `
                    <button onclick="selectCityForAdmin('${city.id}')" id="adminCityBtn${city.id}"
                      style="background-color: ${bgColor}; color: ${textColor}; border-color: ${gameState.selectedCity === city.id ? primaryColor : 'transparent'}; font-size: ${baseFontSize}px;"
                      class="p-4 rounded-xl font-semibold hover:opacity-80 transition-all border-2">
                      <div style="font-size: ${baseFontSize * 2}px;" class="mb-2">${city.emoji}</div>
                      <div>${city.name}</div>
                    </button>
                  `).join('')}
                </div>
              </div>
              
              ${gameState.selectedCity ? `
                <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                  <div class="flex flex-col md:flex-row items-center justify-between mb-4 gap-4">
                    <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold text-center md:text-right">
                      â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© - ${Object.values(islands).flatMap(i => i.cities).find(c => c.id === gameState.selectedCity)?.name}
                    </h3>
                    <div class="flex flex-wrap justify-center gap-2 w-full md:w-auto">
                      <button onclick="toggleReadingPassageForm()" id="toggleReadingBtn"
                        style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                        class="px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-all flex-1 md:flex-none whitespace-nowrap">
                        ğŸ“– Ù†Øµ Ù…Ù‚Ø±ÙˆØ¡
                      </button>
                      <button onclick="triggerJsonImport()"
                        style="background-color: #8b5cf6; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                        class="px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-all flex-1 md:flex-none whitespace-nowrap">
                        ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯
                      </button>
                      <button onclick="toggleBulkForm()" id="toggleBulkBtn"
                        style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                        class="px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-all flex-1 md:flex-none whitespace-nowrap">
                        ğŸ“‹ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ¹Ø¯Ø¯Ø©
                      </button>
                    </div>
                  </div>
                  
                  <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJsonImport(event)">

                  <!-- Reading Passage Form -->
                  <div id="readingPassageFormContainer" class="collapsible-content mb-6">
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6">
                      <h4 style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold mb-4">ğŸ“– Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ù…Ù‚Ø±ÙˆØ¡ ÙˆÙ…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø³Ø¦Ù„Ø©</h4>
                      <form id="readingPassageForm" onsubmit="saveReadingPassageWithQuestions(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                          <div>
                            <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ù‚Ù„Ø¹Ø© (Ø§Ù„ÙˆØ­Ø¯Ø©) *</label>
                            <select id="readingUnitId" required
                              style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                              class="w-full px-4 py-3 rounded-lg outline-none">
                              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù„Ø¹Ø©</option>
                              ${castleUnits.map(unit => `
                                <option value="${unit.id}">${unit.name}</option>
                              `).join('')}
                            </select>
                          </div>
                          <div>
                            <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Øµ *</label>
                            <input type="text" id="readingPassageTitle" required
                              style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                              class="w-full px-4 py-3 rounded-lg outline-none"
                              placeholder="Ù…Ø«Ø§Ù„: Ù‚ØµØ© Ø§Ù„Ø£Ø±Ù†Ø¨ ÙˆØ§Ù„Ø³Ù„Ø­ÙØ§Ø©">
                          </div>
                        </div>
                        
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ *</label>
                          
                          <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ -->
                          <div class="flex flex-wrap gap-2 mb-2">
                            <button type="button" onclick="insertFormat('<b>', '</b>')" title="Ø®Ø· Ø¹Ø±ÙŠØ¶"
                              style="background-color: ${cardColor}; color: ${textColor}; border: 1px solid ${textColor};"
                              class="px-3 py-1 rounded hover:opacity-80 font-bold">B</button>
                            <button type="button" onclick="insertFormat('<u>', '</u>')" title="ØªØ³Ø·ÙŠØ±"
                              style="background-color: ${cardColor}; color: ${textColor}; border: 1px solid ${textColor}; text-decoration: underline;"
                              class="px-3 py-1 rounded hover:opacity-80">U</button>
                            <button type="button" onclick="insertFormat('<span style=\\'color: #ef4444\\'>', '</span>')" title="Ù„ÙˆÙ† Ø£Ø­Ù…Ø±"
                              style="background-color: ${cardColor}; color: #ef4444; border: 1px solid #ef4444;"
                              class="px-3 py-1 rounded hover:opacity-80 font-bold">A</button>
                            <button type="button" onclick="insertFormat('<span style=\\'color: #3b82f6\\'>', '</span>')" title="Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚"
                              style="background-color: ${cardColor}; color: #3b82f6; border: 1px solid #3b82f6;"
                              class="px-3 py-1 rounded hover:opacity-80 font-bold">A</button>
                            <button type="button" onclick="insertFormat('<span style=\\'background-color: #f59e0b; color: black; padding: 0 4px; border-radius: 4px;\\'>', '</span>')" title="ØªÙ…ÙŠÙŠØ² Ù†Øµ"
                              style="background-color: #f59e0b; color: black; border: 1px solid #f59e0b;"
                              class="px-3 py-1 rounded hover:opacity-80 font-bold">H</button>
                          </div>

                          <textarea id="readingPassageContent" required rows="6"
                            style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                            class="w-full px-4 py-3 rounded-lg outline-none"
                            placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
                        </div>

                        <div class="border-t border-gray-600 my-4 pt-4">
                          <div class="flex justify-between items-center mb-4">
                            <h5 style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù†Øµ</h5>
                            <button type="button" onclick="addQuestionFieldToPassage()"
                              style="background-color: ${bgColor}; border: 1px solid ${textColor}; color: ${textColor};"
                              class="px-3 py-1 rounded-lg hover:opacity-80">
                              + Ø³Ø¤Ø§Ù„ Ø¥Ø¶Ø§ÙÙŠ
                            </button>
                          </div>
                          
                          <div id="passageQuestionsList" class="space-y-4">
                            <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                          </div>
                        </div>
                        
                        <button type="submit" id="saveReadingPassageBtn"
                          style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                          class="w-full py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                          ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©
                        </button>
                      </form>
                    </div>
                  </div>

                  <div id="bulkFormContainer" class="collapsible-content mb-6">
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6">
                      <h4 style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold mb-4">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</h4>
                      <form id="bulkQuestionForm" onsubmit="processBulkQuestions(event)" class="space-y-4">
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù„Ø¹Ø© *</label>
                          <select id="bulkUnitId" required
                            style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                            class="w-full px-4 py-3 rounded-lg outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù„Ø¹Ø©</option>
                            ${castleUnits.map(unit => `
                              <option value="${unit.id}">${unit.name}</option>
                            `).join('')}
                          </select>
                        </div>
                        
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ:</label>
                          <div style="background-color: ${cardColor};" class="rounded-lg p-3 mb-2">
                            <pre style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-70 whitespace-pre-wrap">Ù…Ø«Ø§Ù„ Ù…Ø±Ù† Ù„Ù„ØªØ±Ù‚ÙŠÙ…:

Ø§Ù„Ø³Ø¤Ø§Ù„ 1: Ù…Ø§ Ù†Ø§ØªØ¬ 5 + 3 = ØŸ
Ø£) 6
Ø¨) 7
Ø¬) 8
Ø¯) 9
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: Ø¬

Ø³2 Ù…Ø§ Ù†Ø§ØªØ¬ 10 - 4 = ØŸ
Ø£) 4
Ø¨) 5
Ø¬) 6
Ø¯) 7
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: Ø¬

3- Ù…Ø§ Ù†Ø§ØªØ¬ 7 Ã— 2 = ØŸ
A) 12
B) 14
C) 16
D) 18
Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: B

âœ¨ Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…:
â€¢ "Ø§Ù„Ø³Ø¤Ø§Ù„ 1:" Ø£Ùˆ "Ø§Ù„Ø³Ø¤Ø§Ù„:"
â€¢ "Ø³1:" Ø£Ùˆ "Ø³:"
â€¢ "1." Ø£Ùˆ "1-" Ø£Ùˆ "1:"
â€¢ Ø£ÙŠ Ø³Ø·Ø± ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ "ØŸ"

Ø§Ù„Ù†Ù‚Ø§Ø· (10) ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ</pre>
                          </div>
                          <textarea id="bulkQuestionsText" required rows="8"
                            style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                            class="w-full px-4 py-3 rounded-lg outline-none font-mono"
                            placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§..."></textarea>
                        </div>
                        
                        <button type="submit" id="processBulkBtn"
                          style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                          class="w-full py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                          ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                        </button>
                      </form>
                    </div>
                  </div>
                  
                  <div id="singleFormContainer">
                    <div class="space-y-4">
                      <div class="grid md:grid-cols-3 gap-4">
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                          <select id="gradeSelect" onchange="onGradeChange()" style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                          </select>
                        </div>
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)</label>
                          <select id="subjectSelect" onchange="onSubjectChange()" disabled style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                          </select>
                        </div>
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ù‚Ù„Ø¹Ø© (Ø§Ù„Ù…Ù‡Ø§Ø±Ø©)</label>
                          <select id="skillSelect" disabled style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù„Ø¹Ø©</option>
                          </select>
                        </div>
                      </div>

                      <div class="bg-opacity-10 bg-black p-4 rounded-lg">
                        <div class="flex gap-6 mb-4 border-b border-gray-600 pb-2">
                           <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                              <input type="radio" name="qType" value="image" checked onchange="toggleQType(this.value)" class="w-4 h-4 text-blue-600">
                              <span style="color: ${textColor}; font-weight: bold;">ğŸ“¸ ØµÙˆØ±Ø©</span>
                           </label>
                           <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                              <input type="radio" name="qType" value="text" onchange="toggleQType(this.value)" class="w-4 h-4 text-blue-600">
                              <span style="color: ${textColor}; font-weight: bold;">âœï¸ Ù†Øµ</span>
                           </label>
                        </div>
                        
                        <div id="imageInputContainer">
                            <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ *</label>
                            <input type="file" id="questionImage" accept="image/*" style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none">
                        </div>
                        <div id="textInputContainer" style="display: none;">
                            <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ *</label>
                            <textarea id="questionTextSingle" rows="3" style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..."></textarea>
                        </div>
                      </div>

                      <div class="grid md:grid-cols-2 gap-4">
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø®ÙŠØ§Ø± Ø£ *</label>
                          <input type="text" id="newAnswerA" required style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">
                        </div>
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø®ÙŠØ§Ø± Ø¨ *</label>
                          <input type="text" id="newAnswerB" required style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                        </div>
                      </div>
                      <div class="grid md:grid-cols-2 gap-4">
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø®ÙŠØ§Ø± Ø¬ *</label>
                          <input type="text" id="newAnswerC" required style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©">
                        </div>
                        <div>
                          <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø®ÙŠØ§Ø± Ø¯ *</label>
                          <input type="text" id="newAnswerD" required style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©">
                        </div>
                      </div>

                      <div>
                        <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© *</label>
                        <select id="newCorrectAnswer" required style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;" class="w-full px-4 py-3 rounded-lg outline-none">
                          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</option>
                          <option value="A">Ø§Ù„Ø®ÙŠØ§Ø± Ø£</option>
                          <option value="B">Ø§Ù„Ø®ÙŠØ§Ø± Ø¨</option>
                          <option value="C">Ø§Ù„Ø®ÙŠØ§Ø± Ø¬</option>
                          <option value="D">Ø§Ù„Ø®ÙŠØ§Ø± Ø¯</option>
                        </select>
                      </div>

                      <button onclick="uploadQuestionImage()" id="uploadQuestionBtn" style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;" class="w-full py-4 rounded-lg font-bold hover:opacity-90 transition-all pulse-glow">
                        âœ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„
                      </button>
                    </div>
                  </div>
                </div>
                
                <div style="background-color: ${cardColor};" class="rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold">
                      ğŸ“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (${castleQuestions.length})
                    </h3>
                  </div>
                  
                  ${castleQuestions.length === 0 ? `
                    <div class="text-center py-8">
                      <div style="font-size: ${baseFontSize * 3}px;" class="mb-4 opacity-50">ğŸ“­</div>
                      <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¨Ø¹Ø¯</p>
                    </div>
                  ` : `
                    <div class="space-y-3">
                      ${castleQuestions.map((q, index) => {
                        const difficultyEmoji = q.difficulty_level === 'easy' ? 'ğŸŸ¢' : q.difficulty_level === 'medium' ? 'ğŸŸ¡' : 'ğŸ”´';
                        return `
                          <div style="background-color: ${bgColor};" class="rounded-xl p-4">
                            <div class="flex flex-col md:flex-row items-start justify-between gap-4">
                              <div class="flex-1 w-full">
                                ${q.reading_title ? `
                                  <div class="mb-2">
                                    <span style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.75}px;" class="px-2 py-1 rounded-md font-bold inline-flex items-center gap-1">
                                      ğŸ“– ${q.reading_title}
                                    </span>
                                  </div>
                                  ${q.reading_text ? `
                                    <div style="background-color: ${cardColor}; border: 1px solid ${textColor}40;" class="rounded-lg p-3 mb-3 mt-1">
                                      <p style="font-size: ${baseFontSize * 0.875}px; color: ${textColor}; opacity: 0.9;" class="line-clamp-3">
                                        ${q.reading_text.substring(0, 150)}${q.reading_text.length > 150 ? '...' : ''}
                                      </p>
                                    </div>
                                  ` : ''}
                                ` : ''}
                                <div class="flex items-center gap-2 mb-2">
                                  <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">${index + 1}.</span>
                                  ${q.question_text.startsWith('data:image') ? 
                                    `<img src="${q.question_text}" onclick="openImageZoom(this.src)" class="w-24 h-auto rounded-md border border-gray-500 cursor-zoom-in hover:opacity-80" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„">` :
                                    `<span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">${q.question_text}</span>`
                                  }
                                </div>
                                <div class="flex items-center gap-3 flex-wrap">
                                  <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">${difficultyEmoji} ${q.difficulty_level}</span>
                                  <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">ğŸ† ${q.points_value} Ù†Ù‚Ø·Ø©</span>
                                  <span style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">âœ… ${q.correct_answer}</span>
                                </div>
                              </div>
                              <div class="flex gap-2 w-full md:w-auto justify-end mt-2 md:mt-0">
                                <button onclick="editQuestion('${q.__backendId}')"
                                  style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                                  class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all flex-1 md:flex-none">
                                  âœï¸ ØªØ¹Ø¯ÙŠÙ„
                                </button>
                                <button onclick="deleteQuestion('${q.__backendId}')"
                                  style="background-color: #ef4444; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                                  class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all flex-1 md:flex-none">
                                  ğŸ—‘ï¸ Ø­Ø°Ù
                                </button>
                              </div>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  `}
                </div>
              ` : `
                <div style="background-color: ${cardColor};" class="rounded-2xl p-8 text-center">
                  <div style="font-size: ${baseFontSize * 4}px;" class="mb-4">ğŸ‘¨â€ğŸ«</div>
                  <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser?.full_name || 'Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…'}!</p>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      // 11. Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      else if (currentScreen === 'admin_panel') {
        const teacherUsers = users.filter(u => u.user_type === 'teacher');
        const approvedTeachers = teacherUsers.filter(t => t.is_approved);
        const unusedCodes = teacherCodes.filter(c => !c.is_used);
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-6xl mx-auto">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ‘‘</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>
                </div>
                <button onclick="syncWithSupabase()"
                  style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Supabase
                </button>
                <button onclick="logout()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                </button>
              </div>
              
              <div class="grid md:grid-cols-4 gap-4 mb-8">
                <div style="background-color: ${cardColor};" class="rounded-xl p-6 text-center">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">ğŸ‘¥</div>
                  <div style="font-size: ${baseFontSize * 2}px; color: ${primaryColor};" class="font-bold mb-2">${users.length}</div>
                  <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                </div>
                
                <div style="background-color: ${cardColor};" class="rounded-xl p-6 text-center">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">ğŸ‘¨â€ğŸ«</div>
                  <div style="font-size: ${baseFontSize * 2}px; color: ${secondaryColor};" class="font-bold mb-2">${approvedTeachers.length}</div>
                  <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†</div>
                </div>
                
                <div style="background-color: ${cardColor};" class="rounded-xl p-6 text-center">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">ğŸŸï¸</div>
                  <div style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">${unusedCodes.length}</div>
                  <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø£ÙƒÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø©</div>
                </div>
                
                <div style="background-color: ${cardColor};" class="rounded-xl p-6 text-center">
                  <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">ğŸ“</div>
                  <div style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">${questions.length}</div>
                  <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                </div>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">ğŸ¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±</h3>
                <div class="grid md:grid-cols-3 gap-4">
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                    <select onchange="updateAppConfig('font_family', this.value)"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none">
                      <option value="Cairo" ${window.elementSdk.config.font_family === 'Cairo' ? 'selected' : ''}>Cairo (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                      <option value="Tajawal" ${window.elementSdk.config.font_family === 'Tajawal' ? 'selected' : ''}>Tajawal</option>
                      <option value="Tahoma" ${window.elementSdk.config.font_family === 'Tahoma' ? 'selected' : ''}>Tahoma</option>
                      <option value="Segoe UI" ${window.elementSdk.config.font_family === 'Segoe UI' ? 'selected' : ''}>Segoe UI</option>
                    </select>
                  </div>
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø­Ø¬Ù… Ø§Ù„Ø®Ø· (px)</label>
                    <input type="number" min="14" max="30" value="${baseFontSize}"
                      onchange="updateAppConfig('font_size', this.value)"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none">
                  </div>
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„ÙˆØ¶Ø¹ (Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ)</label>
                    <select onchange="toggleTheme(this.value)"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none">
                      <option value="dark" ${window.elementSdk.config.background_color === '#1e293b' ? 'selected' : ''}>ğŸŒ™ Ù„ÙŠÙ„ÙŠ</option>
                      <option value="light" ${window.elementSdk.config.background_color !== '#1e293b' ? 'selected' : ''}>â˜€ï¸ Ù†Ù‡Ø§Ø±ÙŠ</option>
                    </select>
                  </div>
                </div>
              </div>

              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">ğŸ« Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø¹Ù„Ù…</h3>
                <form onsubmit="generateTeacherCode(event)" class="flex gap-3">
                  <input type="number" id="codeCount" min="1" max="10" value="1"
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-4 py-3 rounded-lg outline-none w-32"
                    placeholder="Ø¹Ø¯Ø¯">
                  <button type="submit"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="flex-1 py-3 rounded-lg font-bold hover:opacity-90 transition-all">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒÙˆØ§Ø¯ ØªÙØ¹ÙŠÙ„ âœ¨
                  </button>
                </form>
              </div>
              
              ${unusedCodes.length > 0 ? `
                <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                  <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">ğŸŸï¸ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø© (${unusedCodes.length})</h3>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    ${unusedCodes.map(code => `
                      <div style="background-color: ${bgColor};" class="rounded-xl p-4 text-center">
                        <div style="font-size: ${baseFontSize * 1.5}px; color: ${primaryColor};" class="font-bold mb-2 font-mono">${code.code}</div>
                        <button onclick="copyCode('${code.code}')"
                          style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                          class="w-full py-2 rounded-lg font-semibold hover:opacity-80 transition-all">
                          Ù†Ø³Ø® ğŸ“‹
                        </button>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ† (${approvedTeachers.length})</h3>
                ${approvedTeachers.length === 0 ? `
                  <div class="text-center py-8">
                    <div style="font-size: ${baseFontSize * 3}px;" class="mb-4 opacity-50">ğŸ‘¨â€ğŸ«</div>
                    <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ù„Ù…ÙˆÙ† Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†</p>
                  </div>
                ` : `
                  <div class="space-y-3">
                    ${approvedTeachers.map(teacher => `
                      <div style="background-color: ${bgColor};" class="rounded-xl p-4">
                        <div class="flex items-center justify-between gap-4">
                          <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                              <span style="font-size: ${baseFontSize * 1.5}px;">âœ…</span>
                              <div>
                                <div style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold">${teacher.full_name}</div>
                                <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="opacity-70">@${teacher.username}</div>
                              </div>
                            </div>
                            <div class="flex items-center gap-3 flex-wrap">
                              <span style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-70">
                                ğŸ“… ${new Date(teacher.created_at || teacher.last_login).toLocaleDateString('ar-SA')}
                              </span>
                            </div>
                          </div>
                          <button onclick="revokeTeacher('${teacher.__backendId}')"
                            style="background-color: #ef4444; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                            class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all">
                            Ø¥Ù„ØºØ§Ø¡ ğŸš«
                          </button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
              
              <div style="background-color: #7f1d1d20; border: 2px solid #ef4444;" class="rounded-2xl p-6 mt-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: #ef4444;" class="font-bold mb-4">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø± - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <p style="color: ${textColor}; margin-bottom: 16px; opacity: 0.8;">Ø§Ø­Ø°Ø±: Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!</p>
                <div class="flex flex-wrap gap-3">
                  <button onclick="clearTable('questions')"
                    style="background-color: #ef4444; color: white; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-bold hover:opacity-90 transition-all w-full md:w-auto">
                    ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                  </button>
                  <button onclick="clearTable('learning_castles')"
                    style="background-color: #ef4444; color: white; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-bold hover:opacity-90 transition-all w-full md:w-auto">
                    ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹
                  </button>
                  <button onclick="clearTable('users')"
                    style="background-color: #ef4444; color: white; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-bold hover:opacity-90 transition-all w-full md:w-auto">
                    ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ)
                  </button>
                  <button onclick="clearTable('student_questions_history')"
                    style="background-color: #ef4444; color: white; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-bold hover:opacity-90 transition-all w-full md:w-auto">
                    ğŸ—‘ï¸ Ø­Ø°Ù Ø³Ø¬Ù„ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // 12. ØªÙ‚Ø±ÙŠØ± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
      else if (currentScreen === 'parent_report') {
        const studentUsers = users.filter(u => u.user_type === 'student');
        const selectedStudent = gameState.selectedStudentId ? 
          users.find(u => u.user_id === gameState.selectedStudentId) : null;
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-5xl mx-auto">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ø§Ù„Ø¨</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="refreshDataManual()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-4 py-3 rounded-lg font-semibold hover:opacity-80 transition-all"
                    title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                    ğŸ”„ ØªØ­Ø¯ÙŠØ«
                  </button>
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.25}px; color: ${textColor};" class="font-bold mb-4">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                
                <div class="mb-4">
                  <input type="text" id="studentSearchInput" onkeyup="filterStudents()" 
                    style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="w-full px-4 py-3 rounded-lg outline-none border-2 border-transparent focus:border-blue-500 transition-all"
                    placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù…...">
                </div>

                <div id="studentsListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  ${studentUsers.length === 0 ? `
                    <div class="col-span-2 text-center py-8">
                      <div style="font-size: ${baseFontSize * 3}px;" class="mb-4 opacity-50">ğŸ‘¤</div>
                      <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                    </div>
                  ` : studentUsers.map(student => `
                    <button onclick="selectStudentForReport('${student.user_id}')" id="studentBtn${student.user_id}"
                      data-name="${student.username} ${student.full_name || ''}"
                      style="background-color: ${bgColor}; color: ${textColor}; border-color: ${selectedStudent?.user_id === student.user_id ? primaryColor : 'transparent'}; font-size: ${baseFontSize}px;"
                      class="student-card-btn p-4 rounded-xl font-semibold hover:opacity-80 transition-all border-2 text-right">
                      <div class="flex items-center gap-3">
                        <div style="font-size: ${baseFontSize * 2}px;">ğŸ“š</div>
                        <div>
                          <div style="font-size: ${baseFontSize * 1.125}px;" class="font-bold">${student.username}</div>
                          <div style="font-size: ${baseFontSize * 0.875}px;" class="opacity-70">
                            ${student.grade === 'grade3' ? 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«' : student.grade === 'grade6' ? 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³' : student.grade === 'grade9' ? 'Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                          </div>
                        </div>
                      </div>
                    </button>
                  `).join('')}
                </div>
              </div>
              
              ${selectedStudent ? `
                <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                  <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-6 text-center">
                    ğŸ“Š ØªÙ‚Ø±ÙŠØ±: ${selectedStudent.username}
                  </h3>
                  
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6 text-center">
                      <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">ğŸ†</div>
                      <div style="font-size: ${baseFontSize * 2}px; color: ${primaryColor};" class="font-bold mb-2">${selectedStudent.total_points || 0}</div>
                      <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
                    </div>
                    
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6 text-center">
                      <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">â­</div>
                      <div style="font-size: ${baseFontSize * 2}px; color: ${secondaryColor};" class="font-bold mb-2">${selectedStudent.stars_collected || 0}</div>
                      <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
                    </div>
                    
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6 text-center">
                      <div style="font-size: ${baseFontSize * 3}px;" class="mb-3">âœ…</div>
                      <div style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">${selectedStudent.skills_mastered || 0}</div>
                      <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
                    </div>
                  </div>
                  
                  <div style="background-color: ${bgColor};" class="rounded-xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                      <h4 style="font-size: ${baseFontSize * 1.25}px; color: ${textColor};" class="font-bold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©</h4>
                      <div style="background-color: ${primaryColor};" class="px-4 py-2 rounded-full">
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${selectedStudent.current_level || 1}</span>
                      </div>
                    </div>
                    
                    <div class="space-y-3">
                      <div class="flex items-center justify-between py-2 border-b" style="border-color: ${cardColor};">
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span>
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">
                          ${selectedStudent.grade === 'grade3' ? 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' : selectedStudent.grade === 'grade6' ? 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' : selectedStudent.grade === 'grade9' ? 'Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </span>
                      </div>
                      
                      <div class="flex items-center justify-between py-2 border-b" style="border-color: ${cardColor};">
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span>
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">
                          ${selectedStudent.semester === 'semester1' ? 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„' : selectedStudent.semester === 'semester2' ? 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ' : selectedStudent.semester === 'semester3' ? 'Ø¬Ø²ÙŠØ±Ø© Ù†Ø§ÙØ³' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </span>
                      </div>
                      
                      <div class="flex items-center justify-between py-2">
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„:</span>
                        <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">
                          ${selectedStudent.last_login ? new Date(selectedStudent.last_login).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  ${selectedStudent.progress_data && selectedStudent.progress_data !== '{}' ? `
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6">
                      <h4 style="font-size: ${baseFontSize * 1.25}px; color: ${textColor};" class="font-bold mb-4">ğŸ“ˆ ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</h4>
                      ${(() => {
                        try {
                          let progress = selectedStudent.progress_data;
                          if (typeof progress === 'string') {
                            try { progress = JSON.parse(progress); } catch(e) { progress = {}; }
                          }
                          
                          const completedSkills = (progress && progress.completedSkills) ? progress.completedSkills : [];
                          
                          if (completedSkills.length === 0) {
                            return `
                              <div class="text-center py-6">
                                <div style="font-size: ${baseFontSize * 2}px;" class="mb-3 opacity-50">ğŸ“</div>
                                <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ù… ÙŠÙƒÙ…Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£ÙŠ Ù‚Ù„Ø§Ø¹ Ø¨Ø¹Ø¯</p>
                              </div>
                            `;
                          }
                          
                          return `
                            <div class="space-y-3">
                              ${completedSkills.map((skillId, index) => `
                                <div style="background-color: ${cardColor};" class="rounded-lg p-4 flex items-center gap-3">
                                  <div style="background-color: ${primaryColor};" class="w-10 h-10 rounded-full flex items-center justify-center">
                                    <span style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">${index + 1}</span>
                                  </div>
                                  <div class="flex-1">
                                    <div style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-semibold">Ù‚Ù„Ø¹Ø© Ù…ÙƒØªÙ…Ù„Ø©: ${skillId}</div>
                                  </div>
                                  <div style="font-size: ${baseFontSize * 1.5}px;">âœ…</div>
                                </div>
                              `).join('')}
                            </div>
                          `;
                        } catch (e) {
                          return `
                            <div class="text-center py-6">
                              <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø©</p>
                            </div>
                          `;
                        }
                      })()}
                    </div>
                  ` : `
                    <div style="background-color: ${bgColor};" class="rounded-xl p-6 text-center">
                      <div style="font-size: ${baseFontSize * 3}px;" class="mb-3 opacity-50">ğŸ“</div>
                      <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø­Ù„ØªÙ‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨Ø¹Ø¯</p>
                    </div>
                  `}
                </div>
                
                <div style="background-color: ${primaryColor}20; border: 2px solid ${primaryColor};" class="rounded-xl p-6 text-center">
                  <div style="font-size: ${baseFontSize * 2}px;" class="mb-3">ğŸ’¡</div>
                  <h4 style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold mb-2">Ù†ØµÙŠØ­Ø© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h4>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">
                    Ø´Ø¬Ø¹ Ø·ÙÙ„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø© ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù†ØµØ© Ø¨Ø´ÙƒÙ„ ÙŠÙˆÙ…ÙŠ. Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù‡Ùˆ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙÙˆÙ‚!
                  </p>
                </div>
              ` : `
                <div style="background-color: ${cardColor};" class="rounded-2xl p-8 text-center">
                  <div style="font-size: ${baseFontSize * 4}px;" class="mb-4">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                  <p style="font-size: ${baseFontSize * 1.125}px; color: ${textColor};" class="font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser?.full_name || 'ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±'}!</p>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ØªÙ‚Ø±ÙŠØ±Ù‡ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</p>
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      // 13. Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      else if (currentScreen === 'arabic_reading') {
        const arabicReadingTexts = readingTexts.filter(r => r.subject === 'arabic');
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-6xl mx-auto">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ - Ù…Ø§Ø¯Ø© Ù„ØºØªÙŠ ğŸ“–</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© ÙˆØ£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨</p>
                </div>
                <div class="flex gap-3">
                  <button onclick="goToTeacherAdmin()"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
                  </button>
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">â• Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ù…Ù‚Ø±ÙˆØ¡ Ø¬Ø¯ÙŠØ¯</h3>
                
                <form id="readingTextForm" onsubmit="addReadingText(event)" class="space-y-4">
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Øµ *</label>
                    <input type="text" id="readingTitle" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none"
                      placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡">
                  </div>
                  
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ *</label>
                    <select id="readingGrade" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none">
                      <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ</option>
                      <option value="grade3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                      <option value="grade6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                      <option value="grade9">Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</option>
                    </select>
                  </div>
                  
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ *</label>
                    <textarea id="readingContent" required rows="6"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ù‡Ù†Ø§..."></textarea>
                  </div>
                  
                  <button type="submit"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-lg font-bold hover:opacity-90 transition-all pulse-glow">
                    ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                  </button>
                </form>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">
                  Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© (${arabicReadingTexts.length})
                </h3>
                
                ${arabicReadingTexts.length === 0 ? `
                  <div class="text-center py-8">
                    <div style="font-size: ${baseFontSize * 3}px;" class="mb-4 opacity-50">ğŸ“š</div>
                    <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-60">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ Ù…Ù‚Ø±ÙˆØ¡Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</p>
                  </div>
                ` : `
                  <div class="space-y-4">
                    ${arabicReadingTexts.map((text, index) => {
                      const textQuestions = questions.filter(q => q.skill_id === text.reading_id).map(q => ({
                        question: q.question_text
                      }));
                      return `
                        <div style="background-color: ${bgColor};" class="rounded-xl p-6">
                          <div class="flex items-start justify-between gap-4 mb-4">
                            <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                <h4 style="font-size: ${baseFontSize * 1.25}px; color: ${textColor};" class="font-bold">${text.title}</h4>
                                <span style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.75}px;" 
                                  class="px-3 py-1 rounded-full">
                                  ${text.grade === 'grade3' ? 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«' : text.grade === 'grade6' ? 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³' : 'Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹'}
                                </span>
                              </div>
                              
                              <div style="background-color: ${cardColor};" class="rounded-lg p-4 mt-3">
                                <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="leading-relaxed">
                                  ${text.content.substring(0, 200)}${text.content.length > 200 ? '...' : ''}
                                </p>
                              </div>
                              
                              ${textQuestions.length > 0 ? `
                                <div class="mt-4">
                                  <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="font-semibold mb-2">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù†Øµ:</div>
                                  <div class="space-y-2">
                                    ${textQuestions.slice(0, 2).map((q, qIndex) => `
                                      <div style="background-color: ${cardColor};" class="rounded-lg p-3">
                                        <div style="font-size: ${baseFontSize * 0.875}px; color: ${textColor};" class="font-semibold">${qIndex + 1}. ${q.question}</div>
                                      </div>
                                    `).join('')}
                                    ${textQuestions.length > 2 ? `
                                      <div style="font-size: ${baseFontSize * 0.75}px; color: ${textColor};" class="opacity-60 text-center">
                                        + ${textQuestions.length - 2} Ø£Ø³Ø¦Ù„Ø© Ø£Ø®Ø±Ù‰
                                      </div>
                                    ` : ''}
                                  </div>
                                </div>
                              ` : ''}
                            </div>
                            
                            <div class="flex flex-col gap-2">
                              <button onclick="addQuestionsToReading('${text.__backendId}')"
                                style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                                class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all">
                                ${textQuestions.length > 0 ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ø£Ø³Ø¦Ù„Ø© â“
                              </button>
                              <button onclick="deleteReadingText('${text.__backendId}')"
                                style="background-color: #ef4444; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                                class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all">
                                Ø­Ø°Ù ğŸ—‘ï¸
                              </button>
                            </div>
                          </div>
                          
                          ${textQuestions.length > 0 ? `
                            <div class="mt-4 flex items-center gap-2">
                              <span style="font-size: ${baseFontSize * 0.875}px; color: ${primaryColor};" class="font-semibold">
                                âœ… ${textQuestions.length} Ø³Ø¤Ø§Ù„
                              </span>
                            </div>
                          ` : `
                            <div class="mt-4">
                              <span style="font-size: ${baseFontSize * 0.875}px; color: #ef4444;" class="font-semibold">
                                âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©
                              </span>
                            </div>
                          `}
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }
      
      // 14. Ø´Ø§Ø´Ø© Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡
      else if (currentScreen === 'add_reading_questions') {
        const readingText = readingTexts.find(r => r.__backendId === gameState.selectedReadingId);
        
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-4xl mx-auto">
              <div class="flex items-center justify-between mb-8">
                <button onclick="goBackToArabicReading()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†ØµÙˆØµ
                </button>
                <button onclick="logout()"
                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                  class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                  ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                </button>
              </div>
              
              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-6 text-center">
                  Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù†Øµ: ${readingText?.title || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                </h3>
                
                <div style="background-color: ${bgColor};" class="rounded-xl p-4 mb-6">
                  <h4 style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold mb-3">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡:</h4>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="leading-relaxed opacity-90">
                    ${readingText?.content || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ'}
                  </p>
                </div>
                
                <form id="readingQuestionsForm" onsubmit="saveReadingQuestions(event)" class="space-y-6">
                  <div id="questionsContainer">
                    ${(() => {
                      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹
                      let existingQuestions = questions
                        .filter(q => q.skill_id === readingText?.reading_id)
                        .map(q => ({
                          question: q.question_text,
                          options: [q.answer_a, q.answer_b, q.answer_c, q.answer_d],
                          correctAnswer: ['A', 'B', 'C', 'D'].indexOf(q.correct_answer)
                        }));
                      
                      // Ø¯Ø¹Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (JSON) Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                      if (existingQuestions.length === 0 && readingText?.questions) {
                        try {
                          const oldData = typeof readingText.questions === 'string' ? JSON.parse(readingText.questions) : readingText.questions;
                          if (Array.isArray(oldData)) existingQuestions = oldData;
                        } catch (e) {
                          console.error('Error parsing old questions format', e);
                        }
                      }
                      
                      if (existingQuestions.length === 0) {
                        existingQuestions = [{
                          question: '',
                          options: ['', '', '', ''],
                          correctAnswer: 0
                        }];
                      }
                      
                      return existingQuestions.map((q, qIndex) => `
                        <div style="background-color: ${bgColor};" class="rounded-xl p-6 mb-4 question-item" data-index="${qIndex}">
                          <div class="flex items-center justify-between mb-4">
                            <h5 style="font-size: ${baseFontSize}px; color: ${textColor};" class="font-bold">Ø³Ø¤Ø§Ù„ ${qIndex + 1}</h5>
                            ${qIndex > 0 ? `
                              <button type="button" onclick="removeQuestion(${qIndex})"
                                style="background-color: #ef4444; color: ${textColor}; font-size: ${baseFontSize * 0.875}px;"
                                class="px-3 py-1 rounded-lg font-semibold hover:opacity-80 transition-all">
                                Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„
                              </button>
                            ` : ''}
                          </div>
                          
                          <div class="mb-4">
                            <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ *</label>
                            <input type="text" name="question_${qIndex}" value="${q.question}" required
                              style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                              class="w-full px-4 py-3 rounded-lg outline-none"
                              placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
                          </div>
                          
                          <div class="grid md:grid-cols-2 gap-4 mb-6">
                            ${[0, 1, 2, 3].map(optionIndex => `
                              <div>
                                <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">
                                  Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(65 + optionIndex)} *
                                </label>
                                <input type="text" name="option_${qIndex}_${optionIndex}" value="${q.options[optionIndex] || ''}" required
                                  style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                                  class="w-full px-4 py-3 rounded-lg outline-none"
                                  placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${String.fromCharCode(65 + optionIndex)}">
                              </div>
                            `).join('')}
                          </div>
                          
                          <div>
                            <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© *</label>
                            <select name="correct_${qIndex}" required
                              style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                              class="w-full px-4 py-3 rounded-lg outline-none">
                              ${[0, 1, 2, 3].map(optionIndex => `
                                <option value="${optionIndex}" ${q.correctAnswer === optionIndex ? 'selected' : ''}>
                                  Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(65 + optionIndex)}
                                </option>
                              `).join('')}
                            </select>
                          </div>
                        </div>
                      `).join('');
                    })()}
                  </div>
                  
                  <div class="flex gap-4">
                    <button type="button" onclick="addNewQuestion()"
                      style="background-color: ${secondaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all">
                      â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
                    </button>
                    
                    <button type="submit"
                      style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="flex-1 py-4 rounded-lg font-bold hover:opacity-90 transition-all pulse-glow">
                      ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;
      }

      // 15. Ø´Ø§Ø´Ø© Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… (Ø§Ù„Ù…Ø¹Ù„Ù…)
      else if (currentScreen === 'admin_learning_outcomes') {
        content = `
          <div class="min-h-full p-4" style="background-color: ${bgColor};">
            <div class="max-w-6xl mx-auto">
              <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
                <div>
                  <h1 style="font-size: ${baseFontSize * 2}px; color: ${textColor};" class="font-bold mb-2">Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… ğŸ¯</h1>
                  <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</p>
                </div>
                <div class="flex gap-3">
                  <button onclick="goToTeacherAdmin()"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
                  </button>
                  <button onclick="logout()"
                    style="background-color: ${cardColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                    class="px-6 py-3 rounded-lg font-semibold hover:opacity-80 transition-all">
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ â¬…ï¸
                  </button>
                </div>
              </div>

              <div style="background-color: ${cardColor};" class="rounded-2xl p-6 mb-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4" id="formTitle">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ù„Ø¹Ø© ØªØ¹Ù„Ù… Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <form id="admin_learning_outcomes_form" onsubmit="addCastle(event)" class="space-y-4">
                  <div class="grid md:grid-cols-2 gap-4">
                    <div>
                      <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *</label>
                      <select id="lc_grade" required
                        style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                        class="w-full px-4 py-3 rounded-lg outline-none">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                        <option value="grade3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                        <option value="grade6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                        <option value="grade9">Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</option>
                      </select>
                    </div>
                    <div>
                      <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ù„Ù…Ø§Ø¯Ø© *</label>
                      <select id="lc_subject" required
                        style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                        class="w-full px-4 py-3 rounded-lg outline-none">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                        <option value="math">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                        <option value="science">Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                        <option value="arabic">Ù„ØºØªÙŠ</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø§Ø³Ù… Ø§Ù„Ù‚Ù„Ø¹Ø© (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) *</label>
                    <input type="text" id="lc_title" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none"
                      placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù„Ø¹Ø© Ø§Ù„Ù‚Ø³Ù…Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø©">
                  </div>
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… *</label>
                    <textarea id="lc_outcome" required rows="3"
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none"
                      placeholder="ÙˆØµÙ Ù†Ø§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù..."></textarea>
                  </div>
                  <div>
                    <label style="color: ${textColor}; font-size: ${baseFontSize}px;" class="block mb-2 font-semibold">Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (YouTube) *</label>
                    <input type="url" id="lc_video" required
                      style="background-color: ${bgColor}; color: ${textColor}; font-size: ${baseFontSize}px;"
                      class="w-full px-4 py-3 rounded-lg outline-none"
                      placeholder="https://youtube.com/...">
                  </div>
                  <button type="submit"
                    style="background-color: ${primaryColor}; color: ${textColor}; font-size: ${baseFontSize * 1.125}px;"
                    class="w-full py-4 rounded-lg font-bold hover:opacity-90 transition-all pulse-glow">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚Ù„Ø¹Ø©
                  </button>
                </form>
              </div>

              <div style="background-color: ${cardColor};" class="rounded-2xl p-6">
                <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ© (${learningCastles.length})</h3>
                <div class="space-y-4">
                  ${learningCastles.map((castle, index) => `
                    <div style="background-color: ${bgColor};" class="rounded-xl p-4 flex flex-col md:flex-row gap-4 items-start">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <span style="background-color: ${secondaryColor}; font-size: ${baseFontSize * 0.75}px;" class="px-2 py-1 rounded text-white">${castle.grade}</span>
                          <span style="background-color: ${primaryColor}; font-size: ${baseFontSize * 0.75}px;" class="px-2 py-1 rounded text-white">${castle.subject}</span>
                        </div>
                        <h4 style="font-size: ${baseFontSize * 1.25}px; color: ${textColor};" class="font-bold mb-1">${castle.title}</h4>
                        <p style="font-size: ${baseFontSize}px; color: ${textColor};" class="opacity-80 mb-2">${castle.learning_outcome}</p>
                        <a href="${castle.video_url}" target="_blank" style="color: ${primaryColor}; text-decoration: underline; font-size: ${baseFontSize * 0.875}px;">ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
                      </div>
                      <div class="flex flex-col gap-2 self-center">
                        <button onclick="editLearningCastle('${castle.__backendId}')"
                          style="background-color: ${secondaryColor}; color: ${textColor};"
                          class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all">
                          âœï¸ ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="deleteLearningCastle('${castle.__backendId}')"
                          style="background-color: #ef4444; color: ${textColor};"
                          class="px-4 py-2 rounded-lg font-semibold hover:opacity-80 transition-all">
                          ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                      </div>
                    </div>
                  `).join('')}
                  ${learningCastles.length === 0 ? `
                    <div class="text-center py-8 opacity-60">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù„Ø§Ø¹ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</div>
                  ` : ''}
                </div>
                
                <div class="mt-8 pt-8 border-t border-gray-600">
                    <h3 style="font-size: ${baseFontSize * 1.5}px; color: ${textColor};" class="font-bold mb-4">ğŸ“š Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
                    <button onclick="loadAllCastlesWithVideos()" style="background-color: ${primaryColor}; color: ${textColor};" class="px-4 py-2 rounded-lg font-bold mb-4">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
                    <div id="castles-list" class="grid md:grid-cols-2 gap-6"></div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      app.innerHTML = content;
      
      // ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø±ÙØ¹ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
      if (currentScreen === 'admin') {
        initUploadPanel();
      }

      if (currentScreen === 'results') {
        onLevelCompleted({
          level: gameState.currentUnit,
          totalQuestions: gameState.currentQuestions.length,
          correctAnswers: gameState.correctAnswers
        });
      }

      if (currentScreen === 'challenge' || currentScreen === 'multiplayer_game') {
        const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„
        const qDisplay = document.getElementById('questionDisplay');
        if (qDisplay && currentQ && currentQ.question_text) {
            if (currentQ.question_text.startsWith('data:image') || currentQ.question_text.includes('supabase.co')) {
                qDisplay.innerHTML = `<img src="${currentQ.question_text}" onclick="openImageZoom(this.src)" class="max-w-full h-auto rounded-lg mx-auto border-2 border-gray-600 cursor-zoom-in hover:opacity-90 transition-opacity" style="max-height: 300px;" alt="Ø³Ø¤Ø§Ù„">`;
            } else {
                renderMathQuestion(currentQ.question_text, qDisplay);
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø§Ù„ÙƒØ³ÙˆØ± ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª)
        if (currentQ) {
            ['A', 'B', 'C', 'D'].forEach(key => {
                const answerDiv = document.getElementById(`answerText${key}`);
                const answerText = currentQ[`answer_${key.toLowerCase()}`];
                if (answerDiv && answerText) {
                    renderMathQuestion(answerText, answerDiv);
                }
            });
        }
      }
    }

    // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===

    async function hashPassword(password) {
      const msgBuffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function handleLogin(e) {
      e.preventDefault();

      const email = document.getElementById('login_email').value.trim();
      const password = document.getElementById('login_password').value;

      if (!email || !password) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
        return;
      }

      const { data, error } = await supabaseSdk.client.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
        return;
      }

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const { data: userData, error: userError } = await supabaseSdk.client
        .from('users')
        .select('*')
        .eq('user_id', data.user.id)
        .single();

      if (userError) {
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
        return;
      }

      currentUser = userData;
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');

      // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      supabaseSdk.backupData().then(() => supabaseSdk.syncData(true));

      // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡
      if (currentUser.user_type === 'teacher') {
        currentScreen = 'admin';
        gameState.selectedCity = '';
      } else if (currentUser.user_type === 'parent') {
        currentScreen = 'parent_report';
        gameState.selectedStudentId = '';
      } else if (currentUser.user_type === 'admin') {
        currentScreen = 'admin_panel';
      } else {
        if (currentUser.grade) {
          gameState.selectedGrade = currentUser.grade;
        }
        if (currentUser.semester) {
          gameState.selectedSemester = currentUser.semester;
          gameState.currentIsland = currentUser.semester;
        }

        // ØªÙˆØ¬ÙŠÙ‡ Ø°ÙƒÙŠ: ØªØ®Ø·ÙŠ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (currentUser.grade && currentUser.semester) {
          currentScreen = 'subjects';
        } else if (currentUser.semester) {
          currentScreen = 'setup';
        } else {
          currentScreen = 'semester';
        }
        if (currentUser.progress_data && typeof currentUser.progress_data === 'string' && currentUser.progress_data !== '{}') {
          try {
            const savedProgress = JSON.parse(currentUser.progress_data);
            gameState = { ...gameState, ...savedProgress };
          } catch (e) {
            console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù…');
          }
        }
      }

      renderCurrentScreen();
    }

    async function handleRegister(e) {
      e.preventDefault();

      const email = document.getElementById('register_email').value.trim();
      const password = document.getElementById('register_password').value;
      const username = document.getElementById('register_username').value.trim();
      const fullName = document.getElementById('register_fullname').value.trim();
      let userType = 'student';

      if (!email || !password || !username || !fullName) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø´Ø±Ù

      // 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Auth
      const { data, error } = await supabaseSdk.client.auth.signUp({
        email,
        password
      });

      if (error) {
        showToast(error.message, 'error');
        return;
      }

      // 2ï¸âƒ£ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±)
      const { error: dbError } = await supabaseSdk.client.from('users').insert({
        user_id: data.user.id,
        username,
        full_name: fullName,
        user_type: userType,
        skills_mastered: 0,
        current_level: 1,
        total_points: 0,
        stars_collected: 0
      });

      if (dbError) {
        showToast(dbError.message, 'error');
        return;
      }

      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰', 'success');
      goToLogin();
    }

    function logout() {
      currentUser = null;
      currentScreen = 'login';
      gameState = {
        selectedGrade: '',
        selectedSemester: '',
        currentIsland: 'semester1',
        unlockedCities: ['math', 'science', 'arabic', 'math2', 'science2', 'arabic2', 'math_test', 'science_test', 'arabic_test'],
        completedSkills: [],
        currentQuestionIndex: 0,
        currentQuestions: [],
        correctAnswers: 0,
        selectedAnswer: null,
        currentCastle: '',
        currentUnit: '',
        selectedCity: '',
        selectedStudentId: '',
        challengeData: null,
        pendingQuestionsPromise: null
      };
      if (typeof challengeInterval !== 'undefined' && challengeInterval) clearInterval(challengeInterval);
      renderCurrentScreen();
    }

    function goToRegister() {
      currentScreen = 'register';
      renderCurrentScreen();
    }

    function goToForgotPassword() {
      currentScreen = 'forgot_password';
      renderCurrentScreen();
    }

    async function handleForgotPassword(e) {
      e.preventDefault();

      const email = document.getElementById('forgot_email').value.trim();

      if (!email) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');
        return;
      }

      const { error } = await supabaseSdk.client.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.href
      });

      if (error) {
        showToast(error.message, 'error');
        return;
      }

      showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ğŸ“©', 'success');
      goToLogin();
    }

    function goToLogin() {
      currentScreen = 'login';
      renderCurrentScreen();
    }

    function toggleTeacherCode(userType) {
      const container = document.getElementById('teacherCodeContainer');
      if (container) {
        container.style.display = userType === 'teacher' ? 'block' : 'none';
      }
    }

    function selectStudentForReport(studentId) {
      gameState.selectedStudentId = studentId;
      renderCurrentScreen();
    }

    async function promptUpgrade() {
      const code = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù…:");
      if (!code) return;

      if (code === "ADMIN2024") {
        if (!currentUser) return;
        currentUser.user_type = 'admin';
        await window.dataSdk.update(currentUser);
        await supabaseSdk.client.from('users').update({ user_type: 'admin' }).eq('user_id', currentUser.user_id);
        showToast("ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Ù…Ø´Ø±Ù! ğŸ‘‘", "success");
        currentScreen = 'admin_panel';
        renderCurrentScreen();
      } else {
         // Check teacher code
         const { data, error } = await supabaseSdk.client
            .from('teacher_codes')
            .select('*')
            .eq('code', code)
            .eq('is_used', false)
            .single();
         
         if (data) {
            currentUser.user_type = 'teacher';
            await window.dataSdk.update(currentUser);
            await supabaseSdk.client.from('users').update({ user_type: 'teacher' }).eq('user_id', currentUser.user_id);
            await supabaseSdk.client.from('teacher_codes').update({ is_used: true, created_for: currentUser.username }).eq('code_id', data.code_id);
            
            showToast("ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Ù…Ø¹Ù„Ù…! ğŸ‘¨â€ğŸ«", "success");
            currentScreen = 'admin';
            renderCurrentScreen();
         } else {
            showToast("ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦", "error");
         }
      }
    }

    async function generateTeacherCode(event) {
      event.preventDefault();
      
      const count = parseInt(document.getElementById('codeCount').value);
      
      if (count < 1 || count > 10) {
        showToast('ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù† 1 Ø¥Ù„Ù‰ 10 Ø£ÙƒÙˆØ§Ø¯ ÙÙ‚Ø·', 'error');
        return;
      }
      
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const newCodes = [];
      
      for (let i = 0; i < count; i++) {
        let code = '';
        for (let j = 0; j < 8; j++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        const newCode = {
          code_id: generateUUID(),
          user_id: currentUser.user_id,
          code: code,
          is_used: false,
          created_at: new Date().toISOString()
        };
        // Ù„Ø§ Ù†Ø±Ø³Ù„ created_for Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
        newCodes.push(newCode);
      }
      
      // Ø­ÙØ¸ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
      const supabaseCodes = newCodes.map(({ user_id, ...code }) => code);
      const { data, error } = await supabaseSdk.client.from('teacher_codes').insert(supabaseCodes).select();
      
      if (error) {
        console.error('Supabase Error:', error);
        showToast(`ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: ${error.message} (${error.details || ''})`, 'error');
        return;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      for (const code of newCodes) {
        await window.dataSdk.create({ ...code, created_for: '' });
      }
      
      showToast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${count} ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
      document.getElementById('codeCount').value = '1';
      renderCurrentScreen();
    }

    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        showToast(`ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: ${code}`, 'success');
      }).catch(() => {
        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
        const tempInput = document.createElement('textarea');
        tempInput.value = code;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showToast(`ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: ${code}`, 'success');
      });
    }

    async function revokeTeacher(teacherId) {
      const teacher = users.find(u => u.__backendId === teacherId);
      if (!teacher) return;
      
      teacher.is_approved = false;
      const result = await window.dataSdk.update(teacher);
      
      if (result.isOk) {
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù…', 'success');
        renderCurrentScreen();
      } else {
        showToast('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©', 'error');
      }
    }

    function changeAdminGrade(newGrade) {
      if (!currentUser) return;
      
      currentUser.grade = newGrade;
      gameState.selectedCity = '';
      
      const userToUpdate = users.find(u => u.username === currentUser.username && u.user_type === 'teacher');
      if (userToUpdate) {
        userToUpdate.grade = newGrade;
        window.dataSdk.update(userToUpdate);
      }
      
      renderCurrentScreen();
    }

    function selectGradeAndContinue(grade) {
      gameState.selectedGrade = grade;
      currentScreen = 'subjects';
      renderCurrentScreen();
    }

    function selectSemesterAndContinue(semester) {
      gameState.selectedSemester = semester;
      gameState.currentIsland = semester;
      currentScreen = 'setup';
      renderCurrentScreen();
    }

    function backToGrade() {
      currentScreen = 'setup';
      renderCurrentScreen();
    }

    function backToSemester() {
      currentScreen = 'semester';
      renderCurrentScreen();
    }

    function backToSubjects() {
      currentScreen = 'subjects';
      renderCurrentScreen();
    }

    function backToCastle() {
      currentScreen = 'castle';
      renderCurrentScreen();
    }

    function selectSubject(cityId) {
      gameState.currentCastle = cityId;
      currentScreen = 'castle';
      renderCurrentScreen();
    }

    function selectCityForAdmin(cityId) {
      gameState.selectedCity = cityId;
      renderCurrentScreen();
    }

    function goToLearningOutcomes() {
      currentScreen = 'admin_learning_outcomes';
      renderCurrentScreen();
    }

    function goToArabicReading() {
      currentScreen = 'arabic_reading';
      renderCurrentScreen();
    }

    function goToTeacherAdmin() {
      currentScreen = 'admin';
      renderCurrentScreen();
    }

    function goBackToArabicReading() {
      currentScreen = 'arabic_reading';
      renderCurrentScreen();
    }

    async function addReadingText(event) {
      event.preventDefault();
      
      const title = document.getElementById('readingTitle').value;
      const grade = document.getElementById('readingGrade').value;
      const content = document.getElementById('readingContent').value;
      
      if (!title || !grade || !content) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©', 'error');
        return;
      }
      
      const newReadingText = {
        reading_id: generateUUID(),
        user_id: currentUser.user_id,
        subject: 'arabic',
        title: title,
        grade: grade,
        content: content,
        questions: '[]',
        created_by: currentUser.username,
        created_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.create(newReadingText);
      
      if (result.isOk) {
        // Ø­ÙØ¸ ÙÙŠ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
        const { __backendId, questions, ...supabaseData } = newReadingText;
        const { error } = await supabaseSdk.client.from('reading_texts').insert([supabaseData]);
        
        if (error) {
          console.error('Supabase Error:', error);
          showToast(`ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${error.message}`, 'error');
        } else {
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...', 'success');
        }
        
        gameState.selectedReadingId = newReadingText.__backendId;
        currentScreen = 'add_reading_questions';
        renderCurrentScreen();
      } else {
        showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡', 'error');
      }
    }

    async function deleteReadingText(readingId) {
      const readingToDelete = readingTexts.find(r => r.__backendId === readingId);
      if (!readingToDelete) return;
      
      const result = await window.dataSdk.delete(readingToDelete);
      
      if (result.isOk) {
        // Ø­Ø°Ù Ù…Ù† Supabase Ù…Ø¨Ø§Ø´Ø±Ø©
        const { error } = await supabaseSdk.client.from('reading_texts').delete().eq('reading_id', readingToDelete.reading_id);
        
        if (error) {
          console.error('Supabase Error:', error);
          showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', 'warning');
        } else {
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        renderCurrentScreen();
      } else {
        showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡', 'error');
      }
    }

    function addQuestionsToReading(readingId) {
      gameState.selectedReadingId = readingId;
      currentScreen = 'add_reading_questions';
      renderCurrentScreen();
    }

    function addNewQuestion() {
      const questionsContainer = document.getElementById('questionsContainer');
      const questionCount = document.querySelectorAll('.question-item').length;
      
      const newQuestionDiv = document.createElement('div');
      newQuestionDiv.className = 'question-item';
      newQuestionDiv.style.backgroundColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      newQuestionDiv.style.borderRadius = '12px';
      newQuestionDiv.style.padding = '24px';
      newQuestionDiv.style.marginBottom = '16px';
      newQuestionDiv.dataset.index = questionCount;
      
      newQuestionDiv.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h5 style="font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px; color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color};" class="font-bold">Ø³Ø¤Ø§Ù„ ${questionCount + 1}</h5>
          <button type="button" onclick="removeQuestion(${questionCount})"
            style="background-color: #ef4444; color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${(window.elementSdk?.config?.font_size || defaultConfig.font_size) * 0.875}px;"
            class="px-3 py-1 rounded-lg font-semibold hover:opacity-80 transition-all">
            Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„
          </button>
        </div>
        
        <div class="mb-4">
          <label style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;" class="block mb-2 font-semibold">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ *</label>
          <input type="text" name="question_${questionCount}" required
            style="background-color: ${window.elementSdk?.config?.card_surface_color || defaultConfig.card_surface_color}; color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;"
            class="w-full px-4 py-3 rounded-lg outline-none"
            placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
        </div>
        
        <div class="grid md:grid-cols-2 gap-4 mb-6">
          ${[0, 1, 2, 3].map(optionIndex => `
            <div>
              <label style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;" class="block mb-2 font-semibold">
                Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(65 + optionIndex)} *
              </label>
              <input type="text" name="option_${questionCount}_${optionIndex}" required
                style="background-color: ${window.elementSdk?.config?.card_surface_color || defaultConfig.card_surface_color}; color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;"
                class="w-full px-4 py-3 rounded-lg outline-none"
                placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${String.fromCharCode(65 + optionIndex)}">
            </div>
          `).join('')}
        </div>
        
        <div>
          <label style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;" class="block mb-2 font-semibold">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© *</label>
          <select name="correct_${questionCount}" required
            style="background-color: ${window.elementSdk?.config?.card_surface_color || defaultConfig.card_surface_color}; color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;"
            class="w-full px-4 py-3 rounded-lg outline-none">
            ${[0, 1, 2, 3].map(optionIndex => `
              <option value="${optionIndex}">Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(65 + optionIndex)}</option>
            `).join('')}
          </select>
        </div>
      `;
      
      questionsContainer.appendChild(newQuestionDiv);
    }

    function removeQuestion(index) {
      const questionDiv = document.querySelector(`.question-item[data-index="${index}"]`);
      if (questionDiv) {
        questionDiv.remove();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        const remainingQuestions = document.querySelectorAll('.question-item');
        remainingQuestions.forEach((div, newIndex) => {
          div.dataset.index = newIndex;
          const title = div.querySelector('h5');
          if (title) {
            title.textContent = `Ø³Ø¤Ø§Ù„ ${newIndex + 1}`;
          }
          
          // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„
          const inputs = div.querySelectorAll('input, select');
          inputs.forEach(input => {
            const oldName = input.getAttribute('name');
            if (oldName) {
              const parts = oldName.split('_');
              if (parts[0] === 'question') {
                input.setAttribute('name', `question_${newIndex}`);
              } else if (parts[0] === 'option') {
                input.setAttribute('name', `option_${newIndex}_${parts[2]}`);
              } else if (parts[0] === 'correct') {
                input.setAttribute('name', `correct_${newIndex}`);
              }
            }
          });
        });
      }
    }

    async function saveReadingQuestions(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const newQuestions = [];
      
      // ØªØ¬Ù…ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      const questionItems = document.querySelectorAll('.question-item');
      
      const readingText = readingTexts.find(r => r.__backendId === gameState.selectedReadingId);
      if (!readingText) {
        showToast('Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
        return;
      }

      for (let i = 0; i < questionItems.length; i++) {
        const question = formData.get(`question_${i}`);
        const options = [
          formData.get(`option_${i}_0`),
          formData.get(`option_${i}_1`),
          formData.get(`option_${i}_2`),
          formData.get(`option_${i}_3`)
        ];
        const correctAnswer = parseInt(formData.get(`correct_${i}`));
        
        if (question && options.every(opt => opt && opt.trim())) {
          newQuestions.push({
            question_id: generateUUID(),
            user_id: currentUser.user_id,
            question_text: question,
            question_type: 'multiple_choice',
            skill_id: readingText.reading_id,
            city_id: 'arabic',
            grade: readingText.grade,
            difficulty_level: 'medium',
            answer_a: options[0],
            answer_b: options[1],
            answer_c: options[2],
            answer_d: options[3],
            correct_answer: ['A', 'B', 'C', 'D'][correctAnswer],
            points_value: 10,
            created_at: new Date().toISOString(),
            reading_text: readingText.content,
            reading_title: readingText.title
          });
        }
      }
      
      if (newQuestions.length === 0) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        return;
      }
      
      // Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…
      const oldQuestions = questions.filter(q => q.skill_id === readingText.reading_id);
      for (const q of oldQuestions) {
        await window.dataSdk.delete(q);
      }
      await supabaseSdk.client.from('questions').delete().eq('skill_id', readingText.reading_id);

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      for (const q of newQuestions) {
        await window.dataSdk.create(q);
      }
      const { error } = await supabaseSdk.client.from('questions').insert(newQuestions.map(({__backendId, ...q}) => q));
          
      if (error) {
          console.error('Supabase Error:', error);
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', 'warning');
      } else {
          showToast(`ØªÙ… Ø­ÙØ¸ ${newQuestions.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
      }
        
        setTimeout(() => {
          currentScreen = 'arabic_reading';
          renderCurrentScreen();
        }, 1500);
    }

    async function syncWithSupabase() {
      showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
      
      // 1. Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Backup) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹Ù‡Ø§
      await supabaseSdk.backupData();
      
      // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sync)
      const result = await supabaseSdk.syncData();
      
      hideLoader();
      if (result.isOk) {
        showToast('ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Supabase Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
        renderCurrentScreen();
      }
    }

    function toggleBulkForm() {
      const container = document.getElementById('bulkFormContainer');
      container.classList.toggle('open');
    }

    function toggleReadingPassageForm() {
      const container = document.getElementById('readingPassageFormContainer');
      container.classList.toggle('open');
      if (container.classList.contains('open') && document.getElementById('passageQuestionsList').children.length === 0) {
        addQuestionFieldToPassage(); // Add first question by default
      }
    }

    function toggleSingleForm() {
      const container = document.getElementById('singleFormContent');
      const arrow = document.getElementById('singleFormArrow');
      container.classList.toggle('open');
      arrow.textContent = container.classList.contains('open') ? 'â–²' : 'â–¼';
    }

    async function processBulkQuestions(event) {
      event.preventDefault();
      
      const unitId = document.getElementById('bulkUnitId').value;
      const bulkText = document.getElementById('bulkQuestionsText').value;
      
      if (!unitId || !bulkText.trim()) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ù„Ø¹Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('processBulkBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
      
      try {
        const parsedQuestions = parseBulkQuestions(bulkText, unitId);
        
        if (parsedQuestions.length === 0) {
          showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©';
          return;
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ© (Ø§Ù„ØµÙØŒ Ø§Ù„ÙØµÙ„ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©)
        let currentGrade = currentUser.grade || 'grade3';
        let currentSemester = 'semester1';
        let currentCity = gameState.selectedCity;
        let currentSubject = 'general';
        let readingTextContent = null;
        let readingTextTitle = null;
        let readingParentId = null;

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
        if (currentScreen === 'add_reading_questions') {
          const readingText = readingTexts.find(r => r.__backendId === gameState.selectedReadingId);
          if (readingText) {
            currentGrade = readingText.grade;
            currentCity = 'arabic';
            currentSubject = 'arabic';
            readingTextContent = readingText.content;
            readingTextTitle = readingText.title;
            readingParentId = readingText.reading_id;
          }
        } else {
          // Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        for (const [key, val] of Object.entries(islands)) {
          if (val.cities.some(c => c.id === gameState.selectedCity)) {
            currentSemester = key;
            break;
          }
        }
          if (gameState.selectedCity.includes('math')) currentSubject = 'math';
          else if (gameState.selectedCity.includes('science')) currentSubject = 'science';
          else if (gameState.selectedCity.includes('arabic')) currentSubject = 'arabic';
        }
        
        const supabaseQuestions = [];
        for (const q of parsedQuestions) {
          const newQuestion = {
            question_id: generateUUID(),
            user_id: currentUser.user_id,
            question_text: q.text,
            question_type: 'multiple_choice',
            skill_id: unitId,
            city_id: currentCity,
            difficulty_level: q.difficulty || 'medium',
            answer_a: q.options.a,
            answer_b: q.options.b,
            answer_c: q.options.c,
            answer_d: q.options.d,
            correct_answer: q.correctAnswer,
            explanation: q.explanation || '',
            points_value: q.points || 10,
            grade: currentGrade,
            semester: currentSemester,
            subject: currentSubject,
            created_by: currentUser.username,
            created_at: new Date().toISOString(),
            reading_text: readingTextContent,
            reading_title: readingTextTitle,
            reading_parent_id: readingParentId
          };
          
          await window.dataSdk.create(newQuestion);
          
          // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ Supabase
          const { __backendId, ...supabaseData } = newQuestion;
          supabaseQuestions.push(supabaseData);
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
        const { error } = await supabaseSdk.client.from('questions').insert(supabaseQuestions);
        
        if (error) {
          console.error('Supabase Error:', error);
          if (error.code === 'PGRST204') {
            showToast(`Ø®Ø·Ø£ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª: Ø§Ù„Ø¹Ù…ÙˆØ¯ ${error.message.match(/'(.*?)'/)?.[1] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} Ù…ÙÙ‚ÙˆØ¯. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„.`, 'error');
          } else {
            showToast(`ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${error.message}`, 'error');
          }
        } else {
          showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${parsedQuestions.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! âœ…`, 'success');
        }
        
        document.getElementById('bulkQuestionForm').reset();
        renderCurrentScreen();
        
      } catch (error) {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©';
      }
    }

    function parseBulkQuestions(text, unitId) {
      const questions = [];
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      
      let currentQuestion = null;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        const questionMatch = line.match(/^(?:Ø§Ù„Ø³Ø¤Ø§Ù„\s*\d*\s*[:ï¼š.\-)]?|Ø³\s*\d*\s*[:ï¼š.\-)]?|\d+\s*[:ï¼š.\-)])\s*(.+)/) || 
                            (line.includes('ØŸ') && !line.match(/^[Ø£Ø§Ø¨Ø¬Ø¯ABCD]/) && currentQuestion === null ? { 1: line } : null);
        
        if (questionMatch) {
          if (currentQuestion && currentQuestion.text && Object.keys(currentQuestion.options).length === 4 && currentQuestion.correctAnswer) {
            questions.push(currentQuestion);
          }
          
          const questionText = (questionMatch[1] || line).trim();
          currentQuestion = {
            text: questionText,
            options: {},
            correctAnswer: '',
            difficulty: 'medium',
            points: 10,
            explanation: ''
          };
          continue;
        }
        
        const optionMatch = line.match(/^([Ø£Ø§Ø¨Ø¬Ø¯ABCD])\s*[)ï¼‰.\-:ï¼š]\s*(.+)/) ||
                           line.match(/^([Ø£Ø§Ø¨Ø¬Ø¯ABCD])\s+(.+)/);
        
        if (optionMatch && currentQuestion) {
          let key = optionMatch[1];
          const arabicToEnglish = { 'Ø£': 'A', 'Ø§': 'A', 'Ø¨': 'B', 'Ø¬': 'C', 'Ø¯': 'D' };
          key = arabicToEnglish[key] || key.toUpperCase();
          currentQuestion.options[key.toLowerCase()] = optionMatch[2].trim();
          continue;
        }
        
        const answerMatch = line.match(/^(?:Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©|Ø§Ù„Ø§Ø¬Ø§Ø¨Ø©|Ø§Ù„Ø¬ÙˆØ§Ø¨|Ø§Ù„Ø­Ù„|ØµØ­)\s*[:ï¼š]?\s*([Ø£Ø§Ø¨Ø¬Ø¯ABCD])/i) ||
                           line.match(/^(?:correct|answer)\s*[:ï¼š]?\s*([ABCD])/i);
        
        if (answerMatch && currentQuestion) {
          let answer = answerMatch[1];
          const arabicToEnglish = { 'Ø£': 'A', 'Ø§': 'A', 'Ø¨': 'B', 'Ø¬': 'C', 'Ø¯': 'D' };
          currentQuestion.correctAnswer = (arabicToEnglish[answer] || answer).toUpperCase();
          continue;
        }
        
        const explanationMatch = line.match(/^(?:Ø§Ù„Ø´Ø±Ø­|Ø§Ù„ØªÙˆØ¶ÙŠØ­|Ø§Ù„ØªÙØ³ÙŠØ±)\s*[:ï¼š]\s*(.+)/);
        if (explanationMatch && currentQuestion) {
          currentQuestion.explanation = explanationMatch[1].trim();
          continue;
        }
      }
      
      if (currentQuestion && currentQuestion.text && Object.keys(currentQuestion.options).length === 4 && currentQuestion.correctAnswer) {
        questions.push(currentQuestion);
      }
      
      const validQuestions = questions.filter(q => {
        return q.text && 
               q.options.a && q.options.b && q.options.c && q.options.d && 
               q.correctAnswer &&
               ['A', 'B', 'C', 'D'].includes(q.correctAnswer);
      });
      
      validQuestions.forEach((q, index) => {
        const totalQuestions = validQuestions.length;
        if (index < totalQuestions / 3) {
          q.difficulty = 'easy';
        } else if (index < (totalQuestions * 2) / 3) {
          q.difficulty = 'medium';
        } else {
          q.difficulty = 'hard';
        }
        q.points = 10;
      });
      
      return validQuestions;
    }

    function addQuestionFieldToPassage() {
      const list = document.getElementById('passageQuestionsList');
      const index = list.children.length;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const cardColor = window.elementSdk?.config?.card_surface_color || defaultConfig.card_surface_color;
      const textColor = window.elementSdk?.config?.text_color || defaultConfig.text_color;
      
      const div = document.createElement('div');
      div.className = 'passage-question-item p-4 rounded-lg mb-4';
      div.style.backgroundColor = cardColor;
      div.innerHTML = `
        <div class="flex justify-between mb-2">
          <span class="font-bold">Ø³Ø¤Ø§Ù„ ${index + 1}</span>
          ${index > 0 ? `<button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-500 text-sm">Ø­Ø°Ù</button>` : ''}
        </div>
        <input type="text" name="pq_text_${index}" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" class="w-full p-2 rounded mb-2 outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <input type="text" name="pq_opt_a_${index}" placeholder="Ø£" class="w-full p-2 rounded outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
          <input type="text" name="pq_opt_b_${index}" placeholder="Ø¨" class="w-full p-2 rounded outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
          <input type="text" name="pq_opt_c_${index}" placeholder="Ø¬" class="w-full p-2 rounded outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
          <input type="text" name="pq_opt_d_${index}" placeholder="Ø¯" class="w-full p-2 rounded outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
        </div>
        <div class="flex gap-2">
          <select name="pq_correct_${index}" class="w-1/2 p-2 rounded outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
            <option value="">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</option>
            <option value="A">Ø£</option>
            <option value="B">Ø¨</option>
            <option value="C">Ø¬</option>
            <option value="D">Ø¯</option>
          </select>
          <input type="number" name="pq_points_${index}" value="10" placeholder="Ø§Ù„Ù†Ù‚Ø§Ø·" class="w-1/2 p-2 rounded outline-none" style="background-color: ${bgColor}; color: ${textColor};" required>
        </div>
      `;
      list.appendChild(div);
    }

    async function saveReadingWithQuestions(questions) {
      if (!currentUser) {
        showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }

      showLoader('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

      try {
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const questionsToSave = questions.map(q => ({
          ...q,
          user_id: currentUser.user_id,
          created_by: currentUser.username,
          created_at: q.created_at || new Date().toISOString(),
          // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          points_value: q.points_value ?? (q.question_type === 'reading' ? 0 : 10),
          difficulty_level: q.difficulty_level ?? 'medium'
        }));

        // 1. Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)
        for (const q of questionsToSave) {
          await window.dataSdk.create(q);
        }

        // 2. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
        const { error } = await supabaseSdk.client
          .from('questions')
          .insert(questionsToSave.map(q => ({
            question_id: q.question_id,
            question_type: q.question_type,
            question_text: q.question_text ?? null,
            answer_a: q.answer_a ?? null,
            answer_b: q.answer_b ?? null,
            answer_c: q.answer_c ?? null,
            answer_d: q.answer_d ?? null,
            correct_answer: q.correct_answer ?? null,
            grade: q.grade,
            semester: q.semester,
            subject: q.subject,
            skill_id: q.skill_id,
            city_id: q.city_id,
            points_value: q.points_value,
            difficulty_level: q.difficulty_level,
            created_by: q.created_by,
            created_at: q.created_at,
            user_id: q.user_id,
            reading_text: q.reading_text,
            reading_title: q.reading_title,
            reading_parent_id: q.reading_parent_id
          })));

        hideLoader();

        if (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡:', error);
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· (Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±)', 'warning');
        } else {
          console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ ÙˆØ£Ø³Ø¦Ù„ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ ÙˆØ£Ø³Ø¦Ù„ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­ ğŸ“–âœ…', 'success');
        }
      } catch (e) {
        hideLoader();
        console.error(e);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸', 'error');
      }
    }

    async function saveQuestionsSafe(questions) {
      const payload = questions.map(q => ({
        question_id: q.question_id,
        question_type: q.question_type,
        question_text: q.question_text ?? null,
        answer_a: q.answer_a ?? null,
        answer_b: q.answer_b ?? null,
        answer_c: q.answer_c ?? null,
        answer_d: q.answer_d ?? null,
        correct_answer: q.correct_answer ?? null,
        grade: q.grade,
        semester: q.semester,
        subject: q.subject,
        skill_id: q.skill_id,
        city_id: q.city_id,
        created_at: new Date().toISOString(),
        user_id: q.user_id,
        reading_text: q.reading_text,
        reading_title: q.reading_title,
        reading_parent_id: q.reading_parent_id
      }));

      const { error } = await supabaseSdk.client
        .from('questions')
        .insert(payload);

      if (error) {
        console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
        showToast(error.message, 'error');
      } else {
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©');
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©', 'success');
      }
    }

    async function syncUserSafe(user) {
      const payload = {
        user_id: user.user_id,
        username: user.username,
        full_name: user.full_name,
        user_type: user.user_type,
        is_approved: user.is_approved ?? true,
        grade: user.grade ?? null,
        semester: user.semester ?? null,
        total_points: user.total_points ?? 0,
        stars_collected: user.stars_collected ?? 0,
        skills_mastered: user.skills_mastered ?? 0,
        current_level: user.current_level ?? 1,
        last_login: new Date().toISOString(),
        progress_data: user.progress_data ?? {},
        created_at: user.created_at ?? new Date().toISOString()
      };

      const { error } = await supabaseSdk.client
        .from('users')
        .upsert(payload, { onConflict: 'user_id' });

      if (error) {
        console.error('âŒ Users Sync Error:', error);
      }
    }

    function triggerJsonImport() {
      document.getElementById('jsonFileInput').click();
    }

    async function handleJsonImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const questionsToSave = JSON.parse(e.target.result);
          if (!Array.isArray(questionsToSave)) {
            throw new Error('Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          }
          await saveReadingWithQuestions(questionsToSave);
          event.target.value = ''; // Reset input
        } catch (err) {
          showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function createReading({
      title,
      text,
      grade,
      semester,
      subject,
      skill_id,
      city_id
    }) {
      return {
        question_id: generateUUID(),
        question_type: 'reading',
        reading_title: title.trim(),
        reading_text: text.trim(),
        question_text: title.trim(),
        grade,
        semester,
        subject,
        skill_id,
        city_id,
        difficulty_level: 'easy',
        points_value: 0,
        created_at: new Date().toISOString()
      };
    }

    function createReadingQuestion({
      readingId,
      questionText,
      answers,
      correctAnswer,
      grade,
      semester,
      subject,
      skill_id,
      city_id
    }) {
      return {
        question_id: generateUUID(),
        question_type: 'multiple_choice',
        question_text: questionText.trim(),
        answer_a: answers.a,
        answer_b: answers.b,
        answer_c: answers.c,
        answer_d: answers.d,
        correct_answer: correctAnswer, // A | B | C | D
        reading_parent_id: readingId, // ğŸ”— Ø§Ù„Ø±Ø¨Ø·
        grade,
        semester,
        subject,
        skill_id,
        city_id,
        created_at: new Date().toISOString()
      };
    }

    function openReadingModal(currentReading) {
      if (currentUser && currentReading) {
        studentProgressKey = `progress_${currentUser.user_id}_${currentReading.question_id}`;
      }
      const modal = document.getElementById('reading-modal');
      if (modal) {
        document.getElementById('modal-reading-title').textContent = currentReading.reading_title;
        document.getElementById('modal-reading-text').innerHTML = currentReading.reading_text;
        modal.style.display = 'flex';
      }
    }

    function closeReadingModal() {
      const modal = document.getElementById('reading-modal');
      if (modal) modal.style.display = 'none';
    }

    function loadReadingForStudent(skillId) {
      // 1ï¸âƒ£ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡
      const reading = questions.find(q =>
        q.question_type === "reading" &&
        q.skill_id === skillId
      );

      if (!reading) return null;

      // 2ï¸âƒ£ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙÙ‡Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
      const quizQuestions = questions.filter(q =>
        q.reading_parent_id === reading.question_id
      );

      return {
        reading,
        questions: quizQuestions
      };
    }

    async function saveReadingPassageWithQuestions(event) {
      event.preventDefault();
      const btn = document.getElementById('saveReadingPassageBtn');
      btn.disabled = true;
      btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

      const unitId = document.getElementById('readingUnitId').value;
      const title = document.getElementById('readingPassageTitle').value.trim();
      const content = document.getElementById('readingPassageContent').value.trim();
      
      const readingId = generateUUID();
      
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      const questionItems = document.querySelectorAll('.passage-question-item');
      const newQuestions = [];
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
      let currentGrade = currentUser.grade || 'grade3';
      let currentSemester = 'semester1';
      let currentCity = gameState.selectedCity;
      let currentSubject = 'general';
      
      for (const [key, val] of Object.entries(islands)) {
        if (val.cities.some(c => c.id === gameState.selectedCity)) {
          currentSemester = key;
          break;
        }
      }
      if (gameState.selectedCity.includes('math')) currentSubject = 'math';
      else if (gameState.selectedCity.includes('science')) currentSubject = 'science';
      else if (gameState.selectedCity.includes('arabic')) currentSubject = 'arabic';

      questionItems.forEach((item, index) => {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Selectors Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­Ø©
        const text = item.querySelector('input[name^="pq_text_"]').value;
        const optA = item.querySelector('input[name^="pq_opt_a_"]').value;
        const optB = item.querySelector('input[name^="pq_opt_b_"]').value;
        const optC = item.querySelector('input[name^="pq_opt_c_"]').value;
        const optD = item.querySelector('input[name^="pq_opt_d_"]').value;
        const correct = item.querySelector('select[name^="pq_correct_"]').value;
        const points = item.querySelector('input[name^="pq_points_"]').value;

        if (text && optA && optB && optC && optD && correct) {
          newQuestions.push({
            question_id: generateUUID(),
            user_id: currentUser.user_id,
            question_text: text,
            question_type: 'multiple_choice',
            skill_id: unitId,
            city_id: currentCity,
            difficulty_level: 'medium',
            answer_a: optA,
            answer_b: optB,
            answer_c: optC,
            answer_d: optD,
            correct_answer: correct,
            points_value: parseInt(points) || 10,
            grade: currentGrade,
            semester: currentSemester,
            subject: currentSubject,
            created_by: currentUser.username,
            created_at: new Date().toISOString(),
            // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡
            reading_text: content || null,
            reading_title: title || null
          });
        }
      });

      if (newQuestions.length === 0) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©';
        return;
      }

      // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ ÙƒØ¹Ù†ØµØ± Ù…Ø³ØªÙ‚Ù„
      newQuestions.push({
        question_id: readingId,
        user_id: currentUser.user_id,
        question_type: 'reading',
        reading_title: title,
        reading_text: content,
        skill_id: unitId,
        city_id: currentCity,
        grade: currentGrade,
        semester: currentSemester,
        subject: currentSubject,
        created_by: currentUser.username,
        created_at: new Date().toISOString(),
        question_text: title,
        points_value: 0
      });

      // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      for (const q of newQuestions) {
        await window.dataSdk.create(q);
      }
      const { error } = await supabaseSdk.client.from('questions').insert(newQuestions.map(({__backendId, ...q}) => q));

      showToast(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ùˆ ${newQuestions.length} Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
      document.getElementById('readingPassageForm').reset();
      document.getElementById('passageQuestionsList').innerHTML = '';
      renderCurrentScreen();
    }

    async function deleteQuestion(backendId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
      const questionToDelete = questions.find(q => q.__backendId === backendId);
      if (!questionToDelete) return;
      
      showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
      
      // 1. Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„Ø§Ù‹
      const { error } = await supabaseSdk.client.from('questions').delete().eq('question_id', questionToDelete.question_id);
      
      hideLoader();

      if (error) {
        console.error('Supabase Delete Error:', error);
        showToast(`ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: ${error.message}`, 'error');
        return;
      }
      
      // 2. Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠØ§Ù‹
      await window.dataSdk.delete(questionToDelete);
      showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      cancelEditQuestion(); // Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      renderCurrentScreen();
    }

    async function addCastle(event) {
      event.preventDefault();
      
      try {
      const selectedGrade = document.getElementById('lc_grade').value;
      const selectedSubject = document.getElementById('lc_subject').value;
      const castleTitle = document.getElementById('lc_title').value;
      const learningOutcome = document.getElementById('lc_outcome').value;
      const videoUrl = document.getElementById('lc_video').value;
      const currentTeacherId = currentUser.user_id;
      
      const videoInfo = processYouTubeUrl(videoUrl);
      if (!videoInfo.videoId) {
        showToast('Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
      }
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
      const orderIndex = (learningCastles && learningCastles.length > 0)
        ? Math.max(...learningCastles.map(c => c.order_index || 0)) + 1 
        : 1;

      if (!selectedGrade || !selectedSubject || !castleTitle || !learningOutcome || !videoUrl) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
      }

      if (editingCastleId) {
        // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const castleToUpdate = learningCastles.find(c => c.__backendId === editingCastleId);
        if (castleToUpdate) {
            const updates = {
                grade: selectedGrade,
                subject: selectedSubject,
                title: castleTitle,
                learning_outcome: learningOutcome,
                video_url: videoUrl
            };
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
            Object.assign(castleToUpdate, updates);
            window.dataSdk.saveToStorage();
            
            // ØªØ­Ø¯ÙŠØ« ÙÙŠ Supabase (Ø§Ø³ØªØ®Ø¯Ø§Ù… upsert Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù‚Ù„Ø¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹)
            const { __backendId, ...supabaseRecord } = castleToUpdate;
            
            const { error } = await supabaseSdk.client
                .from("learning_castles")
                .upsert(supabaseRecord, { onConflict: 'id' });

            if (!error) {
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ”„", "success");
            } else {
                console.error(error);
                showToast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...)", "warning");
            }
            cancelEditCastle();
        }
      } else {
        // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        const newCastle = {
            id: generateUUID(),
            grade: selectedGrade,
            subject: selectedSubject,
            title: castleTitle,
            learning_outcome: learningOutcome,
            video_url: videoUrl,
            order_index: orderIndex,
            created_by: currentTeacherId,
            is_active: true,
            created_at: new Date().toISOString()
        };

        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
        await window.dataSdk.create(newCastle);

        // Ø­ÙØ¸ ÙÙŠ Supabase
        const { __backendId, ...supabaseData } = newCastle;
        const { error } = await supabaseSdk.client
            .from("learning_castles")
            .insert([supabaseData]);

        if (!error) {
            showToast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ°", "success");
        } else {
            console.error(error);
            if (error.code === '42501') {
                showToast("Ø®Ø·Ø£ ØµÙ„Ø§Ø­ÙŠØ§Øª (RLS): ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
            } else {
                showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)", "warning");
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('lc_title').value = '';
        document.getElementById('lc_outcome').value = '';
        document.getElementById('lc_video').value = '';
        renderCurrentScreen();
      }
      } catch (err) {
        console.error("Add Castle Error:", err);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: " + (err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"), "error");
      }
    }

    async function deleteLearningCastle(backendId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù„Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
      const item = learningCastles.find(c => c.__backendId === backendId);
      if (!item) return;

      showLoader('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ù„Ø¹Ø©...');
      const { error } = await supabaseSdk.client.from('learning_castles').delete().eq('id', item.id);
      hideLoader();

      if (error) {
        console.error('Supabase Delete Error:', error);
        showToast(`ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: ${error.message}`, 'error');
        return;
      }

      await window.dataSdk.delete(item);
      showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
      renderCurrentScreen();
    }

    function refreshChallengeState() {
      showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„...', 'info');
      if (questionTimer) clearInterval(questionTimer);
      showQuestion(gameState.currentQuestionIndex);
    }

    async function clearTable(tableName) {
      const tableMap = {
        'questions': 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©',
        'learning_castles': 'Ø§Ù„Ù‚Ù„Ø§Ø¹',
        'users': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
        'student_questions_history': 'Ø³Ø¬Ù„ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨'
      };
      
      const name = tableMap[tableName] || tableName;
      
      if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙˆÙ„ [${name}]ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) return;
      
      const confirmation = prompt(`Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§ÙƒØªØ¨ "Ø­Ø°Ù" ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡:`);
      if (confirmation !== 'Ø­Ø°Ù') {
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'info');
        return;
      }
      
      showLoader(`Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù ${name}...`);
      
      try {
        let query = supabaseSdk.client.from(tableName).delete();
        
        if (tableName === 'users') {
           query = query.neq('user_id', currentUser.user_id);
        } else if (tableName === 'questions') {
           query = query.neq('question_id', '00000000-0000-0000-0000-000000000000');
        } else if (tableName === 'learning_castles') {
           query = query.neq('id', '00000000-0000-0000-0000-000000000000');
        } else if (tableName === 'student_questions_history') {
           query = query.neq('user_id', '00000000-0000-0000-0000-000000000000');
        }
        
        const { error } = await query;
        if (error) throw error;
        
        await supabaseSdk.syncData(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        showToast(`ØªÙ… ØªÙØ±ÙŠØº Ø¬Ø¯ÙˆÙ„ ${name} Ø¨Ù†Ø¬Ø§Ø­ âœ…`, 'success');
        
      } catch (err) {
        console.error(err);
        showToast(`ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ${err.message}`, 'error');
      } finally {
        hideLoader();
      }
    }

    async function loadAllCastlesWithVideos() {
        const { data: castles, error } = await supabaseSdk.client
            .from('learning_castles')
            .select('*')
            .eq('is_active', true)
            .order('order_index');
        
        if (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù„Ø§Ø¹:', error);
            showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù„Ø§Ø¹', 'error');
            return;
        }
        
        const container = document.getElementById('castles-list');
        if (!container) return;
        container.innerHTML = '';
        
        const config = window.elementSdk?.config || defaultConfig;
        
        castles.forEach(castle => {
            const videoInfo = processYouTubeUrl(castle.video_url);
            const thumbnail = castle.video_thumbnail || videoInfo.thumbnail;
            const videoId = castle.video_id || videoInfo.videoId;
            const playlistId = castle.playlist_id || videoInfo.playlistId;
            
            const castleElement = `
                <div class="castle-item" data-id="${castle.id}" style="background-color: ${config.card_surface_color}; color: ${config.text_color};">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;">${castle.title}</h3>
                    <p style="opacity: 0.8; font-size: 0.875rem; margin-bottom: 1rem;">${castle.subject} - ${castle.grade}</p>
                    
                    ${thumbnail ? `
                        <div class="video-preview">
                            <img src="${thumbnail}" 
                                 alt="${castle.title}"
                                 onclick="playVideo('${videoId}', '${playlistId || ''}')">
                            <div class="play-overlay" onclick="playVideo('${videoId}', '${playlistId || ''}')">â–¶</div>
                        </div>
                    ` : ''}
                    
                    <p style="margin-top: 1rem; opacity: 0.9;">${castle.learning_outcome}</p>
                    <button onclick="playVideo('${videoId}', '${playlistId || ''}')" 
                        style="background-color: ${config.primary_action_color}; color: ${config.text_color};"
                        class="mt-4 px-4 py-2 rounded-lg font-bold w-full hover:opacity-90 transition-all">
                        Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    </button>
                </div>
            `;
            
            container.innerHTML += castleElement;
        });
    }

    function playVideo(videoId, playlistId = '') {
        if (!videoId) {
            showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù…ØªØ§Ø­', 'error');
            return;
        }
        let url = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
        
        if (playlistId) {
            url += `&list=${playlistId}`;
        }
        
        const modal = document.getElementById('video-modal');
        const playerContainer = document.getElementById('player-modal');
        
        if (modal && playerContainer) {
            playerContainer.innerHTML = '<div id="modal-yt-player"></div>';
            modal.style.display = 'flex';
            
            const fullUrl = `https://www.youtube.com/watch?v=${videoId}${playlistId ? `&list=${playlistId}` : ''}`;

            const runPlayer = () => {
                 new YT.Player('modal-yt-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1,
                        'rel': 0,
                        'list': playlistId || undefined,
                        'listType': playlistId ? 'playlist' : undefined
                    },
                    events: {
                        'onReady': (event) => {
                            event.target.getIframe().dataset.videoUrl = fullUrl;
                        },
                        'onError': window.onPlayerError
                    }
                });
            };

            if (window.YT && window.YT.Player) {
                runPlayer();
            } else {
                if (!document.getElementById('yt-api-script')) {
                    const tag = document.createElement('script');
                    tag.id = 'yt-api-script';
                    tag.src = "https://www.youtube.com/iframe_api";
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                }
                const oldReady = window.onYouTubeIframeAPIReady;
                window.onYouTubeIframeAPIReady = () => {
                    if (oldReady) oldReady();
                    runPlayer();
                };
            }
        }
    }

    async function openVideoModal(youtubeUrl) {
      const data = processYouTubeUrl(youtubeUrl);

      if (!data.videoId) {
        showToast('âš ï¸ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
      }

      showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');

      const canEmbed = await checkYouTubeEmbeddable(data.videoId);

      hideLoader();

      if (!canEmbed) {
        showToast('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨', 'warning');

        // ÙØªØ­Ù‡ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
        window.open(`https://www.youtube.com/watch?v=${data.videoId}`, '_blank');
        return;
      }

      const player = document.getElementById('player-modal');
      player.innerHTML = `
        <iframe
          src="${data.embedUrl}?autoplay=1&rel=0&modestbranding=1"
          allow="autoplay; encrypted-media; picture-in-picture"
          allowfullscreen>
        </iframe>
      `;

      document.getElementById('video-modal').style.display = 'flex';
    }

    function closeVideoModal() {
        const modal = document.getElementById('video-modal');
        const player = document.getElementById('player-modal');

        modal.style.display = 'none';
        player.innerHTML = ''; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØªÙ…Ø§Ù…Ù‹Ø§
    }

    function openImageZoom(src) {
      const modal = document.getElementById('image-zoom-modal');
      const img = document.getElementById('zoomed-image');
      if (modal && img) {
        img.src = src;
        modal.style.display = 'flex';
      }
    }

    function closeImageZoom() {
      const modal = document.getElementById('image-zoom-modal');
      if (modal) modal.style.display = 'none';
    }

    function editLearningCastle(backendId) {
      const castle = learningCastles.find(c => c.__backendId === backendId);
      if (!castle) return;

      editingCastleId = castle.__backendId;

      document.getElementById('lc_grade').value = castle.grade;
      document.getElementById('lc_subject').value = castle.subject;
      document.getElementById('lc_title').value = castle.title;
      document.getElementById('lc_outcome').value = castle.learning_outcome;
      document.getElementById('lc_video').value = castle.video_url;

      document.getElementById('formTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ù„Ø¹Ø©';
      const submitBtn = document.querySelector('#admin_learning_outcomes_form button[type="submit"]');
      if(submitBtn) {
          submitBtn.innerHTML = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù„Ø¹Ø©';
          submitBtn.classList.remove('pulse-glow');
      }
      
      let cancelBtn = document.getElementById('cancelEditBtn');
      if (!cancelBtn) {
          cancelBtn = document.createElement('button');
          cancelBtn.id = 'cancelEditBtn';
          cancelBtn.type = 'button';
          cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
          cancelBtn.className = 'w-full py-3 rounded-lg font-bold hover:opacity-90 transition-all mt-2';
          cancelBtn.style.backgroundColor = '#ef4444';
          cancelBtn.style.color = '#ffffff';
          cancelBtn.onclick = cancelEditCastle;
          
          const form = document.getElementById('admin_learning_outcomes_form');
          if (form) form.appendChild(cancelBtn);
      }
      
      document.getElementById('admin_learning_outcomes_form').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEditCastle() {
      editingCastleId = null;
      renderCurrentScreen(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø© Ù„ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ©
    }

    function startUnit(unitId) {
      const unitQuestions = questions.filter(q => q.skill_id === unitId && q.city_id === gameState.currentCastle);
      
      gameState.currentUnit = unitId;
      currentScreen = 'lesson';
      renderCurrentScreen();
    }

    async function enterLevel(level) {
      showLoader('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...');
      
      let levelQuestions = [];
      const currentGrade = gameState.selectedGrade;
      const currentCity = gameState.currentCastle;
      
      // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØªØŒ Ø£Ùˆ Ø¬Ù„Ø¨Ù‡Ø§ Ø§Ù„Ø¢Ù†
      let result = { isOk: false };
      if (gameState.pendingQuestionsPromise) {
          try {
              result = await gameState.pendingQuestionsPromise;
          } catch(e) { console.error("Prefetch error", e); }
          gameState.pendingQuestionsPromise = null;
      } else {
          if (questions.length === 0) await supabaseSdk.syncData();
          result = await supabaseSdk.loadLevelQuestions(level, currentGrade, currentCity);
      }

      if (result.isOk && result.data && result.data.length > 0) {
        levelQuestions = result.data;
      }
      
      // 2. Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      if (levelQuestions.length === 0) {
        const localQuestions = questions.filter(q => 
          q.skill_id === level && 
          q.city_id === currentCity && 
          q.grade === currentGrade
        );
        if (localQuestions.length > 0) {
          levelQuestions = localQuestions.sort(() => Math.random() - 0.5).slice(0, 10);
        }
      }
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: ÙØµÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§
      const readingPassages = levelQuestions.filter(q => q.question_type === 'reading');
      if (readingPassages.length > 0) {
        // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø­Ù„
        let quizQuestions = levelQuestions.filter(q => q.question_type !== 'reading');
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†
        quizQuestions = quizQuestions.map(q => {
          if (q.reading_parent_id) {
            const parent = readingPassages.find(r => r.question_id === q.reading_parent_id);
            if (parent) {
              return {
                ...q,
                reading_text: parent.reading_text || q.reading_text,
                reading_title: parent.reading_title || q.reading_title
              };
            }
          }
          return q;
        });
        levelQuestions = quizQuestions;
      }
      
      // 3. Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© (Ù„Ù„Ø¯ÙŠÙ…Ùˆ)
      if (levelQuestions.length === 0) {
        levelQuestions = [
          {
            question_text: "Ù…Ø§ Ù†Ø§ØªØ¬ Ø¬Ù…Ø¹ Ù¨ + Ù¥ØŸ",
            answer_a: "Ù¡Ù¡",
            answer_b: "Ù¡Ù¢",
            answer_c: "Ù¡Ù£",
            answer_d: "Ù¡Ù¤",
            correct_answer: "C",
            points_value: 10,
            difficulty_level: "easy",
            explanation: "Ù¨ + Ù¥ = Ù¡Ù£",
            question_id: "test1"
          },
          {
            question_text: "Ù…Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø°ÙŠ ÙŠÙ„ÙŠ Ù©Ù©ØŸ",
            answer_a: "Ù©Ù¨",
            answer_b: "Ù¡Ù Ù ",
            answer_c: "Ù¡Ù Ù¡",
            answer_d: "Ù¡Ù¡Ù ",
            correct_answer: "B",
            points_value: 10,
            difficulty_level: "easy",
            explanation: "Ø¨Ø¹Ø¯ Ù©Ù© ÙŠØ£ØªÙŠ Ù¡Ù Ù ",
            question_id: "test2"
          },
          {
            question_text: "Ù…Ø§ Ù†Ø§ØªØ¬ Ø·Ø±Ø­ Ù¡Ù¥ - Ù§ØŸ",
            answer_a: "Ù¦",
            answer_b: "Ù§",
            answer_c: "Ù¨",
            answer_d: "Ù©",
            correct_answer: "C",
            points_value: 10,
            difficulty_level: "easy",
            explanation: "Ù¡Ù¥ - Ù§ = Ù¨",
            question_id: "test3"
          }
        ];
      }
      
      if (!levelQuestions.length) {
        hideLoader();
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©', 'error');
        return;
      }

      // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
      supabaseSdk.saveQuestionsToHistory(levelQuestions, level); // Ù„Ø§ Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„

      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      gameState.currentQuestions = levelQuestions;
      gameState.correctAnswers = 0;
      gameState.selectedAnswer = null;
      
      hideLoader();
      currentScreen = 'challenge';
      showQuestion(0);
    }

    function saveStudentProgress() {
      const progressData = {
        questionIndex: gameState.currentQuestionIndex,
        timeLeft,
        updatedAt: new Date().toISOString()
      };

      if (studentProgressKey) {
        localStorage.setItem(
          studentProgressKey,
          JSON.stringify(progressData)
        );
      }
    }

    function loadStudentProgress() {
      const saved = localStorage.getItem(studentProgressKey);
      if (!saved) return false;

      const data = JSON.parse(saved);
      gameState.currentQuestionIndex = data.questionIndex ?? 0;
      timeLeft = data.timeLeft ?? 45;

      return true;
    }

    function startReadingQuiz() {
      const hasProgress = loadStudentProgress();
      showQuestion(gameState.currentQuestionIndex);
    }

    function finishQuizEarly() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        if (questionTimer) clearInterval(questionTimer);
        finishLevel();
      }
    }

    function showQuestion(index) {
      gameState.currentQuestionIndex = index;
      renderCurrentScreen();
      startQuestionTimer(handleTimeUp);
    }

    function goToNextQuestion() {
      saveStudentProgress();
      const nextIndex = gameState.currentQuestionIndex + 1;
      gameState.selectedAnswer = null;
      
      if (nextIndex >= gameState.currentQuestions.length) {
        finishLevel();
      } else {
        showQuestion(nextIndex);
      }
    }

    function startChallenge() {
      enterLevel(gameState.currentUnit);
    }

    function selectAnswer(answerKey) {
      gameState.selectedAnswer = answerKey;
      const primaryColor = window.elementSdk?.config?.primary_action_color || defaultConfig.primary_action_color;
      
      ['A', 'B', 'C', 'D'].forEach(key => {
        const btn = document.getElementById(`answerBtn${key}`);
        if (btn) {
          btn.style.borderColor = key === answerKey ? primaryColor : 'transparent';
        }
      });
      
      const submitBtn = document.getElementById('submitAnswerBtn');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        submitBtn.style.opacity = '1';
      }
    }

    function submitAnswer() {
      if (!gameState.selectedAnswer) return;
      
      if (questionTimer) clearInterval(questionTimer); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
      
      const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
      
      if (gameState.selectedAnswer === currentQ.correct_answer) {
        gameState.correctAnswers++;
        showToast('Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! ğŸ‰', 'success');
        playCorrectSound();
        supabaseSdk.recordHistory(currentQ.__backendId || currentQ.question_id, true, gameState.currentUnit);
      } else {
        showToast(`Ø®Ø·Ø£! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${currentQ.correct_answer}`, 'error');
        playWrongSound();
        supabaseSdk.recordHistory(currentQ.__backendId || currentQ.question_id, false, gameState.currentUnit);
      }
      
      setTimeout(() => {
        goToNextQuestion();
      }, 1500);
    }

    function retryUnit() {
      currentScreen = 'lesson';
      renderCurrentScreen();
    }
    
    function finishQuiz() {
      clearInterval(questionTimer);
      if (studentProgressKey) localStorage.removeItem(studentProgressKey);

      showToast("Ø£Ø­Ø³Ù†Øª ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", "success");
    }

    function finishLevel() {
      finishQuiz();
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ (50% ÙØ£ÙƒØ«Ø±)
      const percentage = (gameState.correctAnswers / gameState.currentQuestions.length * 100);
      const isPassed = percentage >= 50;

      if (isPassed) {
        if (!gameState.completedSkills.includes(gameState.currentUnit)) {
          gameState.completedSkills.push(gameState.currentUnit);
          
          // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (currentUser && currentUser.user_type === 'student') {
            currentUser.skills_mastered = (currentUser.skills_mastered || 0) + 1;
            currentUser.total_points = (currentUser.total_points || 0) + 
              (gameState.currentQuestions.reduce((sum, q) => sum + (q.points_value || 0), 0) * 
              (gameState.correctAnswers / gameState.currentQuestions.length));
            currentUser.stars_collected = (currentUser.stars_collected || 0) + 
              Math.floor(gameState.correctAnswers / gameState.currentQuestions.length * 3);
            
            // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„Ø£Ø³Ø¦Ù„Ø©) Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø­ÙØ¸
            const stateToSave = { ...gameState };
            stateToSave.currentQuestions = [];
            stateToSave.challengeData = null;

            currentUser.progress_data = JSON.stringify(stateToSave);
            window.dataSdk.update(currentUser);
            // Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…
            syncUserSafe(currentUser);
          }
        }
      }
      currentScreen = 'results';
      renderCurrentScreen();
    }

    function updateTimerUI(time) {
      const timerDisplay = document.getElementById('timerDisplay');
      if (timerDisplay) {
        timerDisplay.textContent = time;
        if (time <= 10) {
          timerDisplay.style.color = '#ef4444';
          timerDisplay.classList.add('pulse-glow');
        } else {
          timerDisplay.style.color = window.elementSdk?.config?.text_color || defaultConfig.text_color;
          timerDisplay.classList.remove('pulse-glow');
        }
      }

      const qTimer = document.getElementById('question-timer');
      if (qTimer) {
        qTimer.textContent = time;
        if (time <= 10) {
          qTimer.classList.remove('text-yellow-400');
          qTimer.classList.add('text-red-500', 'pulse-glow');
        } else {
          qTimer.classList.add('text-yellow-400');
          qTimer.classList.remove('text-red-500', 'pulse-glow');
        }
      }
    }

    function playWarningSound() {
      const sound = document.getElementById("warning-sound");
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(() => {});
      }
    }

    function playCorrectSound() {
      if (isMuted) return;
      const audio = document.getElementById('correct-sound');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio play failed', e));
      }
    }

    function playWrongSound() {
      if (isMuted) return;
      const audio = document.getElementById('wrong-sound');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio play failed', e));
      }
    }

    function playClickSound() {
      if (isMuted) return;
      const audio = document.getElementById('click-sound');
      if (audio) {
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      const btn = document.getElementById('muteBtn');
      if (btn) {
        btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      }
      localStorage.setItem('rhlat_isMuted', isMuted);
    }

    function onPlayerStateChange(event) {
      // 0 = YT.PlayerState.ENDED
      if (event.data === 0) {
        const btn = document.getElementById('startBtn');
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
          btn.classList.add('pulse-glow', 'hover:opacity-90');
          btn.textContent = 'â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ';
          
          // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø£Ø³Ø¦Ù„Ø©
          startChallenge();
        }
      }
    }

    function onPlayerError(event) {
      // 150, 101, 153: ØªØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ
      if ([100, 101, 150, 153, 5].includes(event.data)) {
        const iframe = event.target.getIframe();
        if (!iframe) return;
        
        const parent = iframe.parentElement;
        let videoUrl = '';
        
        try { videoUrl = event.target.getVideoUrl(); } catch(e){}
        
        if (!videoUrl && iframe.id === 'lessonVideo') {
             const currentCastleData = learningCastles.find(c => (c.id === gameState.currentUnit || c.__backendId === gameState.currentUnit));
             videoUrl = currentCastleData?.video_url;
        } else if (!videoUrl && iframe.dataset.videoUrl) {
             videoUrl = iframe.dataset.videoUrl;
        }
        
        const config = window.elementSdk?.config || defaultConfig;
        const bgColor = config.card_surface_color || '#334155';
        const textColor = config.text_color || '#f8fafc';
        const isTeacher = currentUser && (currentUser.user_type === 'teacher' || currentUser.user_type === 'admin');
        const isLesson = iframe.id === 'lessonVideo';

        if (videoUrl) {
            parent.innerHTML = `
                 <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background-color: ${bgColor}; color: ${textColor}; padding: 20px; text-align: center; border-radius: 12px;">
                   <p style="margin-bottom: 15px; font-size: 18px; font-weight: bold;">âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ ÙŠÙˆØªÙŠÙˆØ¨.</p>
                   <a href="${videoUrl}" target="_blank" ${isLesson ? 'onclick="enableStartButton()"' : ''}
                      style="background-color: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s;">
                      <span>ğŸ“º</span>
                      <span>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¹Ù„Ù‰ YouTube</span>
                   </a>
                   ${isLesson ? `<p style="margin-top: 15px; font-size: 14px; opacity: 0.7;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø«Ù… Ø¹Ø¯ Ù‡Ù†Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ.</p>` : ''}
                   ${isLesson && isTeacher ? `
                     <button onclick="enableStartButton()" style="margin-top: 15px; color: ${textColor}; opacity: 0.5; font-size: 12px; text-decoration: underline; background: none; border: none; cursor: pointer;">
                       ØªØ®Ø·ÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù…Ø´Ø±Ù)
                     </button>
                   ` : ''}
                 </div>
            `;
        }
      }
    }

    function enableStartButton() {
        const btn = document.getElementById('startBtn');
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
          btn.classList.add('pulse-glow', 'hover:opacity-90');
          btn.textContent = 'â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ';
        }
    }

    function triggerLastTenSecondsWarning() {
      const timerEl = document.getElementById("question-timer");
      if (timerEl) {
        // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†
        timerEl.style.animation = "blink 1s infinite";
        timerEl.style.color = "#ef4444"; // Ø£Ø­Ù…Ø±
      }

      // Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
      showToast("â° ØªØ¨Ù‚Ù‰ 10 Ø«ÙˆØ§Ù†Ù ÙÙ‚Ø·!", "warning");

      // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      playWarningSound();
    }

    function startQuestionTimer(onTimeUp) {
      clearInterval(questionTimer);
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©
      const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
      let duration = 45; // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù„Ù„Ù…ØªÙˆØ³Ø·)
      
      if (currentQ) {
        if (currentQ.difficulty_level === 'easy') duration = 30;
        else if (currentQ.difficulty_level === 'hard') duration = 60;
      }
      
      timeLeft = duration;
      updateTimerUI(timeLeft);

      questionTimer = setInterval(() => {
        timeLeft--;
        updateTimerUI(timeLeft);

        // ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø¢Ø®Ø± 10 Ø«ÙˆØ§Ù†Ù
        if (timeLeft === 10) {
          triggerLastTenSecondsWarning();
        }

        if (timeLeft <= 0) {
          clearInterval(questionTimer);
          onTimeUp(); // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        }
      }, 1000);
    }

    function handleTimeUp() {
      showToast('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! â°', 'error');
      const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
      
      // ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©
      supabaseSdk.recordHistory(currentQ.__backendId || currentQ.question_id, false, gameState.currentUnit);
      
      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
      setTimeout(() => {
        goToNextQuestion();
      }, 1000);
    }

    function generateLevelReport({ 
      studentName,
      level,
      totalQuestions,
      correctAnswers
    }) {
      const wrongAnswers = totalQuestions - correctAnswers;
      const percentage = Math.round((correctAnswers / totalQuestions) * 100);

      return `
ğŸ“˜ ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø³ØªÙˆÙ‰

ğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}
ğŸ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${level}
ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${totalQuestions}
âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctAnswers}
âŒ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: ${wrongAnswers}
â­ Ø§Ù„Ù†Ø³Ø¨Ø©: ${percentage}%

ğŸ‘ Ø£Ø­Ø³Ù†Øª! Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„ØªÙ‚Ø¯Ù…
`;
    }

    async function generateCertificatePDF({
      studentName,
      level,
      percentage,
      correctAnswers,
      totalQuestions
    }) {
      // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ÙÙŠ
      document.getElementById('cert-student-name').textContent = studentName;
      document.getElementById('cert-level-name').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${level}`;
      document.getElementById('cert-percentage').textContent = `%${percentage}`;
      document.getElementById('cert-correct').textContent = correctAnswers;
      document.getElementById('cert-date').textContent = new Date().toLocaleDateString('ar-SA');

      const element = document.getElementById('certificate-hidden');
      // Ù†Ø®Ø²Ù† Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø¹Ù†ØµØ±
      const originalLeft = element.style.left;
      
      try {
        showLoader('Ø¬Ø§Ø±ÙŠ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©...');
        // Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ù„Ù…ÙƒØªØ¨Ø© html-to-image:
        // ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† ØªØµÙˆÙŠØ±Ù‡
        // Ø³ÙŠØ¨Ù‚Ù‰ Ù…Ø®ÙÙŠØ§Ù‹ Ù„Ø£Ù†Ù‡ ÙŠÙ…ØªÙ„Ùƒ z-index: -1
        element.style.left = '0px';

        const imgData = await htmlToImage.toPng(element, { pixelRatio: 2 });
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Ø´Ù‡Ø§Ø¯Ø©_${studentName}.pdf`);
        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ“', 'success');
      } catch (err) {
        console.error(err);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©', 'error');
      } finally {
        // Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ù…ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¥Ø®ÙØ§Ø¦Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        element.style.left = originalLeft;
        hideLoader();
      }
    }

    async function refreshDataManual() {
      await supabaseSdk.syncData();
    }

    window.filterStudents = function() {
      const input = document.getElementById('studentSearchInput');
      const filter = input.value.toLowerCase();
      const container = document.getElementById('studentsListContainer');
      const buttons = container.getElementsByClassName('student-card-btn');

      for (let i = 0; i < buttons.length; i++) {
        const txtValue = buttons[i].getAttribute('data-name');
        if (txtValue && txtValue.toLowerCase().indexOf(filter) > -1) {
          buttons[i].style.display = "";
        } else {
          buttons[i].style.display = "none";
        }
      }
    };

    function getCastleTitle(castleId) {
      // 1. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…Ø®ØµØµØ© (learningCastles)
      const customCastle = learningCastles.find(c => c.id === castleId || c.__backendId === castleId);
      if (customCastle) return customCastle.title;

      // 2. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ (skills)
      for (const subject in skills) {
        for (const grade in skills[subject]) {
          const unit = skills[subject][grade].find(u => u.id === castleId);
          if (unit) return unit.name;
        }
      }
      return castleId;
    }

    async function shareLevelReport(reportText) {
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ø§Ù„Ø¨',
            text: reportText
          });
        } catch (err) {
          console.error('Share cancelled', err);
        }
      } else {
        // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø¯Ø¹Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
        await navigator.clipboard.writeText(reportText);
        showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø§Ù„Ø¢Ù† ğŸ“‹', 'success');
      }
    }

    function shareCurrentResult() {
      const levelName = getCastleTitle(gameState.currentUnit);
      const reportText = generateLevelReport({
        studentName: currentUser?.full_name || currentUser?.username || 'Ø·Ø§Ù„Ø¨',
        level: levelName,
        totalQuestions: gameState.currentQuestions.length,
        correctAnswers: gameState.correctAnswers
      });
      shareLevelReport(reportText);
    }

    function shareToWhatsApp() {
      const levelName = getCastleTitle(gameState.currentUnit);
      const reportText = generateLevelReport({
        studentName: currentUser?.full_name || currentUser?.username || 'Ø·Ø§Ù„Ø¨',
        level: levelName,
        totalQuestions: gameState.currentQuestions.length,
        correctAnswers: gameState.correctAnswers
      });
      
      const appUrl = window.location.origin + window.location.pathname;
      const textToShare = `${reportText}\n\nğŸ® Ø§Ù„Ø¹Ø¨ ÙˆØªØ¹Ù„Ù… Ù…Ø¹Ù†Ø§: ${appUrl}`;
      
      const url = `https://wa.me/?text=${encodeURIComponent(textToShare)}`;
      window.open(url, '_blank');
    }

    function downloadCertificate() {
      const levelName = getCastleTitle(gameState.currentUnit);
      generateCertificatePDF({
        studentName: currentUser?.full_name || currentUser?.username || 'Ø·Ø§Ù„Ø¨',
        level: levelName,
        percentage: ((gameState.correctAnswers / gameState.currentQuestions.length) * 100).toFixed(0),
        correctAnswers: gameState.correctAnswers,
        totalQuestions: gameState.currentQuestions.length
      });
    }

    function onLevelCompleted(stats) {
      const percentage = Math.round(
        (stats.correctAnswers / stats.totalQuestions) * 100
      );

      const levelName = getCastleTitle(stats.level);

      const report = generateLevelReport({
        studentName: currentUser.full_name,
        level: levelName,
        totalQuestions: stats.totalQuestions,
        correctAnswers: stats.correctAnswers
      });

      // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      const reportEl = document.getElementById('level_report');
      if (reportEl) reportEl.innerText = report;

      // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
      const shareBtn = document.getElementById('share_report_btn');
      if (shareBtn) {
        shareBtn.onclick = () => {
          shareLevelReport(report);
        };
      }

      const certBtn = document.getElementById('certificate_btn');
      if (certBtn) {
        certBtn.onclick = () => {
          generateCertificatePDF({
            studentName: currentUser.full_name,
            level: levelName,
            percentage,
            correctAnswers: stats.correctAnswers,
            totalQuestions: stats.totalQuestions
          });
        };
      }
    }

    // === Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ ===
    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.logout = logout;
    window.refreshDataManual = refreshDataManual;
    window.goToRegister = goToRegister;
    window.goToLogin = goToLogin;
    window.toggleTeacherCode = toggleTeacherCode;
    window.selectStudentForReport = selectStudentForReport;
    window.promptUpgrade = promptUpgrade;
    window.generateTeacherCode = generateTeacherCode;
    window.copyCode = copyCode;
    window.revokeTeacher = revokeTeacher;
    window.changeAdminGrade = changeAdminGrade;
    window.selectGradeAndContinue = selectGradeAndContinue;
    window.selectSemesterAndContinue = selectSemesterAndContinue;
    window.backToGrade = backToGrade;
    window.backToSemester = backToSemester;
    window.backToSubjects = backToSubjects;
    window.backToCastle = backToCastle;
    window.selectSubject = selectSubject;
    window.selectCityForAdmin = selectCityForAdmin;
    window.goToArabicReading = goToArabicReading;
    window.goToTeacherAdmin = goToTeacherAdmin;
    window.goToLearningOutcomes = goToLearningOutcomes;
    window.addCastle = addCastle;
    window.deleteLearningCastle = deleteLearningCastle;
    window.loadAllCastlesWithVideos = loadAllCastlesWithVideos;
    window.playVideo = playVideo;
    window.openVideoModal = openVideoModal;
    window.closeVideoModal = closeVideoModal;
    window.openImageZoom = openImageZoom;
    window.closeImageZoom = closeImageZoom;
    window.checkYouTubeEmbeddable = checkYouTubeEmbeddable;
    window.editLearningCastle = editLearningCastle;
    window.cancelEditCastle = cancelEditCastle;
    window.editQuestion = editQuestion;
    window.cancelEditQuestion = cancelEditQuestion;
    window.goBackToArabicReading = goBackToArabicReading;
    window.addReadingText = addReadingText;
    window.deleteReadingText = deleteReadingText;
    window.addQuestionsToReading = addQuestionsToReading;
    window.addNewQuestion = addNewQuestion;
    window.removeQuestion = removeQuestion;
    window.saveReadingQuestions = saveReadingQuestions;
    window.syncWithSupabase = syncWithSupabase;
    window.toggleBulkForm = toggleBulkForm;
    window.toggleSingleForm = toggleSingleForm;
    window.toggleReadingPassageForm = toggleReadingPassageForm;
    window.addQuestionFieldToPassage = addQuestionFieldToPassage;
    window.saveReadingWithQuestions = saveReadingWithQuestions;
    window.saveQuestionsSafe = saveQuestionsSafe;
    window.syncUserSafe = syncUserSafe;
    window.triggerJsonImport = triggerJsonImport;
    window.handleJsonImport = handleJsonImport;
    window.createReading = createReading;
    window.createReadingQuestion = createReadingQuestion;
    window.loadReadingForStudent = loadReadingForStudent;
    window.openReadingModal = openReadingModal;
    window.closeReadingModal = closeReadingModal;
    window.saveReadingPassageWithQuestions = saveReadingPassageWithQuestions;
    window.startQuestionTimer = startQuestionTimer;
    window.updateTimerUI = updateTimerUI;
    window.triggerLastTenSecondsWarning = triggerLastTenSecondsWarning;
    window.playWarningSound = playWarningSound;
    window.playCorrectSound = playCorrectSound;
    window.playWrongSound = playWrongSound;
    window.toggleMute = toggleMute;
    window.onPlayerStateChange = onPlayerStateChange;
    window.onPlayerError = onPlayerError;
    window.enableStartButton = enableStartButton;
    window.handleTimeUp = handleTimeUp;
    window.processBulkQuestions = processBulkQuestions;
    window.initUploadPanel = initUploadPanel;
    window.onGradeChange = onGradeChange;
    window.onSubjectChange = onSubjectChange;
    window.toggleQType = toggleQType;
    window.uploadQuestionImage = uploadQuestionImage;
    window.saveQuestion = saveQuestion;
    window.deleteQuestion = deleteQuestion;
    window.startUnit = startUnit;
    window.startChallenge = startChallenge;
    window.enterLevel = enterLevel;
    window.saveStudentProgress = saveStudentProgress;
    window.loadStudentProgress = loadStudentProgress;
    window.startReadingQuiz = startReadingQuiz;
    window.finishQuizEarly = finishQuizEarly;
    window.finishQuiz = finishQuiz;
    window.showQuestion = showQuestion;
    window.goToNextQuestion = goToNextQuestion;
    window.selectAnswer = selectAnswer;
    window.submitAnswer = submitAnswer;
    window.retryUnit = retryUnit;
    window.generateLevelReport = generateLevelReport;
    window.shareCurrentResult = shareCurrentResult;
    window.shareToWhatsApp = shareToWhatsApp;
    window.generateCertificatePDF = generateCertificatePDF;
    window.downloadCertificate = downloadCertificate;
    window.onLevelCompleted = onLevelCompleted;
    window.refreshChallengeState = refreshChallengeState;
    window.clearTable = clearTable;
    window.saveQuestionsToHistory = (q, l) => supabaseSdk.saveQuestionsToHistory(q, l);
    window.goToForgotPassword = goToForgotPassword;
    window.handleForgotPassword = handleForgotPassword;
    window.goToLeaderboard = () => {
      currentScreen = 'leaderboard';
      renderCurrentScreen();
    };
    
    // Challenge Logic
    let challengeInterval = null;

    window.goToChallengeMenu = () => {
      currentScreen = 'challenge_menu';
      renderCurrentScreen();
    };

    window.createNewChallenge = async () => {
      showLoader('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ...');
      // Ø§Ø®ØªÙŠØ§Ø± 10 Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const randomQuestions = questions.sort(() => Math.random() - 0.5).slice(0, 10);
      
      if (randomQuestions.length === 0) {
        hideLoader();
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ø¯ÙŠ', 'error');
        return;
      }

      const challengeId = Math.floor(1000 + Math.random() * 9000).toString(); // Keep numeric for easy joining, ensure DB column is text or int, NOT UUID
      const challengeData = {
        id: challengeId,
        host_username: currentUser.username,
        status: 'waiting',
        questions: randomQuestions,
        host_score: 0,
        guest_score: 0
      };

      const result = await supabaseSdk.createChallenge(challengeData);
      hideLoader();

      if (result.isOk) {
        gameState.challengeData = result.data;
        currentScreen = 'challenge_lobby';
        renderCurrentScreen();
        startChallengePolling();
      } else {
        showToast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ', 'error');
      }
    };

    window.joinExistingChallenge = async () => {
      const code = document.getElementById('joinCodeInput').value;
      if (!code || code.length !== 4) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…', 'error');
        return;
      }

      showLoader('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...');
      const result = await supabaseSdk.joinChallenge(code, currentUser.username);
      hideLoader();

      if (result.isOk) {
        gameState.challengeData = result.data;
        currentScreen = 'challenge_lobby'; // Show lobby briefly or go straight to game if active
        renderCurrentScreen();
        startChallengePolling();
      } else {
        showToast(result.error || 'ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØªØ­Ø¯ÙŠ', 'error');
      }
    };

    function startChallengePolling() {
      if (challengeInterval) clearInterval(challengeInterval);
      
      challengeInterval = setInterval(async () => {
        if (!gameState.challengeData) return;
        
        const { isOk, data } = await supabaseSdk.getChallenge(gameState.challengeData.id);
        if (isOk && data) {
          gameState.challengeData = data;
          
          // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨
          if (currentScreen === 'challenge_lobby' && data.status === 'active') {
            gameState.currentQuestions = data.questions;
            gameState.currentQuestionIndex = 0;
            currentScreen = 'multiplayer_game';
            renderCurrentScreen();
          }
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨
          if (currentScreen === 'multiplayer_game') {
            renderCurrentScreen(); // Re-render to update scores
          }
        }
      }, 2000); // Poll every 2 seconds
    }

    window.cancelChallenge = () => {
      if (challengeInterval) clearInterval(challengeInterval);
      gameState.challengeData = null;
      currentScreen = 'challenge_menu';
      renderCurrentScreen();
    };

    window.selectMultiplayerAnswer = async (answerKey) => {
      const currentQ = gameState.currentQuestions[gameState.currentQuestionIndex];
      const isHost = gameState.challengeData.host_username === currentUser.username;
      
      if (answerKey === currentQ.correct_answer) {
        const currentScore = isHost ? gameState.challengeData.host_score : gameState.challengeData.guest_score;
        const newScore = (currentScore || 0) + 10;
        await supabaseSdk.updateChallengeScore(gameState.challengeData.id, isHost ? 'host' : 'guest', newScore);
        showToast('Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! +10', 'success');
      } else {
        showToast('Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!', 'error');
      }

      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
      if (gameState.currentQuestionIndex < gameState.currentQuestions.length - 1) {
        gameState.currentQuestionIndex++;
        renderCurrentScreen();
      } else {
        showToast('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠ!', 'success');
        setTimeout(() => {
            if (challengeInterval) clearInterval(challengeInterval);
            currentScreen = 'subjects'; // Or a specific challenge result screen
            renderCurrentScreen();
        }, 2000);
      }
    };

    window.updateAppConfig = function(key, value) {
      if (!window.elementSdk.config) window.elementSdk.config = {};
      window.elementSdk.config[key] = value;
      localStorage.setItem('rhlat_' + key, value);
      renderCurrentScreen();
    };

    window.toggleTheme = function(mode) {
      const theme = mode === 'dark' ? {
        background_color: "#1e293b",
        card_surface_color: "#334155",
        text_color: "#f8fafc"
      } : {
        background_color: "#f0f9ff",
        card_surface_color: "#ffffff",
        text_color: "#1e293b"
      };

      Object.entries(theme).forEach(([key, value]) => {
        window.elementSdk.config[key] = value;
        localStorage.setItem('rhlat_' + key, value);
      });
      
      renderCurrentScreen();
    };

    function renderMathQuestion(dbText, outputDiv) {
      if (!dbText) {
        if(outputDiv) outputDiv.innerHTML = '';
        return;
      }
      let res = String(dbText);

      // --- Stage 1: Normalize and handle pre-formatted but incomplete LaTeX ---
      // Fix incomplete LaTeX for frac and sqrt by wrapping them in delimiters
      res = res.replace(/frac\{(.*?)\}\{(.*?)\}/g, '\\(\\frac{$1}{$2}\\)');
      res = res.replace(/sqrt\{(.*?)\}/g, '\\(\\sqrt{$1}\\)');
      res = res.replace(/\btimes\b/g, '\\(\\times\\)');
      res = res.replace(/\\rac{/g, '\\frac{'); // Fix common typo
      res = res.replace(/\\circ/g, '^{\\circ}'); // Normalize degree symbol

      // Helper to convert English digits to Arabic
      const toArabicDigits = (str) => str.replace(/\d/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);

      // Arabic Fraction: ÙƒØ³Ø±_Ø¹Ø±Ø¨ÙŠ(1, 2) -> \frac{Ù¡}{Ù¢}
      res = res.replace(/ÙƒØ³Ø±_Ø¹Ø±Ø¨ÙŠ\s*\(\s*(.*?)\s*[,ØŒ]\s*(.*?)\s*\)/g, (m, n, d) => `\\(\\frac{${toArabicDigits(n)}}{${toArabicDigits(d)}}\\)`);
      // Standard Fraction: ÙƒØ³Ø±(1, 2) -> \frac{1}{2}
      res = res.replace(/ÙƒØ³Ø±\s*\(\s*(.*?)\s*[,ØŒ]\s*(.*?)\s*\)/g, '\\(\\frac{$1}{$2}\\)');

      // --- Stage 2: Convert plain text math to LaTeX, avoiding what's already formatted ---
      const placeholders = [];
      
      // Protect existing MathJax delimiters and URLs
      res = res.replace(/\\\(.*?\\\)|\\\[.*?\\\]|\$\$.*?\$\$|\$.*?\$|https?:\/\/[^\s]+/g, (match) => {
          placeholders.push(match);
          return `__PLACEHOLDER_${placeholders.length - 1}__`;
      });

      // Now, process the remaining plain text
      // Updated to include numbers wrapped in curly braces {123} or {-123}
      const numPattern = '(?:[\\d\\u0660-\\u0669\\u06F0-\\u06F9]+|\\{[-\\d\\u0660-\\u0669\\u06F0-\\u06F9]+\\}|\\\\\\(.*?\\\\\\))';
      const variablePattern = '[a-zA-ZØ³ØµØ¹Ù‚ÙƒØ¶Ø·Ø¸]'; // Added more Arabic letters
      const termPattern = `(?:-?${numPattern}(?:\\.${numPattern})?|${variablePattern}(?:\\^${numPattern})?|${variablePattern}|\\(.*?\\))`;
      
      // Helper to clean nested delimiters
      const clean = (s) => s.replace(/^\\\s*\(\s*(.*)\s*\\\s*\)$/, '$1');

      // Exponents: 5^3 or Ø³^2 or 10^-5 or (x+1)^2
      const expRegex = new RegExp(`(${termPattern})\\s*\\^\\s*(-?${termPattern})`, 'g');
      res = res.replace(expRegex, (m, b, e) => `\\(${clean(b)}^{${clean(e)}}\\)`);

      // Mixed fractions: 1 2/3
      const mixedFracRegex = new RegExp(`(${numPattern})\\s+(${numPattern})\\s*[\\/Ã·]\\s*(${numPattern})`, 'g');
      res = res.replace(mixedFracRegex, `\\($1\\frac{$2}{$3}\\)`);

      // Simple fractions: 1/2 or x/y or (a+b)/(c-d)
      const fracRegex = new RegExp(`(${termPattern})\\s*[\\/Ã·]\\s*(${termPattern})`, 'g');
      res = res.replace(fracRegex, (m, n, d) => `\\(\\frac{${clean(n)}}{${clean(d)}}\\)`);

      // Roots: sqrt(x), Ø¬Ø°Ø±(x), âˆšx
      res = res.replace(/(?:sqrt|Ø¬Ø°Ø±|âˆš)\s*\(\s*(.*?)\s*\)/g, (m, c) => `\\(\\sqrt{${clean(c)}}\\)`);
      // More robust regex for roots without parentheses, captures until a space or operator
      res = res.replace(/(?:sqrt|Ø¬Ø°Ø±|âˆš)\s*([^\s\)\(\+\-\*\/=^<>,.!]+)/g, (m, c) => `\\(\\sqrt{${clean(c)}}\\)`);

      // Percentage and Degree: 50% or 90Â°
      res = res.replace(new RegExp(`(${numPattern})\\s*%`, 'g'), `\\($1\\%\\)`);
      res = res.replace(new RegExp(`(${numPattern})\\s*Â°`, 'g'), `\\($1^{\\circ}\\)`);
      
      // Angles: Ø²Ø§ÙˆÙŠØ©(Ø£) or angle(A)
      res = res.replace(/(?:angle|Ø²Ø§ÙˆÙŠØ©)\s*\(\s*(.*?)\s*\)/g, (m, c) => `\\(\\angle ${clean(c)}\\)`);

      // Greater/Less than or equal: 3 ge x or 3 le x
      res = res.replace(new RegExp(`(${termPattern})\\s+ge\\\\?\\s+(${termPattern})`, 'g'), '\\($1 \\ge $2\\)');
      res = res.replace(new RegExp(`(${termPattern})\\s+le\\\\?\\s+(${termPattern})`, 'g'), '\\($1 \\le $2\\)');

      // Division symbol: div(5)
      res = res.replace(/div\s*\(\s*(.*?)\s*\)/g, (m, c) => `\\(\\div ${clean(c)}\\)`);

      // Handle chemistry \ce{}
      res = res.replace(/ÙƒÙŠÙ…ÙŠØ§Ø¡\((.*?)\)/g, `\\(\\ce{$1}\\)`);

      // --- Stage 3: Restore protected parts ---
      res = res.replace(/__PLACEHOLDER_(\d+)__/g, (match, index) => {
          return placeholders[parseInt(index)];
      });

      if(outputDiv) {
        outputDiv.innerHTML = res;
        if (window.MathJax && window.MathJax.typesetPromise) {
          MathJax.typesetPromise([outputDiv]).catch(e => console.error('MathJax Typeset Error:', e));
        }
      }
    }



    // --- New Image Upload Logic ---

    const gradeIslands = [
        { id: 'grade3', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' },
        { id: 'grade6', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' },
        { id: 'grade9', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·' }
    ];

    function initUploadPanel() {
      const gradeSelect = document.getElementById('gradeSelect');
      if (!gradeSelect) return;
      
      gradeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';

      gradeIslands.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        gradeSelect.appendChild(opt);
      });
    }

    function onGradeChange() {
      const grade = document.getElementById('gradeSelect').value;
      const subjectSelect = document.getElementById('subjectSelect');
      const skillSelect = document.getElementById('skillSelect');

      subjectSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
      skillSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù„Ø¹Ø©</option>';
      skillSelect.disabled = true;

      if (!grade) {
        subjectSelect.disabled = true;
        return;
      }

      subjectSelect.disabled = false;
      const subjects = islands.semester3.cities;

      subjects.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        subjectSelect.appendChild(opt);
      });
    }

    async function onSubjectChange() {
      const grade = document.getElementById('gradeSelect').value;
      const subject = document.getElementById('subjectSelect').value;
      const normalizedSubject = subject.replace('_test', '');
      const skillSelect = document.getElementById('skillSelect');

      skillSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù„Ø¹Ø©</option>';
      skillSelect.disabled = true;

      if (!subject || !grade) return;
      
      const { data: castles } = await supabaseSdk.getCastles(grade, normalizedSubject);

      if (castles && castles.length > 0) {
        skillSelect.disabled = false;
        castles.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.title;
          skillSelect.appendChild(opt);
        });
      }
    }

    function editQuestion(backendId) {
      const question = questions.find(q => q.__backendId === backendId);
      if (!question) return;

      editingQuestionId = backendId;

      // Populate form
      document.getElementById('gradeSelect').value = question.grade;
      onGradeChange(); // To populate subjects

      // Need to wait for async population
      setTimeout(() => {
        document.getElementById('subjectSelect').value = question.city_id;
        onSubjectChange(); // To populate skills

        setTimeout(() => {
            document.getElementById('skillSelect').value = question.skill_id;
        }, 200); // Another delay for skills
      }, 200);

      const isImage = question.question_text.startsWith('data:image') || question.question_text.includes('supabase.co');
      
      if (isImage) {
        document.querySelector('input[name="qType"][value="image"]').checked = true;
        toggleQType('image');
        // We can't pre-fill the file input, but we can show a preview
        const imageContainer = document.getElementById('imageInputContainer');
        let preview = document.getElementById('editImagePreview');
        if (!preview) {
            preview = document.createElement('img');
            preview.id = 'editImagePreview';
            preview.className = 'w-32 h-auto rounded-md my-2 border border-gray-500';
            imageContainer.prepend(preview);
        }
        preview.src = question.question_text;
      } else {
        document.querySelector('input[name="qType"][value="text"]').checked = true;
        toggleQType('text');
        document.getElementById('questionTextSingle').value = question.question_text;
      }

      document.getElementById('newAnswerA').value = question.answer_a;
      document.getElementById('newAnswerB').value = question.answer_b;
      document.getElementById('newAnswerC').value = question.answer_c;
      document.getElementById('newAnswerD').value = question.answer_d;
      document.getElementById('newCorrectAnswer').value = question.correct_answer;

      // Change button
      const btn = document.getElementById('uploadQuestionBtn');
      btn.textContent = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„';

      // Add cancel button
      let cancelBtn = document.getElementById('cancelEditQuestionBtn');
      if (!cancelBtn) {
          cancelBtn = document.createElement('button');
          cancelBtn.id = 'cancelEditQuestionBtn';
          cancelBtn.type = 'button';
          cancelBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
          cancelBtn.className = 'w-full py-3 rounded-lg font-bold hover:opacity-90 transition-all mt-2';
          cancelBtn.style.backgroundColor = '#ef4444';
          cancelBtn.style.color = '#ffffff';
          cancelBtn.onclick = cancelEditQuestion;
          btn.after(cancelBtn);
      }

      document.getElementById('singleFormContainer').scrollIntoView({ behavior: 'smooth' });
    }

    async function uploadQuestionImage() {
      const grade = document.getElementById('gradeSelect').value;
      const subject = document.getElementById('subjectSelect').value;
      const skill = document.getElementById('skillSelect').value;
      
      const fileInput = document.getElementById('questionImage');
      const file = fileInput ? fileInput.files[0] : null;
      const textInput = document.getElementById('questionTextSingle');
      const questionText = textInput ? textInput.value.trim() : '';
      
      // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶
      const isImageMode = document.getElementById('imageInputContainer').style.display !== 'none';

      const answerA = document.getElementById('newAnswerA').value;
      const answerB = document.getElementById('newAnswerB').value;
      const answerC = document.getElementById('newAnswerC').value;
      const answerD = document.getElementById('newAnswerD').value;
      const correctAnswer = document.getElementById('newCorrectAnswer').value;

      if (!grade || !subject || !skill || !answerA || !answerB || !answerC || !answerD || !correctAnswer) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
      }
      
      if (isImageMode && !file && !editingQuestionId) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„', 'error');
        return;
      }
      
      if (!isImageMode && !questionText) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
        return;
      }
      
      const btn = document.getElementById('uploadQuestionBtn');
      btn.disabled = true;
      
      let finalQuestionContent = questionText;

      if (editingQuestionId && isImageMode && !file) {
          const existingQuestion = questions.find(q => q.__backendId === editingQuestionId);
          if (existingQuestion && (existingQuestion.question_text.startsWith('data:image') || existingQuestion.question_text.includes('supabase.co'))) {
              finalQuestionContent = existingQuestion.question_text;
          } else {
              showToast('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ø³Ø¤Ø§Ù„.', 'error');
              btn.disabled = false;
              btn.textContent = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„';
              return;
          }
      } else if (isImageMode && file) {
          btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
          const ext = file.name.split('.').pop().toLowerCase();
          const fileName = `q_${Date.now()}.${ext}`;
          const path = `nafs/${grade}/${subject}/${skill}/${fileName}`;

          const { error: uploadError } = await supabaseSdk.client.storage
            .from('questions-images')
            .upload(path, file, {
              cacheControl: '3600',
              upsert: false
            });

          if (uploadError) {
            console.error('Upload Error:', uploadError);
            showToast('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + uploadError.message, 'error');
            btn.disabled = false;
            btn.textContent = editingQuestionId ? 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„' : 'âœ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„';
            return;
          }

          const { data } = supabaseSdk.client.storage.from('questions-images').getPublicUrl(path);
          finalQuestionContent = data.publicUrl;
      }
      
      btn.textContent = editingQuestionId ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„...' : 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„...';

      await saveQuestion(finalQuestionContent, { grade, subject, skill, answerA, answerB, answerC, answerD, correctAnswer });
      
      btn.disabled = false;
      btn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„';
    }

    async function saveQuestion(imageUrl, details) {
      const { grade, subject, skill, answerA, answerB, answerC, answerD, correctAnswer } = details;

      if (editingQuestionId) {
        const questionToUpdate = questions.find(q => q.__backendId === editingQuestionId);
        if (!questionToUpdate) {
            showToast('Ø®Ø·Ø£: Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
            cancelEditQuestion();
            return;
        }

        const updates = {
            question_text: imageUrl,
            grade: grade,
            city_id: subject,
            skill_id: skill,
            answer_a: answerA,
            answer_b: answerB,
            answer_c: answerC,
            answer_d: answerD,
            correct_answer: correctAnswer,
        };

        Object.assign(questionToUpdate, updates);
        await window.dataSdk.update(questionToUpdate);

        const { error } = await supabaseSdk.client.from('questions').update(updates).eq('question_id', questionToUpdate.question_id);

        if (error) {
            showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
        } else {
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
        }

        cancelEditQuestion();
        renderCurrentScreen();
        return;
      }

      const newQuestion = {
        question_id: generateUUID(),
        user_id: currentUser.user_id,
        question_text: imageUrl,
        question_type: 'multiple_choice',
        skill_id: skill,
        city_id: subject,
        difficulty_level: 'medium',
        answer_a: answerA,
        answer_b: answerB,
        answer_c: answerC,
        answer_d: answerD,
        correct_answer: correctAnswer,
        points_value: 10,
        grade: grade,
        semester: 'semester3',
        subject: subject.replace('_test', ''),
        created_by: currentUser.username,
        created_at: new Date().toISOString()
      };

      const { error } = await supabaseSdk.client.from('questions').insert(newQuestion);

      if (error) {
        showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„: ' + error.message, 'error');
        return;
      }
      
      questions.unshift(newQuestion);
      window.dataSdk.saveToStorage();
      
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
      renderCurrentScreen();
    }

    function cancelEditQuestion() {
      editingQuestionId = null;
      
      // Reset form
      document.getElementById('gradeSelect').value = '';
      onGradeChange(); // This will reset subject and skill
      document.getElementById('questionImage').value = '';
      document.getElementById('questionTextSingle').value = '';
      document.getElementById('newAnswerA').value = '';
      document.getElementById('newAnswerB').value = '';
      document.getElementById('newAnswerC').value = '';
      document.getElementById('newAnswerD').value = '';
      document.getElementById('newCorrectAnswer').value = '';
      
      const preview = document.getElementById('editImagePreview');
      if (preview) preview.remove();

      const btn = document.getElementById('uploadQuestionBtn');
      btn.textContent = 'âœ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„';

      const cancelBtn = document.getElementById('cancelEditQuestionBtn');
      if (cancelBtn) cancelBtn.remove();
    }

    function toggleQType(type) {
        const imageContainer = document.getElementById('imageInputContainer');
        const textContainer = document.getElementById('textInputContainer');
        if (imageContainer && textContainer) {
            imageContainer.style.display = type === 'image' ? 'block' : 'none';
            textContainer.style.display = type === 'text' ? 'block' : 'none';
        }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    document.addEventListener('DOMContentLoaded', async () => {
      await init();
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø²Ø± Ø£Ùˆ Ø¹Ù†ØµØ± ØªÙØ§Ø¹Ù„ÙŠ
      document.addEventListener('click', (e) => {
        if (e.target.closest('button') || e.target.closest('[onclick]') || e.target.closest('a')) {
          playClickSound();
        }
      });
    });
  </script>
</body>
</html>
